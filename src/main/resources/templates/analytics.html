<!doctype html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Analytics</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.2.1"></script>
</head>

<body class="bg-slate-100 text-slate-900">
  <div class="min-h-screen flex flex-col">
    <header class="bg-white/80 backdrop-blur border-b border-slate-200 sticky top-0 z-40">
      <div class="w-full px-6 lg:px-10 py-5">
        <div class="grid grid-cols-[auto_1fr_auto] items-center gap-4">
          <div class="flex items-center gap-3">
            <div class="h-10 w-10 rounded-xl bg-slate-900 text-white grid place-items-center shadow-sm">
              <svg viewBox="0 0 24 24" class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 3v18h18"/>
                <path d="M7 14l3-3 4 4 5-6"/>
              </svg>
            </div>
            <div>
              <div class="text-xl sm:text-2xl font-bold leading-tight">Analytics</div>
              <div class="text-sm text-slate-500">Sales performance overview</div>
            </div>
          </div>

                    <nav th:replace="~{fragments/navigation :: mainNav}"></nav>

          <div class="flex items-center justify-end gap-2">
            <a sec:authorize="isAnonymous()" href="/login"
               class="rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm hover:bg-slate-50 transition">
              Login
            </a>
            <form sec:authorize="isAuthenticated()" action="/logout" method="post" class="m-0">
              <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
              <button class="rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm hover:bg-slate-50 transition">
                Logout
              </button>
            </form>
          </div>
        </div>
      </div>
    </header>

    <main class="flex-1 w-full px-6 lg:px-10 py-10">
      <section class="rounded-2xl bg-white border border-slate-200 p-6 shadow-sm">
        <div class="text-base font-semibold">Analytics Dashboard</div>
        <div class="text-sm text-slate-500">Track trends, payments, and revenue share.</div>
      </section>

      <section class="mt-6 grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
        <div class="rounded-2xl bg-white border border-slate-200 p-4 shadow-sm">
          <div class="text-xs uppercase tracking-wide text-slate-500">Net Revenue</div>
          <div class="mt-2 text-2xl font-semibold" th:text="${'$' + #numbers.formatDecimal(netRevenueTotal, 1, 2)}">$0.00</div>
          <div class="text-xs text-slate-500 mt-1">
            <span th:text="${saleCount}">0</span> sale(s)
          </div>
        </div>
        <div class="rounded-2xl bg-white border border-slate-200 p-4 shadow-sm">
          <div class="text-xs uppercase tracking-wide text-slate-500">Avg Order Value</div>
          <div class="mt-2 text-2xl font-semibold" th:text="${'$' + #numbers.formatDecimal(avgOrderValue, 1, 2)}">$0.00</div>
          <div class="text-xs text-slate-500 mt-1">Basket size metric</div>
        </div>
        <div class="rounded-2xl bg-white border border-slate-200 p-4 shadow-sm">
          <div class="text-xs uppercase tracking-wide text-slate-500">Avg Items / Sale</div>
          <div class="mt-2 text-2xl font-semibold" th:text="${#numbers.formatDecimal(avgItemsPerSale, 1, 1)}">0</div>
          <div class="text-xs text-slate-500 mt-1">Basket size</div>
        </div>
        <div class="rounded-2xl bg-white border border-slate-200 p-4 shadow-sm">
          <div class="text-xs uppercase tracking-wide text-slate-500">Tax Total</div>
          <div class="mt-2 text-2xl font-semibold" th:text="${'$' + #numbers.formatDecimal(taxTotal, 1, 2)}">$0.00</div>
          <div class="text-xs text-slate-500 mt-1">VAT/GST reporting</div>
        </div>
        <div class="rounded-2xl bg-white border border-slate-200 p-4 shadow-sm">
          <div class="text-xs uppercase tracking-wide text-slate-500">Discount Rate</div>
          <div class="mt-2 text-2xl font-semibold" th:text="${#numbers.formatDecimal(discountRatePercent, 1, 1)} + '%'">0%</div>
          <div class="text-xs text-slate-500 mt-1">
            Total discounts <span th:text="${'$' + #numbers.formatDecimal(discountTotal, 1, 2)}">$0.00</span>
          </div>
        </div>
        <div class="rounded-2xl bg-white border border-slate-200 p-4 shadow-sm">
          <div class="text-xs uppercase tracking-wide text-slate-500">Refund Rate</div>
          <div class="mt-2 text-2xl font-semibold"
               th:text="${saleCount > 0 ? (#numbers.formatDecimal(refundCount * 100.0 / saleCount, 1, 1) + '%') : '0%'}">0%</div>
          <div class="text-xs text-slate-500 mt-1">
            Refunds <span th:text="${'$' + #numbers.formatDecimal(refundTotal, 1, 2)}">$0.00</span>
          </div>
        </div>
        <div class="rounded-2xl bg-white border border-slate-200 p-4 shadow-sm">
          <div class="text-xs uppercase tracking-wide text-slate-500">Split Payments</div>
          <div class="mt-2 text-2xl font-semibold" th:text="${#numbers.formatDecimal(splitPaymentRatePercent, 1, 1)} + '%'">0%</div>
          <div class="text-xs text-slate-500 mt-1">Mixed payment usage</div>
        </div>
        <div class="rounded-2xl bg-white border border-slate-200 p-4 shadow-sm">
          <div class="text-xs uppercase tracking-wide text-slate-500">Sales by Store/Terminal</div>
          <div class="mt-2 text-sm text-slate-600">Not configured</div>
          <div class="text-xs text-slate-500 mt-1">Add store or terminal IDs to enable</div>
        </div>
      </section>

      <section class="mt-6 grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
        <div class="rounded-2xl bg-white border border-slate-200 p-4 shadow-sm">
          <div class="text-xs uppercase tracking-wide text-slate-500">Peak Day</div>
          <div class="mt-2 text-lg font-semibold" id="insightPeakDay">No data</div>
          <div class="text-xs text-slate-500 mt-1" id="insightPeakDayValue">—</div>
        </div>
        <div class="rounded-2xl bg-white border border-slate-200 p-4 shadow-sm">
          <div class="text-xs uppercase tracking-wide text-slate-500">Peak Hour</div>
          <div class="mt-2 text-lg font-semibold" id="insightPeakHour">No data</div>
          <div class="text-xs text-slate-500 mt-1" id="insightPeakHourValue">—</div>
        </div>
        <div class="rounded-2xl bg-white border border-slate-200 p-4 shadow-sm">
          <div class="text-xs uppercase tracking-wide text-slate-500">Top Cashier</div>
          <div class="mt-2 text-lg font-semibold" id="insightTopCashier">No data</div>
          <div class="text-xs text-slate-500 mt-1" id="insightTopCashierValue">—</div>
        </div>
        <div class="rounded-2xl bg-white border border-slate-200 p-4 shadow-sm">
          <div class="text-xs uppercase tracking-wide text-slate-500">Quick Actions</div>
          <div class="mt-3 flex flex-wrap gap-2 text-xs font-semibold">
            <a href="/reports" class="rounded-lg border border-slate-200 px-3 py-1.5 text-slate-700 hover:bg-slate-50">Reports</a>
            <a href="/reports/sales.xlsx" class="rounded-lg border border-slate-200 px-3 py-1.5 text-slate-700 hover:bg-slate-50">Export Sales</a>
            <a href="/pos" class="rounded-lg border border-slate-200 px-3 py-1.5 text-slate-700 hover:bg-slate-50">Open POS</a>
            <a sec:authorize="hasRole('ADMIN')" href="/currencies"
               class="rounded-lg border border-slate-200 px-3 py-1.5 text-slate-700 hover:bg-slate-50">Currencies</a>
          </div>
        </div>
      </section>

      <section class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="rounded-2xl bg-white border border-slate-200 p-6 shadow-sm">
          <div class="flex items-start justify-between gap-4">
            <div>
              <div class="text-base font-semibold">Sales Trend</div>
              <div class="text-sm text-slate-500">Daily vs monthly sales</div>
            </div>
            <div class="flex items-center gap-1 rounded-lg bg-slate-100 p-1 text-xs">
              <button id="salesModeDaily" class="rounded-md px-2.5 py-1.5 bg-white shadow-sm">Daily</button>
              <button id="salesModeMonthly" class="rounded-md px-2.5 py-1.5 text-slate-600">Monthly</button>
            </div>
          </div>
          <div class="mt-4 rounded-xl border border-slate-200 bg-slate-50 px-4 py-3">
            <canvas id="salesLineChart" height="160"></canvas>
          </div>
        </div>

        <div class="rounded-2xl bg-white border border-slate-200 p-6 shadow-sm">
          <div>
            <div class="text-base font-semibold">Payment Methods</div>
            <div class="text-sm text-slate-500">Cash / Card / QR (last 7 days)</div>
          </div>
          <div class="mt-4 rounded-xl border border-slate-200 bg-slate-50 px-4 py-3">
            <canvas id="paymentStackChart" height="160"></canvas>
          </div>
        </div>

        <div class="rounded-2xl bg-white border border-slate-200 p-6 shadow-sm">
          <div class="flex items-start justify-between gap-4">
            <div>
              <div class="text-base font-semibold">Top Performers</div>
              <div class="text-sm text-slate-500">Products or categories by revenue</div>
            </div>
            <div class="flex items-center gap-1 rounded-lg bg-slate-100 p-1 text-xs">
              <button id="topModeProducts" class="rounded-md px-2.5 py-1.5 bg-white shadow-sm">Products</button>
              <button id="topModeCategories" class="rounded-md px-2.5 py-1.5 text-slate-600">Categories</button>
            </div>
          </div>
          <div class="mt-4 rounded-xl border border-slate-200 bg-slate-50 px-4 py-3">
            <canvas id="topBarChart" height="160"></canvas>
          </div>
        </div>

        <div class="rounded-2xl bg-white border border-slate-200 p-6 shadow-sm">
          <div>
            <div class="text-base font-semibold">Revenue Share</div>
            <div class="text-sm text-slate-500">Category mix</div>
          </div>
          <div class="mt-4 rounded-xl border border-slate-200 bg-slate-50 px-4 py-3">
            <canvas id="revenueDonutChart" height="160"></canvas>
          </div>
        </div>
      </section>

      <section class="mt-8 grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="rounded-2xl bg-white border border-slate-200 p-6 shadow-sm">
          <div>
            <div class="text-base font-semibold">Payment Mix</div>
            <div class="text-sm text-slate-500">Total share (last 7 days)</div>
          </div>
          <div class="mt-4 rounded-xl border border-slate-200 bg-slate-50 px-4 py-3">
            <canvas id="paymentMixChart" height="160"></canvas>
          </div>
        </div>

        <div class="rounded-2xl bg-white border border-slate-200 p-6 shadow-sm">
          <div>
            <div class="text-base font-semibold">Currency Mix</div>
            <div class="text-sm text-slate-500">Share by currency (base amount)</div>
          </div>
          <div class="mt-4 rounded-xl border border-slate-200 bg-slate-50 px-4 py-3">
            <canvas id="currencyMixChart" height="160"></canvas>
          </div>
        </div>

        <div class="rounded-2xl bg-white border border-slate-200 p-6 shadow-sm">
          <div>
            <div class="text-base font-semibold">Top Customers</div>
            <div class="text-sm text-slate-500">Lifetime spend (top 5)</div>
          </div>
          <div class="mt-4 rounded-xl border border-slate-200 bg-slate-50 px-4 py-3">
            <canvas id="topCustomerChart" height="160"></canvas>
          </div>
        </div>
      </section>

      <section class="mt-8 grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="rounded-2xl bg-white border border-slate-200 p-6 shadow-sm">
          <div>
            <div class="text-base font-semibold">Sales by Cashier</div>
            <div class="text-sm text-slate-500">Top performers by revenue</div>
          </div>
          <div class="mt-4 rounded-xl border border-slate-200 bg-slate-50 px-4 py-3">
            <canvas id="cashierBarChart" height="160"></canvas>
          </div>
        </div>
        <div class="rounded-2xl bg-white border border-slate-200 p-6 shadow-sm">
          <div>
            <div class="text-base font-semibold">Sales by Day</div>
            <div class="text-sm text-slate-500">Revenue by weekday</div>
          </div>
          <div class="mt-4 rounded-xl border border-slate-200 bg-slate-50 px-4 py-3">
            <canvas id="dayOfWeekChart" height="160"></canvas>
          </div>
        </div>
        <div class="rounded-2xl bg-white border border-slate-200 p-6 shadow-sm">
          <div>
            <div class="text-base font-semibold">Sales by Hour</div>
            <div class="text-sm text-slate-500">Revenue by hour</div>
          </div>
          <div class="mt-4 rounded-xl border border-slate-200 bg-slate-50 px-4 py-3">
            <canvas id="hourlySalesChart" height="160"></canvas>
          </div>
        </div>
      </section>

      <section class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="rounded-2xl bg-white border border-slate-200 p-6 shadow-sm">
          <div>
            <div class="text-base font-semibold">Revenue Decomposition</div>
            <div class="text-sm text-slate-500">Gross revenue, leakage, and net contribution</div>
          </div>
          <div class="mt-4 rounded-xl border border-slate-200 bg-slate-50 px-4 py-3">
            <canvas id="revenueBridgeChart" height="160"></canvas>
          </div>
        </div>

        <div class="rounded-2xl bg-white border border-slate-200 p-6 shadow-sm">
          <div>
            <div class="text-base font-semibold">Customer Mix</div>
            <div class="text-sm text-slate-500">New vs returning customer share</div>
          </div>
          <div class="mt-4 rounded-xl border border-slate-200 bg-slate-50 px-4 py-3">
            <canvas id="customerMixChart" height="160"></canvas>
          </div>
        </div>

        <div class="rounded-2xl bg-white border border-slate-200 p-6 shadow-sm">
          <div>
            <div class="text-base font-semibold">Promo Margin Profile</div>
            <div class="text-sm text-slate-500">Discounted vs non-discounted margin and profit</div>
          </div>
          <div class="mt-4 rounded-xl border border-slate-200 bg-slate-50 px-4 py-3">
            <canvas id="marginCompareChart" height="160"></canvas>
          </div>
          <div class="mt-3 text-xs text-slate-500">
            Margin gap:
            <span class="font-semibold text-slate-700"
                  th:text="${#numbers.formatDecimal(nonDiscountMarginPercent - discountMarginPercent, 1, 1)} + '%'">0%</span>
          </div>
        </div>

        <div class="rounded-2xl bg-white border border-slate-200 p-6 shadow-sm">
          <div>
            <div class="text-base font-semibold">Shift Cash Variance</div>
            <div class="text-sm text-slate-500">Variance by cashier (closed shifts)</div>
          </div>
          <div class="mt-4 rounded-xl border border-slate-200 bg-slate-50 px-4 py-3">
            <canvas id="shiftVarianceChart" height="160"></canvas>
          </div>
        </div>
      </section>

      <section class="mt-8">
        <div class="rounded-2xl bg-white border border-slate-200 p-6 shadow-sm">
          <div>
            <div class="text-base font-semibold">Cashier Efficiency Matrix</div>
            <div class="text-sm text-slate-500">Transactions vs average order value (bubble size = items/min)</div>
          </div>
          <div class="mt-4 rounded-xl border border-slate-200 bg-slate-50 px-4 py-3">
            <canvas id="cashierEfficiencyChart" class="w-full !h-48" height="140"></canvas>
          </div>
        </div>
      </section>

      <section class="mt-8 grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="rounded-2xl bg-white border border-slate-200 p-6 shadow-sm">
          <div>
            <div class="text-base font-semibold">Cumulative Revenue</div>
            <div class="text-sm text-slate-500">Running total in the last 7 days</div>
          </div>
          <div class="mt-4 rounded-xl border border-slate-200 bg-slate-50 px-4 py-3">
            <canvas id="cumulativeRevenueChart" class="w-full !h-44" height="160"></canvas>
          </div>
        </div>

        <div class="rounded-2xl bg-white border border-slate-200 p-6 shadow-sm">
          <div>
            <div class="text-base font-semibold">Sales Health Mix</div>
            <div class="text-sm text-slate-500">Completed vs refunded vs voided</div>
          </div>
          <div class="mt-4 rounded-xl border border-slate-200 bg-slate-50 px-4 py-3">
            <canvas id="salesHealthChart" class="w-full !h-44" height="160"></canvas>
          </div>
        </div>

        <div class="rounded-2xl bg-white border border-slate-200 p-6 shadow-sm">
          <div>
            <div class="text-base font-semibold">Leakage Value Mix</div>
            <div class="text-sm text-slate-500">Discounts, refunds, and voids</div>
          </div>
          <div class="mt-4 rounded-xl border border-slate-200 bg-slate-50 px-4 py-3">
            <canvas id="leakageBreakdownChart" class="w-full !h-44" height="160"></canvas>
          </div>
        </div>
      </section>

      <section class="mt-8">
        <div class="rounded-2xl bg-white border border-slate-200 p-6 shadow-sm">
          <div class="flex items-start justify-between gap-4">
            <div>
              <div class="text-base font-semibold">Comparison Charts</div>
              <div class="text-sm text-slate-500">Multiple visual styles for side-by-side analysis</div>
            </div>
          </div>
          <div class="mt-4 grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="rounded-xl border border-slate-200 bg-slate-50 px-4 py-3">
              <div class="text-sm font-semibold text-slate-700">Bar Chart (Vertical)</div>
              <canvas id="verticalBarChart" class="w-full !h-44" height="160"></canvas>
            </div>
            <div class="rounded-xl border border-slate-200 bg-slate-50 px-4 py-3">
              <div class="text-sm font-semibold text-slate-700">Horizontal Bar Chart</div>
              <canvas id="horizontalBarChart" class="w-full !h-44" height="160"></canvas>
            </div>
            <div class="rounded-xl border border-slate-200 bg-slate-50 px-4 py-3">
              <div class="text-sm font-semibold text-slate-700">Grouped Bar Chart</div>
              <canvas id="groupedBarChart" class="w-full !h-44" height="160"></canvas>
            </div>
            <div class="rounded-xl border border-slate-200 bg-slate-50 px-4 py-3">
              <div class="text-sm font-semibold text-slate-700">Stacked Bar Chart</div>
              <canvas id="stackedBarChart" class="w-full !h-44" height="160"></canvas>
            </div>
            <div class="rounded-xl border border-slate-200 bg-slate-50 px-4 py-3">
              <div class="text-sm font-semibold text-slate-700">100% Stacked Bar Chart</div>
              <canvas id="stacked100BarChart" class="w-full !h-44" height="160"></canvas>
            </div>
            <div class="rounded-xl border border-slate-200 bg-slate-50 px-4 py-3">
              <div class="text-sm font-semibold text-slate-700">Lollipop Chart</div>
              <canvas id="lollipopChart" class="w-full !h-44" height="160"></canvas>
            </div>
            <div class="rounded-xl border border-slate-200 bg-slate-50 px-4 py-3">
              <div class="text-sm font-semibold text-slate-700">Dot Plot</div>
              <canvas id="dotPlotChart" class="w-full !h-44" height="160"></canvas>
            </div>
            <div class="rounded-xl border border-slate-200 bg-slate-50 px-4 py-3">
              <div class="text-sm font-semibold text-slate-700">Radar Chart</div>
              <canvas id="radarComparisonChart" class="w-full !h-44" height="160"></canvas>
            </div>
            <div class="rounded-xl border border-slate-200 bg-slate-50 px-4 py-3">
              <div class="text-sm font-semibold text-slate-700">Polar Chart</div>
              <canvas id="polarComparisonChart" class="w-full !h-44" height="160"></canvas>
            </div>
          </div>
        </div>
      </section>

      <section class="mt-8">
        <div class="rounded-2xl bg-white border border-slate-200 p-6 shadow-sm">
          <div class="flex items-start justify-between gap-4">
            <div>
              <div class="text-base font-semibold">Time Series & Trend Charts</div>
              <div class="text-sm text-slate-500">Line, area, timeline, and financial-style trend views</div>
            </div>
          </div>
          <div class="mt-4 grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="rounded-xl border border-slate-200 bg-slate-50 px-4 py-3">
              <div class="text-sm font-semibold text-slate-700">Line Chart</div>
              <canvas id="trendLineChart" class="w-full !h-44" height="160"></canvas>
            </div>
            <div class="rounded-xl border border-slate-200 bg-slate-50 px-4 py-3">
              <div class="text-sm font-semibold text-slate-700">Multi-Line Chart</div>
              <canvas id="trendMultiLineChart" class="w-full !h-44" height="160"></canvas>
            </div>
            <div class="rounded-xl border border-slate-200 bg-slate-50 px-4 py-3">
              <div class="text-sm font-semibold text-slate-700">Step Line Chart</div>
              <canvas id="trendStepLineChart" class="w-full !h-44" height="160"></canvas>
            </div>
            <div class="rounded-xl border border-slate-200 bg-slate-50 px-4 py-3">
              <div class="text-sm font-semibold text-slate-700">Area Chart</div>
              <canvas id="trendAreaChart" class="w-full !h-44" height="160"></canvas>
            </div>
            <div class="rounded-xl border border-slate-200 bg-slate-50 px-4 py-3">
              <div class="text-sm font-semibold text-slate-700">Stacked Area Chart</div>
              <canvas id="trendStackedAreaChart" class="w-full !h-44" height="160"></canvas>
            </div>
            <div class="rounded-xl border border-slate-200 bg-slate-50 px-4 py-3">
              <div class="text-sm font-semibold text-slate-700">Streamgraph</div>
              <canvas id="trendStreamgraphChart" class="w-full !h-44" height="160"></canvas>
            </div>
            <div class="rounded-xl border border-slate-200 bg-slate-50 px-4 py-3">
              <div class="text-sm font-semibold text-slate-700">Timeline Chart</div>
              <canvas id="trendTimelineChart" class="w-full !h-44" height="160"></canvas>
            </div>
            <div class="rounded-xl border border-slate-200 bg-slate-50 px-4 py-3">
              <div class="text-sm font-semibold text-slate-700">Candlestick Chart</div>
              <canvas id="trendCandlestickChart" class="w-full !h-44" height="160"></canvas>
            </div>
            <div class="rounded-xl border border-slate-200 bg-slate-50 px-4 py-3">
              <div class="text-sm font-semibold text-slate-700">OHLC Chart</div>
              <canvas id="trendOhlcChart" class="w-full !h-44" height="160"></canvas>
            </div>
          </div>
        </div>
      </section>

      <section class="mt-8">
        <div class="rounded-2xl bg-white border border-slate-200 p-6 shadow-sm">
          <div>
            <div class="text-base font-semibold">Advanced Chart Gallery</div>
            <div class="text-sm text-slate-500">Expanded analytics visuals grouped by chart family with lazy rendering</div>
          </div>
          <div id="advancedChartGallery" class="mt-4 space-y-3"></div>
        </div>
      </section>

      <section class="mt-6">
        <div class="rounded-2xl bg-white border border-slate-200 p-6 shadow-sm">
          <div class="text-base font-semibold">Cashier Performance</div>
          <div class="text-sm text-slate-500">Sales volume, basket size, and speed</div>
          <div class="mt-4 overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="bg-slate-50 text-left text-slate-600">
                <tr>
                  <th class="px-4 py-3 font-semibold">Cashier</th>
                  <th class="px-4 py-3 font-semibold">Revenue</th>
                  <th class="px-4 py-3 font-semibold">Transactions</th>
                  <th class="px-4 py-3 font-semibold">Avg Order</th>
                  <th class="px-4 py-3 font-semibold">Items / Minute</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-slate-100">
                <tr th:if="${#lists.isEmpty(cashierPerformance)}">
                  <td colspan="5" class="px-4 py-4 text-slate-500">No cashier data yet.</td>
                </tr>
                <tr th:each="c : ${cashierPerformance}">
                  <td class="px-4 py-3 font-semibold text-slate-900" th:text="${c.cashier}">cashier</td>
                  <td class="px-4 py-3" th:text="${'$' + #numbers.formatDecimal(c.revenue, 1, 2)}">$0.00</td>
                  <td class="px-4 py-3" th:text="${c.transactions}">0</td>
                  <td class="px-4 py-3" th:text="${'$' + #numbers.formatDecimal(c.avgOrderValue, 1, 2)}">$0.00</td>
                  <td class="px-4 py-3" th:text="${#numbers.formatDecimal(c.itemsPerMinute, 1, 2)}">0</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Low stock + profit + quantity -->
      <section class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="rounded-2xl bg-white border border-slate-200 p-6 shadow-sm">
          <div>
            <div class="text-base font-semibold">Low Stock Trend</div>
            <div class="text-sm text-slate-500">Estimated daily count (assumes no restocks)</div>
          </div>
          <div class="mt-4 rounded-xl border border-slate-200 bg-slate-50 px-4 py-3">
            <canvas id="lowStockTrendChart" height="160"></canvas>
          </div>
        </div>

        <div class="rounded-2xl bg-white border border-slate-200 p-6 shadow-sm">
          <div>
            <div class="text-base font-semibold">Low Stock by Category</div>
            <div class="text-sm text-slate-500">Current low-stock items</div>
          </div>
          <div class="mt-4 rounded-xl border border-slate-200 bg-slate-50 px-4 py-3">
            <canvas id="lowStockCategoryChart" height="160"></canvas>
          </div>
        </div>

        <div class="rounded-2xl bg-white border border-slate-200 p-6 shadow-sm">
          <div class="flex items-start justify-between gap-4">
            <div>
              <div class="text-base font-semibold">Gross Profit</div>
              <div class="text-sm text-slate-500">Revenue vs cost (last 7 days)</div>
            </div>
            <div class="text-xs text-slate-500">
              Margin <span th:text="${#numbers.formatDecimal(grossMarginPercent, 1, 1)}">0</span>%
            </div>
          </div>
          <div class="mt-4 rounded-xl border border-slate-200 bg-slate-50 px-4 py-3">
            <canvas id="grossProfitChart" height="160"></canvas>
          </div>
          <div class="mt-4 grid grid-cols-3 gap-3 text-sm">
            <div class="rounded-xl border border-slate-200 bg-white px-3 py-2">
              <div class="text-xs text-slate-500">Revenue</div>
              <div class="font-semibold" th:text="${'$' + #numbers.formatDecimal(grossRevenueTotal, 1, 2)}">$0.00</div>
            </div>
            <div class="rounded-xl border border-slate-200 bg-white px-3 py-2">
              <div class="text-xs text-slate-500">Profit</div>
              <div class="font-semibold" th:text="${'$' + #numbers.formatDecimal(grossProfitTotal, 1, 2)}">$0.00</div>
            </div>
            <div class="rounded-xl border border-slate-200 bg-white px-3 py-2">
              <div class="text-xs text-slate-500">Voids</div>
              <div class="font-semibold">
                <span th:text="${voidCount}">0</span>
                <span class="text-xs text-slate-500 ml-1" th:text="${'$' + #numbers.formatDecimal(voidTotal, 1, 2)}">$0.00</span>
              </div>
              <div class="text-[11px] text-slate-400 mt-1">Refunds not tracked</div>
            </div>
          </div>
        </div>

        <div class="rounded-2xl bg-white border border-slate-200 p-6 shadow-sm">
          <div>
            <div class="text-base font-semibold">Top Products by Quantity</div>
            <div class="text-sm text-slate-500">Units sold (all time)</div>
          </div>
          <div class="mt-4 rounded-xl border border-slate-200 bg-slate-50 px-4 py-3">
            <canvas id="topQtyChart" height="160"></canvas>
          </div>
        </div>
      </section>

      <section class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="rounded-2xl bg-white border border-slate-200 p-6 shadow-sm">
          <div class="text-base font-semibold">SKU Performance</div>
          <div class="text-sm text-slate-500">Revenue, units, and margin</div>
          <div class="mt-4 overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="bg-slate-50 text-left text-slate-600">
                <tr>
                  <th class="px-4 py-3 font-semibold">SKU</th>
                  <th class="px-4 py-3 font-semibold">Revenue</th>
                  <th class="px-4 py-3 font-semibold">Units</th>
                  <th class="px-4 py-3 font-semibold">Margin</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-slate-100">
                <tr th:if="${#lists.isEmpty(skuPerformance)}">
                  <td colspan="4" class="px-4 py-4 text-slate-500">No SKU data yet.</td>
                </tr>
                <tr th:each="p : ${skuPerformance}">
                  <td class="px-4 py-3 font-semibold text-slate-900" th:text="${p.name}">SKU</td>
                  <td class="px-4 py-3" th:text="${'$' + #numbers.formatDecimal(p.revenue, 1, 2)}">$0.00</td>
                  <td class="px-4 py-3" th:text="${p.qty}">0</td>
                  <td class="px-4 py-3" th:text="${#numbers.formatDecimal(p.marginPercent, 1, 1)} + '%'">0%</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="rounded-2xl bg-white border border-slate-200 p-6 shadow-sm">
          <div class="text-base font-semibold">Category Performance</div>
          <div class="text-sm text-slate-500">Revenue and gross margin</div>
          <div class="mt-4 overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="bg-slate-50 text-left text-slate-600">
                <tr>
                  <th class="px-4 py-3 font-semibold">Category</th>
                  <th class="px-4 py-3 font-semibold">Revenue</th>
                  <th class="px-4 py-3 font-semibold">Margin</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-slate-100">
                <tr th:if="${#lists.isEmpty(categoryPerformance)}">
                  <td colspan="3" class="px-4 py-4 text-slate-500">No category data yet.</td>
                </tr>
                <tr th:each="c : ${categoryPerformance}">
                  <td class="px-4 py-3 font-semibold text-slate-900" th:text="${c.name}">Category</td>
                  <td class="px-4 py-3" th:text="${'$' + #numbers.formatDecimal(c.revenue, 1, 2)}">$0.00</td>
                  <td class="px-4 py-3" th:text="${#numbers.formatDecimal(c.marginPercent, 1, 1)} + '%'">0%</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="mt-3 text-xs text-slate-500">Supplier margin not tracked.</div>
        </div>
      </section>

      <section class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="rounded-2xl bg-white border border-slate-200 p-6 shadow-sm">
          <div class="text-base font-semibold">Discount Impact</div>
          <div class="text-sm text-slate-500">Promo vs non-promo margin</div>
          <div class="mt-4 grid grid-cols-2 gap-3 text-sm">
            <div class="rounded-xl border border-slate-200 bg-white px-3 py-2">
              <div class="text-xs text-slate-500">Discounted Revenue</div>
              <div class="font-semibold" th:text="${'$' + #numbers.formatDecimal(discountRevenue, 1, 2)}">$0.00</div>
              <div class="text-xs text-slate-500 mt-1">
                Margin <span th:text="${#numbers.formatDecimal(discountMarginPercent, 1, 1)}">0</span>%
              </div>
            </div>
            <div class="rounded-xl border border-slate-200 bg-white px-3 py-2">
              <div class="text-xs text-slate-500">Non-Discount Revenue</div>
              <div class="font-semibold" th:text="${'$' + #numbers.formatDecimal(nonDiscountRevenue, 1, 2)}">$0.00</div>
              <div class="text-xs text-slate-500 mt-1">
                Margin <span th:text="${#numbers.formatDecimal(nonDiscountMarginPercent, 1, 1)}">0</span>%
              </div>
            </div>
          </div>
        </div>

        <div class="rounded-2xl bg-white border border-slate-200 p-6 shadow-sm">
          <div class="text-base font-semibold">Leakage Signals</div>
          <div class="text-sm text-slate-500">Discounts, voids, refunds</div>
          <div class="mt-4 grid grid-cols-3 gap-3 text-sm">
            <div class="rounded-xl border border-slate-200 bg-white px-3 py-2">
              <div class="text-xs text-slate-500">Discounts</div>
              <div class="font-semibold" th:text="${'$' + #numbers.formatDecimal(discountTotal, 1, 2)}">$0.00</div>
            </div>
            <div class="rounded-xl border border-slate-200 bg-white px-3 py-2">
              <div class="text-xs text-slate-500">Voids</div>
              <div class="font-semibold" th:text="${voidCount}">0</div>
            </div>
            <div class="rounded-xl border border-slate-200 bg-white px-3 py-2">
              <div class="text-xs text-slate-500">Refunds</div>
              <div class="font-semibold" th:text="${refundCount}">0</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Inventory turnover -->
      <section class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="rounded-2xl bg-white border border-slate-200 p-6 shadow-sm">
          <div>
            <div class="text-base font-semibold">Fast Movers (30 days)</div>
            <div class="text-sm text-slate-500">Highest units sold</div>
          </div>
          <div class="mt-4 space-y-3">
            <div th:each="m : ${fastMovers}"
                 class="flex items-center justify-between rounded-xl border border-slate-200 bg-white px-3 py-2">
              <div class="min-w-0">
                <div class="text-sm font-semibold text-slate-900 truncate" th:text="${m.name}">Product</div>
                <div class="text-xs text-slate-500">
                  Sold <span th:text="${m.qtySold}">0</span>
                  · Stock <span th:text="${m.stockQty != null ? m.stockQty : '-'}">-</span>
                </div>
              </div>
              <div class="text-xs text-slate-500">
                Days of stock:
                <span th:text="${m.daysOfStock != null ? #numbers.formatDecimal(m.daysOfStock, 1, 1) : 'N/A'}">0</span>
              </div>
            </div>
            <div th:if="${#lists.isEmpty(fastMovers)}" class="text-sm text-slate-500">No sales yet.</div>
          </div>
        </div>

        <div class="rounded-2xl bg-white border border-slate-200 p-6 shadow-sm">
          <div>
            <div class="text-base font-semibold">Slow Movers (30 days)</div>
            <div class="text-sm text-slate-500">Lowest units sold</div>
          </div>
          <div class="mt-4 space-y-3">
            <div th:each="m : ${slowMovers}"
                 class="flex items-center justify-between rounded-xl border border-slate-200 bg-white px-3 py-2">
              <div class="min-w-0">
                <div class="text-sm font-semibold text-slate-900 truncate" th:text="${m.name}">Product</div>
                <div class="text-xs text-slate-500">
                  Sold <span th:text="${m.qtySold}">0</span>
                  · Stock <span th:text="${m.stockQty != null ? m.stockQty : '-'}">-</span>
                </div>
              </div>
              <div class="text-xs text-slate-500">
                Days of stock:
                <span th:text="${m.daysOfStock != null ? #numbers.formatDecimal(m.daysOfStock, 1, 1) : 'N/A'}">0</span>
              </div>
            </div>
            <div th:if="${#lists.isEmpty(slowMovers)}" class="text-sm text-slate-500">No sales yet.</div>
          </div>
        </div>
      </section>

      <section class="mt-8">
        <div class="rounded-2xl bg-white border border-slate-200 p-6 shadow-sm">
          <div class="flex items-start justify-between gap-4">
            <div>
              <div class="text-base font-semibold">Inventory & Replenishment</div>
              <div class="text-sm text-slate-500">Stock health and reorder guidance</div>
            </div>
          </div>
          <div class="mt-4 grid grid-cols-1 md:grid-cols-4 gap-3 text-sm">
            <div class="rounded-xl border border-slate-200 bg-white px-3 py-2">
              <div class="text-xs text-slate-500">Low stock</div>
              <div class="font-semibold" th:text="${lowStockCount}">0</div>
            </div>
            <div class="rounded-xl border border-slate-200 bg-white px-3 py-2">
              <div class="text-xs text-slate-500">Out of stock</div>
              <div class="font-semibold" th:text="${outOfStockCount}">0</div>
            </div>
            <div class="rounded-xl border border-slate-200 bg-white px-3 py-2">
              <div class="text-xs text-slate-500">Dead stock cost</div>
              <div class="font-semibold" th:text="${'$' + #numbers.formatDecimal(deadStockCost, 1, 2)}">$0.00</div>
            </div>
            <div class="rounded-xl border border-slate-200 bg-white px-3 py-2">
              <div class="text-xs text-slate-500">Sell-through (30d)</div>
              <div class="font-semibold" th:text="${#numbers.formatDecimal(sellThroughPercent, 1, 1)} + '%'">0%</div>
            </div>
          </div>

          <div class="mt-4 overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="bg-slate-50 text-left text-slate-600">
                <tr>
                  <th class="px-4 py-3 font-semibold">Reorder</th>
                  <th class="px-4 py-3 font-semibold">Stock</th>
                  <th class="px-4 py-3 font-semibold">Avg Daily</th>
                  <th class="px-4 py-3 font-semibold">Days of Stock</th>
                  <th class="px-4 py-3 font-semibold">Low Stock</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-slate-100">
                <tr th:if="${#lists.isEmpty(reorderRecommendations)}">
                  <td colspan="5" class="px-4 py-4 text-slate-500">No reorder alerts.</td>
                </tr>
                <tr th:each="r : ${reorderRecommendations}">
                  <td class="px-4 py-3 font-semibold text-slate-900" th:text="${r.name}">Product</td>
                  <td class="px-4 py-3" th:text="${r.stockQty}">0</td>
                  <td class="px-4 py-3" th:text="${#numbers.formatDecimal(r.avgDaily, 1, 2)}">0</td>
                  <td class="px-4 py-3" th:text="${#numbers.formatDecimal(r.daysOfStock, 1, 1)}">0</td>
                  <td class="px-4 py-3" th:text="${r.lowStock ? 'Yes' : 'No'}">No</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="mt-2 text-xs text-slate-500">Reorder list uses 30-day demand; lead time and stock variance are not tracked.</div>
        </div>
      </section>

      <section class="mt-8">
        <div class="rounded-2xl bg-white border border-slate-200 p-6 shadow-sm">
          <div class="text-base font-semibold">Customer & Loyalty</div>
          <div class="text-sm text-slate-500">New vs returning, RFM, and CLV</div>
          <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
            <div class="rounded-xl border border-slate-200 bg-white px-3 py-2">
              <div class="text-xs text-slate-500">New customers</div>
              <div class="font-semibold" th:text="${newCustomerCount}">0</div>
            </div>
            <div class="rounded-xl border border-slate-200 bg-white px-3 py-2">
              <div class="text-xs text-slate-500">Returning customers</div>
              <div class="font-semibold" th:text="${returningCustomerCount}">0</div>
            </div>
          </div>

          <div class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div>
              <div class="text-sm font-semibold text-slate-700">Top RFM</div>
              <div class="mt-2 overflow-x-auto">
                <table class="w-full text-sm">
                  <thead class="bg-slate-50 text-left text-slate-600">
                    <tr>
                      <th class="px-4 py-3 font-semibold">Customer</th>
                      <th class="px-4 py-3 font-semibold">Recency (days)</th>
                      <th class="px-4 py-3 font-semibold">Frequency</th>
                      <th class="px-4 py-3 font-semibold">Monetary</th>
                      <th class="px-4 py-3 font-semibold">Score</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-slate-100">
                    <tr th:if="${#lists.isEmpty(topCustomerRfm)}">
                      <td colspan="5" class="px-4 py-4 text-slate-500">No customer data yet.</td>
                    </tr>
                    <tr th:each="c : ${topCustomerRfm}">
                      <td class="px-4 py-3 font-semibold text-slate-900" th:text="${c.name}">Customer</td>
                      <td class="px-4 py-3" th:text="${c.recencyDays}">0</td>
                      <td class="px-4 py-3" th:text="${c.frequency}">0</td>
                      <td class="px-4 py-3" th:text="${'$' + #numbers.formatDecimal(c.monetary, 1, 2)}">$0.00</td>
                      <td class="px-4 py-3" th:text="${c.score}">0</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div>
              <div class="text-sm font-semibold text-slate-700">Top CLV (Lifetime Spend)</div>
              <div class="mt-2 overflow-x-auto">
                <table class="w-full text-sm">
                  <thead class="bg-slate-50 text-left text-slate-600">
                    <tr>
                      <th class="px-4 py-3 font-semibold">Customer</th>
                      <th class="px-4 py-3 font-semibold">Monetary</th>
                      <th class="px-4 py-3 font-semibold">Frequency</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-slate-100">
                    <tr th:if="${#lists.isEmpty(topCustomerClv)}">
                      <td colspan="3" class="px-4 py-4 text-slate-500">No customer data yet.</td>
                    </tr>
                    <tr th:each="c : ${topCustomerClv}">
                      <td class="px-4 py-3 font-semibold text-slate-900" th:text="${c.name}">Customer</td>
                      <td class="px-4 py-3" th:text="${'$' + #numbers.formatDecimal(c.monetary, 1, 2)}">$0.00</td>
                      <td class="px-4 py-3" th:text="${c.frequency}">0</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          <div class="mt-2 text-xs text-slate-500">Cohorts and retention trends require customer IDs across periods.</div>
        </div>
      </section>

      <section class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="rounded-2xl bg-white border border-slate-200 p-6 shadow-sm">
          <div class="text-base font-semibold">Operations & Staff</div>
          <div class="text-sm text-slate-500">Shift performance and cash variance</div>
          <div class="mt-4 overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="bg-slate-50 text-left text-slate-600">
                <tr>
                  <th class="px-4 py-3 font-semibold">Cashier</th>
                  <th class="px-4 py-3 font-semibold">Hours</th>
                  <th class="px-4 py-3 font-semibold">Sales</th>
                  <th class="px-4 py-3 font-semibold">Sales / Hr</th>
                  <th class="px-4 py-3 font-semibold">Cash Var</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-slate-100">
                <tr th:if="${#lists.isEmpty(shiftPerformance)}">
                  <td colspan="5" class="px-4 py-4 text-slate-500">No closed shifts yet.</td>
                </tr>
                <tr th:each="s : ${shiftPerformance}">
                  <td class="px-4 py-3 font-semibold text-slate-900" th:text="${s.cashier}">cashier</td>
                  <td class="px-4 py-3" th:text="${#numbers.formatDecimal(s.hours, 1, 2)}">0</td>
                  <td class="px-4 py-3" th:text="${'$' + #numbers.formatDecimal(s.totalSales, 1, 2)}">$0.00</td>
                  <td class="px-4 py-3" th:text="${'$' + #numbers.formatDecimal(s.salesPerHour, 1, 2)}">$0.00</td>
                  <td class="px-4 py-3" th:text="${'$' + #numbers.formatDecimal(s.cashVariance, 1, 2)}">$0.00</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="mt-2 text-xs text-slate-500">
            Cash variance total <span th:text="${'$' + #numbers.formatDecimal(cashVarianceTotal, 1, 2)}">$0.00</span>,
            avg <span th:text="${'$' + #numbers.formatDecimal(cashVarianceAvg, 1, 2)}">$0.00</span>
          </div>
          <div class="mt-1 text-xs text-slate-500">Queue time proxies not tracked.</div>
        </div>

        <div class="rounded-2xl bg-white border border-slate-200 p-6 shadow-sm">
          <div class="text-base font-semibold">Exceptions & Fraud Signals</div>
          <div class="text-sm text-slate-500">Spot leakage and anomalies</div>
          <div class="mt-4 grid grid-cols-1 gap-3 text-sm">
            <div class="rounded-xl border border-slate-200 bg-white px-3 py-2" th:each="e : ${exceptionStats}">
              <div class="flex items-center justify-between">
                <div class="font-semibold text-slate-900" th:text="${e.label}">Label</div>
                <div class="text-slate-700" th:text="${e.value}">0</div>
              </div>
              <div class="text-xs text-slate-500 mt-1" th:text="${e.note}">Note</div>
            </div>
          </div>
          <div class="mt-4 grid grid-cols-1 gap-3 text-sm">
            <div class="rounded-xl border border-slate-200 bg-white px-3 py-2" th:each="f : ${fraudSignals}">
              <div class="flex items-center justify-between">
                <div class="font-semibold text-slate-900" th:text="${f.label}">Label</div>
                <div class="text-slate-700" th:text="${f.value}">0</div>
              </div>
              <div class="text-xs text-slate-500 mt-1" th:text="${f.note}">Note</div>
            </div>
          </div>
        </div>
      </section>

      <section class="mt-8">
        <div class="rounded-2xl bg-white border border-slate-200 p-6 shadow-sm">
          <div class="text-base font-semibold">Compliance & Audit</div>
          <div class="text-sm text-slate-500">Tax reporting, invoice integrity, and audit trails</div>
          <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-3 text-sm">
            <div class="rounded-xl border border-slate-200 bg-white px-3 py-2" th:each="c : ${complianceStats}">
              <div class="font-semibold text-slate-900" th:text="${c.label}">Label</div>
              <div class="text-slate-700 mt-1" th:text="${c.value}">0</div>
              <div class="text-xs text-slate-500 mt-1" th:text="${c.note}">Note</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Heatmap -->
      <section class="mt-8">
        <div class="rounded-2xl bg-white border border-slate-200 p-6 shadow-sm">
          <div class="flex items-start justify-between gap-4">
            <div>
              <div class="text-base font-semibold">Hourly Sales Heatmap</div>
              <div class="text-sm text-slate-500">Transactions by day and hour</div>
            </div>
            <div class="text-xs text-slate-500">Darker = busier</div>
          </div>

          <div class="mt-4 space-y-2">
            <div class="flex justify-between text-[10px] text-slate-400 pl-10 pr-1">
              <span>0</span><span>4</span><span>8</span><span>12</span><span>16</span><span>20</span><span>23</span>
            </div>
            <div class="space-y-2">
              <div th:each="row, rowStat : ${heatmapValues}" class="flex items-center gap-2">
                <div class="w-8 text-[10px] text-slate-500" th:text="${heatmapDays[rowStat.index]}">Mon</div>
                <div class="grid gap-1 flex-1" style="grid-template-columns: repeat(24, minmax(0, 1fr));">
                  <div th:each="cell, cellStat : ${row}"
                       th:with="ratio=${heatmapMax > 0 ? (cell * 1.0 / heatmapMax) : 0},
                                alpha=${0.1 + (0.7 * ratio)}"
                       th:style="'background-color: rgba(15, 23, 42, ' + ${alpha} + ');'"
                       th:attr="title=${heatmapDays[rowStat.index]} + ' ' + ${heatmapHours[cellStat.index]} + ':00 - ' + ${cell} + ' sales'"
                       class="h-4 rounded"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script th:inline="javascript">
    const dailyLabels = /*[[${dailyLabels}]]*/ [];
    const dailySales = /*[[${dailySales}]]*/ [];
    const monthlyLabels = /*[[${monthlyLabels}]]*/ [];
    const monthlySales = /*[[${monthlySales}]]*/ [];
    const topProductLabels = /*[[${topProductLabels}]]*/ [];
    const topProductValues = /*[[${topProductValues}]]*/ [];
    const topCategoryLabels = /*[[${topCategoryLabels}]]*/ [];
    const topCategoryValues = /*[[${topCategoryValues}]]*/ [];
    const paymentLabels = /*[[${paymentLabels}]]*/ [];
    const paymentCash = /*[[${paymentCash}]]*/ [];
    const paymentCard = /*[[${paymentCard}]]*/ [];
    const paymentQr = /*[[${paymentQr}]]*/ [];
    const revenueShareLabels = /*[[${revenueShareLabels}]]*/ [];
    const revenueShareValues = /*[[${revenueShareValues}]]*/ [];
    const topQtyLabels = /*[[${topQtyLabels}]]*/ [];
    const topQtyValues = /*[[${topQtyValues}]]*/ [];
    const grossProfitLabels = /*[[${grossProfitLabels}]]*/ [];
    const grossRevenueValues = /*[[${grossRevenueValues}]]*/ [];
    const grossCostValues = /*[[${grossCostValues}]]*/ [];
    const grossProfitValues = /*[[${grossProfitValues}]]*/ [];
    const lowStockTrendLabels = /*[[${lowStockTrendLabels}]]*/ [];
    const lowStockTrendCounts = /*[[${lowStockTrendCounts}]]*/ [];
    const lowStockCategoryLabels = /*[[${lowStockCategoryLabels}]]*/ [];
    const lowStockCategoryCounts = /*[[${lowStockCategoryCounts}]]*/ [];
    const cashierLabels = /*[[${cashierPerformance.![cashier]}]]*/ [];
    const cashierSales = /*[[${cashierPerformance.![revenue]}]]*/ [];
    const dayOfWeekLabels = /*[[${dayOfWeekLabels}]]*/ [];
    const dayOfWeekRevenue = /*[[${dayOfWeekRevenue}]]*/ [];
    const hourLabels = /*[[${hourLabels}]]*/ [];
    const hourRevenue = /*[[${hourRevenue}]]*/ [];
    const currencyShareLabels = /*[[${currencyShareLabels}]]*/ [];
    const currencyShareValues = /*[[${currencyShareValues}]]*/ [];
    const topCustomerLabels = /*[[${topCustomerClv.![name]}]]*/ [];
    const topCustomerValues = /*[[${topCustomerClv.![monetary]}]]*/ [];
    const grossRevenueTotal = /*[[${grossRevenueTotal}]]*/ 0;
    const netRevenueTotalValue = /*[[${netRevenueTotal}]]*/ 0;
    const discountTotalValue = /*[[${discountTotal}]]*/ 0;
    const refundTotalValue = /*[[${refundTotal}]]*/ 0;
    const voidTotalValue = /*[[${voidTotal}]]*/ 0;
    const saleCountValue = /*[[${saleCount}]]*/ 0;
    const refundCountValue = /*[[${refundCount}]]*/ 0;
    const voidCountValue = /*[[${voidCount}]]*/ 0;
    const grossMarginPercentValue = /*[[${grossMarginPercent}]]*/ 0;
    const discountRatePercentValue = /*[[${discountRatePercent}]]*/ 0;
    const splitPaymentRatePercentValue = /*[[${splitPaymentRatePercent}]]*/ 0;
    const sellThroughPercentValue = /*[[${sellThroughPercent}]]*/ 0;
    const newCustomerCountValue = /*[[${newCustomerCount}]]*/ 0;
    const returningCustomerCountValue = /*[[${returningCustomerCount}]]*/ 0;
    const discountRevenueValue = /*[[${discountRevenue}]]*/ 0;
    const discountProfitValue = /*[[${discountProfit}]]*/ 0;
    const nonDiscountRevenueValue = /*[[${nonDiscountRevenue}]]*/ 0;
    const nonDiscountProfitValue = /*[[${nonDiscountProfit}]]*/ 0;
    const discountMarginPercentValue = /*[[${discountMarginPercent}]]*/ 0;
    const nonDiscountMarginPercentValue = /*[[${nonDiscountMarginPercent}]]*/ 0;
    const shiftLabels = /*[[${shiftPerformance.![cashier]}]]*/ [];
    const shiftVarianceValues = /*[[${shiftPerformance.![cashVariance]}]]*/ [];
    const cashierTransactions = /*[[${cashierPerformance.![transactions]}]]*/ [];
    const cashierAvgOrder = /*[[${cashierPerformance.![avgOrderValue]}]]*/ [];
    const cashierItemsPerMinute = /*[[${cashierPerformance.![itemsPerMinute]}]]*/ [];

    function formatMoney(value) {
      if (typeof value !== "number") return value;
      return "$" + value.toFixed(2);
    }

    function toNumber(value) {
      if (typeof value === "number") return Number.isFinite(value) ? value : 0;
      const parsed = Number.parseFloat(value);
      return Number.isFinite(parsed) ? parsed : 0;
    }

    function sumValues(values) {
      if (!Array.isArray(values)) return 0;
      return values.reduce((acc, val) => acc + (typeof val === "number" ? val : 0), 0);
    }

    function topSlice(labels, values, limit) {
      const rows = [];
      for (let i = 0; i < Math.min(labels.length, values.length); i++) {
        rows.push({ label: labels[i], value: toNumber(values[i]) });
      }
      rows.sort((a, b) => b.value - a.value);
      const selected = rows.slice(0, limit);
      return {
        labels: selected.map((r) => r.label),
        values: selected.map((r) => r.value)
      };
    }

    function clamp(value, min, max) {
      return Math.min(max, Math.max(min, toNumber(value)));
    }

    function withChartSafety(name, renderFn) {
      try {
        renderFn();
      } catch (error) {
        console.error(`Failed to render ${name}`, error);
      }
    }

    function round2(value) {
      return Math.round(toNumber(value) * 100) / 100;
    }

    function hasChartController(type) {
      try {
        if (!Chart || !Chart.registry || typeof Chart.registry.getController !== "function") {
          return false;
        }
        return !!Chart.registry.getController(type);
      } catch (error) {
        return false;
      }
    }

    function buildCenteredStreamSeries(seriesList) {
      const safeSeries = seriesList.map((series) => Array.isArray(series) ? series.map((v) => toNumber(v)) : []);
      const length = Math.max(0, ...safeSeries.map((series) => series.length));
      const totals = Array.from({ length }, () => 0);
      for (const series of safeSeries) {
        for (let i = 0; i < length; i++) {
          totals[i] += toNumber(series[i] || 0);
        }
      }
      const baseline = totals.map((total) => -total / 2);
      const cumulative = baseline.slice();
      return safeSeries.map((series) => {
        const out = [];
        for (let i = 0; i < length; i++) {
          cumulative[i] += toNumber(series[i] || 0);
          out.push(round2(cumulative[i]));
        }
        return out;
      });
    }

    function buildFinancialRows(labels, closingSeries) {
      const closeSeries = (Array.isArray(closingSeries) ? closingSeries : []).map((v) => Math.max(0, toNumber(v)));
      const rows = [];
      for (let i = 0; i < closeSeries.length; i++) {
        const close = closeSeries[i];
        const prevClose = i > 0 ? closeSeries[i - 1] : close;
        const drift = (i % 2 === 0 ? 1 : -1) * Math.max(0.5, close * 0.03);
        const open = Math.max(0, prevClose + drift);
        const rangePad = Math.max(1, Math.max(open, close) * 0.08);
        const high = Math.max(open, close) + rangePad;
        const low = Math.max(0, Math.min(open, close) - rangePad * 0.75);
        rows.push({
          x: labels[i] || String(i + 1),
          o: round2(open),
          h: round2(high),
          l: round2(low),
          c: round2(close)
        });
      }
      return rows;
    }

    function maxIndex(values) {
      if (!Array.isArray(values) || values.length === 0) return -1;
      let max = values[0];
      let idx = 0;
      for (let i = 1; i < values.length; i++) {
        if (values[i] > max) {
          max = values[i];
          idx = i;
        }
      }
      return idx;
    }

    function setInsight(id, text) {
      const el = document.getElementById(id);
      if (el) el.textContent = text;
    }

    const peakDayIdx = maxIndex(dayOfWeekRevenue);
    if (peakDayIdx >= 0) {
      setInsight("insightPeakDay", dayOfWeekLabels[peakDayIdx] || "Unknown");
      setInsight("insightPeakDayValue", formatMoney(dayOfWeekRevenue[peakDayIdx] || 0));
    }
    const peakHourIdx = maxIndex(hourRevenue);
    if (peakHourIdx >= 0) {
      const hourLabel = hourLabels[peakHourIdx] != null ? hourLabels[peakHourIdx] : "--";
      setInsight("insightPeakHour", `${hourLabel}:00`);
      setInsight("insightPeakHourValue", formatMoney(hourRevenue[peakHourIdx] || 0));
    }
    const topCashierIdx = maxIndex(cashierSales);
    if (topCashierIdx >= 0) {
      setInsight("insightTopCashier", cashierLabels[topCashierIdx] || "Unknown");
      setInsight("insightTopCashierValue", formatMoney(cashierSales[topCashierIdx] || 0));
    }

    const lineCtx = document.getElementById("salesLineChart");
    const lineChart = lineCtx ? new Chart(lineCtx, {
      type: "line",
      data: {
        labels: dailyLabels,
        datasets: [{
          label: "Sales",
          data: dailySales,
          borderColor: "#0f172a",
          backgroundColor: "rgba(15, 23, 42, 0.1)",
          fill: true,
          tension: 0.35,
          pointRadius: 3,
          pointBackgroundColor: "#0f172a"
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            mode: "index",
            intersect: false,
            callbacks: { label: (ctx) => formatMoney(ctx.parsed.y) }
          }
        },
        scales: {
          x: { grid: { display: false } },
          y: { grid: { color: "rgba(148,163,184,0.35)" } }
        }
      }
    }) : null;

    function setSalesMode(mode) {
      if (!lineChart) return;
      if (mode === "monthly") {
        lineChart.data.labels = monthlyLabels;
        lineChart.data.datasets[0].data = monthlySales;
        document.getElementById("salesModeMonthly").classList.add("bg-white", "shadow-sm");
        document.getElementById("salesModeMonthly").classList.remove("text-slate-600");
        document.getElementById("salesModeDaily").classList.remove("bg-white", "shadow-sm");
        document.getElementById("salesModeDaily").classList.add("text-slate-600");
      } else {
        lineChart.data.labels = dailyLabels;
        lineChart.data.datasets[0].data = dailySales;
        document.getElementById("salesModeDaily").classList.add("bg-white", "shadow-sm");
        document.getElementById("salesModeDaily").classList.remove("text-slate-600");
        document.getElementById("salesModeMonthly").classList.remove("bg-white", "shadow-sm");
        document.getElementById("salesModeMonthly").classList.add("text-slate-600");
      }
      lineChart.update();
    }

    document.getElementById("salesModeDaily")?.addEventListener("click", () => setSalesMode("daily"));
    document.getElementById("salesModeMonthly")?.addEventListener("click", () => setSalesMode("monthly"));

    const paymentCtx = document.getElementById("paymentStackChart");
    if (paymentCtx) {
      new Chart(paymentCtx, {
        type: "bar",
        data: {
          labels: paymentLabels,
          datasets: [
            { label: "Cash", data: paymentCash, backgroundColor: "#0f172a" },
            { label: "Card", data: paymentCard, backgroundColor: "#334155" },
            { label: "QR", data: paymentQr, backgroundColor: "#94a3b8" }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            tooltip: { callbacks: { label: (ctx) => `${ctx.dataset.label}: ${formatMoney(ctx.parsed.y)}` } }
          },
          scales: {
            x: { stacked: true, grid: { display: false } },
            y: { stacked: true, grid: { color: "rgba(148,163,184,0.35)" } }
          }
        }
      });
    }

    const topCtx = document.getElementById("topBarChart");
    const topChart = topCtx ? new Chart(topCtx, {
      type: "bar",
      data: {
        labels: topProductLabels,
        datasets: [{
          label: "Revenue",
          data: topProductValues,
          backgroundColor: "#0f172a"
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: { callbacks: { label: (ctx) => formatMoney(ctx.parsed.y) } }
        },
        scales: {
          x: { grid: { display: false } },
          y: { grid: { color: "rgba(148,163,184,0.35)" } }
        }
      }
    }) : null;

    function setTopMode(mode) {
      if (!topChart) return;
      if (mode === "categories") {
        topChart.data.labels = topCategoryLabels;
        topChart.data.datasets[0].data = topCategoryValues;
        document.getElementById("topModeCategories").classList.add("bg-white", "shadow-sm");
        document.getElementById("topModeCategories").classList.remove("text-slate-600");
        document.getElementById("topModeProducts").classList.remove("bg-white", "shadow-sm");
        document.getElementById("topModeProducts").classList.add("text-slate-600");
      } else {
        topChart.data.labels = topProductLabels;
        topChart.data.datasets[0].data = topProductValues;
        document.getElementById("topModeProducts").classList.add("bg-white", "shadow-sm");
        document.getElementById("topModeProducts").classList.remove("text-slate-600");
        document.getElementById("topModeCategories").classList.remove("bg-white", "shadow-sm");
        document.getElementById("topModeCategories").classList.add("text-slate-600");
      }
      topChart.update();
    }

    document.getElementById("topModeProducts")?.addEventListener("click", () => setTopMode("products"));
    document.getElementById("topModeCategories")?.addEventListener("click", () => setTopMode("categories"));

    const donutCtx = document.getElementById("revenueDonutChart");
    if (donutCtx) {
      new Chart(donutCtx, {
        type: "doughnut",
        data: {
          labels: revenueShareLabels,
          datasets: [{
            data: revenueShareValues,
            backgroundColor: ["#0f172a", "#334155", "#64748b", "#94a3b8", "#cbd5f5", "#e2e8f0"]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: "bottom" },
            tooltip: { callbacks: { label: (ctx) => `${ctx.label}: ${formatMoney(ctx.parsed)}` } }
          }
        }
      });
    }

    const paymentMixCtx = document.getElementById("paymentMixChart");
    if (paymentMixCtx) {
      new Chart(paymentMixCtx, {
        type: "doughnut",
        data: {
          labels: ["Cash", "Card", "QR"],
          datasets: [{
            data: [sumValues(paymentCash), sumValues(paymentCard), sumValues(paymentQr)],
            backgroundColor: ["#0f172a", "#334155", "#94a3b8"]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: "bottom" },
            tooltip: { callbacks: { label: (ctx) => `${ctx.label}: ${formatMoney(ctx.parsed)}` } }
          }
        }
      });
    }

    const currencyMixCtx = document.getElementById("currencyMixChart");
    if (currencyMixCtx) {
      new Chart(currencyMixCtx, {
        type: "doughnut",
        data: {
          labels: currencyShareLabels,
          datasets: [{
            data: currencyShareValues,
            backgroundColor: ["#0f172a", "#334155", "#64748b", "#94a3b8", "#cbd5f5", "#e2e8f0"]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: "bottom" },
            tooltip: { callbacks: { label: (ctx) => `${ctx.label}: ${formatMoney(ctx.parsed)}` } }
          }
        }
      });
    }

    const topCustomerCtx = document.getElementById("topCustomerChart");
    if (topCustomerCtx) {
      new Chart(topCustomerCtx, {
        type: "bar",
        data: {
          labels: topCustomerLabels,
          datasets: [{
            label: "Spend",
            data: topCustomerValues,
            backgroundColor: "#0f172a"
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: (ctx) => formatMoney(ctx.parsed.y) } }
          },
          scales: {
            x: { grid: { display: false } },
            y: { grid: { color: "rgba(148,163,184,0.35)" } }
          }
        }
      });
    }

    const lowStockTrendCtx = document.getElementById("lowStockTrendChart");
    if (lowStockTrendCtx) {
      new Chart(lowStockTrendCtx, {
        type: "line",
        data: {
          labels: lowStockTrendLabels,
          datasets: [{
            label: "Low stock count",
            data: lowStockTrendCounts,
            borderColor: "#d97706",
            backgroundColor: "rgba(217, 119, 6, 0.15)",
            fill: true,
            tension: 0.35,
            pointRadius: 3,
            pointBackgroundColor: "#d97706"
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { grid: { display: false } },
            y: { grid: { color: "rgba(148,163,184,0.35)" }, ticks: { precision: 0 } }
          }
        }
      });
    }

    const lowStockCategoryCtx = document.getElementById("lowStockCategoryChart");
    if (lowStockCategoryCtx) {
      new Chart(lowStockCategoryCtx, {
        type: "bar",
        data: {
          labels: lowStockCategoryLabels,
          datasets: [{
            label: "Low stock",
            data: lowStockCategoryCounts,
            backgroundColor: "#f59e0b"
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { grid: { display: false } },
            y: { grid: { color: "rgba(148,163,184,0.35)" }, ticks: { precision: 0 } }
          }
        }
      });
    }

    const grossProfitCtx = document.getElementById("grossProfitChart");
    if (grossProfitCtx) {
      new Chart(grossProfitCtx, {
        type: "bar",
        data: {
          labels: grossProfitLabels,
          datasets: [
            { label: "Revenue", data: grossRevenueValues, backgroundColor: "#0f172a" },
            { label: "Cost", data: grossCostValues, backgroundColor: "#94a3b8" },
            { label: "Profit", data: grossProfitValues, type: "line", borderColor: "#22c55e", backgroundColor: "rgba(34, 197, 94, 0.15)", tension: 0.35, fill: false }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            tooltip: { callbacks: { label: (ctx) => `${ctx.dataset.label}: ${formatMoney(ctx.parsed.y)}` } }
          },
          scales: {
            x: { grid: { display: false } },
            y: { grid: { color: "rgba(148,163,184,0.35)" } }
          }
        }
      });
    }

    const topQtyCtx = document.getElementById("topQtyChart");
    if (topQtyCtx) {
      new Chart(topQtyCtx, {
        type: "bar",
        data: {
          labels: topQtyLabels,
          datasets: [{
            label: "Units",
            data: topQtyValues,
            backgroundColor: "#0f172a"
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: { grid: { display: false } },
            y: { grid: { color: "rgba(148,163,184,0.35)" }, ticks: { precision: 0 } }
          }
        }
      });
    }

    const cashierCtx = document.getElementById("cashierBarChart");
    if (cashierCtx) {
      new Chart(cashierCtx, {
        type: "bar",
        data: {
          labels: cashierLabels,
          datasets: [{
            label: "Revenue",
            data: cashierSales,
            backgroundColor: "#0f172a"
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { grid: { display: false } },
            y: { grid: { color: "rgba(148,163,184,0.35)" } }
          }
        }
      });
    }

    const dayCtx = document.getElementById("dayOfWeekChart");
    if (dayCtx) {
      new Chart(dayCtx, {
        type: "bar",
        data: {
          labels: dayOfWeekLabels,
          datasets: [{
            label: "Revenue",
            data: dayOfWeekRevenue,
            backgroundColor: "#334155"
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { grid: { display: false } },
            y: { grid: { color: "rgba(148,163,184,0.35)" } }
          }
        }
      });
    }

    const hourCtx = document.getElementById("hourlySalesChart");
    if (hourCtx) {
      new Chart(hourCtx, {
        type: "line",
        data: {
          labels: hourLabels,
          datasets: [{
            label: "Revenue",
            data: hourRevenue,
            borderColor: "#0f172a",
            backgroundColor: "rgba(15, 23, 42, 0.1)",
            fill: true,
            tension: 0.35,
            pointRadius: 2,
            pointBackgroundColor: "#0f172a"
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { grid: { display: false } },
            y: { grid: { color: "rgba(148,163,184,0.35)" } }
          }
        }
      });
    }

    const revenueBridgeCtx = document.getElementById("revenueBridgeChart");
    if (revenueBridgeCtx) {
      const bridgeLabels = ["Gross Revenue", "Discounts", "Refunds", "Net Revenue"];
      const bridgeValues = [
        toNumber(grossRevenueTotal),
        -toNumber(discountTotalValue),
        -toNumber(refundTotalValue),
        toNumber(netRevenueTotalValue)
      ];
      new Chart(revenueBridgeCtx, {
        type: "bar",
        data: {
          labels: bridgeLabels,
          datasets: [{
            label: "Amount",
            data: bridgeValues,
            backgroundColor: bridgeValues.map((value) => value >= 0 ? "#0f172a" : "#dc2626")
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: (ctx) => formatMoney(toNumber(ctx.parsed.y)) } }
          },
          scales: {
            x: { grid: { display: false } },
            y: {
              grid: { color: "rgba(148,163,184,0.35)" },
              ticks: { callback: (value) => formatMoney(toNumber(value)) }
            }
          }
        }
      });
    }

    const customerMixCtx = document.getElementById("customerMixChart");
    if (customerMixCtx) {
      new Chart(customerMixCtx, {
        type: "doughnut",
        data: {
          labels: ["New", "Returning"],
          datasets: [{
            data: [toNumber(newCustomerCountValue), toNumber(returningCustomerCountValue)],
            backgroundColor: ["#334155", "#0f172a"]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: "bottom" },
            tooltip: {
              callbacks: {
                label: (ctx) => `${ctx.label}: ${toNumber(ctx.parsed)}`
              }
            }
          }
        }
      });
    }

    const marginCompareCtx = document.getElementById("marginCompareChart");
    if (marginCompareCtx) {
      new Chart(marginCompareCtx, {
        data: {
          labels: ["Discounted", "Non-discounted"],
          datasets: [
            {
              type: "bar",
              label: "Revenue",
              data: [toNumber(discountRevenueValue), toNumber(nonDiscountRevenueValue)],
              backgroundColor: "#334155",
              yAxisID: "y"
            },
            {
              type: "bar",
              label: "Profit",
              data: [toNumber(discountProfitValue), toNumber(nonDiscountProfitValue)],
              backgroundColor: "#64748b",
              yAxisID: "y"
            },
            {
              type: "line",
              label: "Margin %",
              data: [toNumber(discountMarginPercentValue), toNumber(nonDiscountMarginPercentValue)],
              borderColor: "#16a34a",
              backgroundColor: "rgba(22, 163, 74, 0.15)",
              yAxisID: "y1",
              tension: 0.3,
              pointRadius: 3
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: "index", intersect: false },
          scales: {
            x: { grid: { display: false } },
            y: {
              position: "left",
              grid: { color: "rgba(148,163,184,0.35)" },
              ticks: { callback: (value) => formatMoney(toNumber(value)) }
            },
            y1: {
              position: "right",
              grid: { drawOnChartArea: false },
              ticks: { callback: (value) => `${toNumber(value).toFixed(1)}%` }
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: (ctx) => ctx.dataset.yAxisID === "y1"
                  ? `${ctx.dataset.label}: ${toNumber(ctx.parsed.y).toFixed(1)}%`
                  : `${ctx.dataset.label}: ${formatMoney(toNumber(ctx.parsed.y))}`
              }
            }
          }
        }
      });
    }

    const shiftVarianceCtx = document.getElementById("shiftVarianceChart");
    if (shiftVarianceCtx) {
      const varianceValues = shiftVarianceValues.map((v) => toNumber(v));
      new Chart(shiftVarianceCtx, {
        type: "bar",
        data: {
          labels: shiftLabels,
          datasets: [{
            label: "Cash Variance",
            data: varianceValues,
            backgroundColor: varianceValues.map((value) => value >= 0 ? "#059669" : "#dc2626")
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: (ctx) => formatMoney(toNumber(ctx.parsed.y)) } }
          },
          scales: {
            x: { grid: { display: false } },
            y: {
              grid: { color: "rgba(148,163,184,0.35)" },
              ticks: { callback: (value) => formatMoney(toNumber(value)) }
            }
          }
        }
      });
    }

    const cashierEfficiencyCtx = document.getElementById("cashierEfficiencyChart");
    if (cashierEfficiencyCtx) {
      const efficiencyPoints = cashierLabels.map((name, idx) => {
        const tx = toNumber(cashierTransactions[idx]);
        const avg = toNumber(cashierAvgOrder[idx]);
        const speed = toNumber(cashierItemsPerMinute[idx]);
        const revenue = toNumber(cashierSales[idx]);
        return {
          x: tx,
          y: avg,
          r: Math.max(5, Math.min(20, 6 + speed * 120)),
          cashier: name,
          speed: speed,
          revenue: revenue
        };
      });
      new Chart(cashierEfficiencyCtx, {
        type: "bubble",
        data: {
          datasets: [{
            label: "Cashier",
            data: efficiencyPoints,
            backgroundColor: "rgba(15, 23, 42, 0.65)",
            borderColor: "#0f172a"
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const point = ctx.raw || {};
                  return `${point.cashier || "Cashier"} · Tx ${toNumber(point.x)} · Avg ${formatMoney(toNumber(point.y))} · Items/min ${toNumber(point.speed).toFixed(2)} · Rev ${formatMoney(toNumber(point.revenue))}`;
                }
              }
            }
          },
          scales: {
            x: {
              title: { display: true, text: "Transactions" },
              grid: { color: "rgba(148,163,184,0.2)" },
              ticks: { precision: 0 }
            },
            y: {
              title: { display: true, text: "Average Order Value ($)" },
              grid: { color: "rgba(148,163,184,0.2)" },
              ticks: { callback: (value) => formatMoney(toNumber(value)) }
            }
          }
        }
      });
    }

    withChartSafety("cumulativeRevenueChart", () => {
      const cumulativeRevenueCtx = document.getElementById("cumulativeRevenueChart");
      if (cumulativeRevenueCtx) {
        const cumulativeValues = [];
        let running = 0;
        for (const value of dailySales) {
          running += toNumber(value);
          cumulativeValues.push(running);
        }
        new Chart(cumulativeRevenueCtx, {
          type: "line",
          data: {
            labels: dailyLabels,
            datasets: [{
              label: "Cumulative Revenue",
              data: cumulativeValues,
              borderColor: "#0f172a",
              backgroundColor: "rgba(15, 23, 42, 0.1)",
              fill: true,
              tension: 0.35,
              pointRadius: 3,
              pointBackgroundColor: "#0f172a"
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: { callbacks: { label: (ctx) => formatMoney(toNumber(ctx.parsed.y)) } }
            },
            scales: {
              x: { grid: { display: false } },
              y: {
                grid: { color: "rgba(148,163,184,0.35)" },
                ticks: { callback: (value) => formatMoney(toNumber(value)) }
              }
            }
          }
        });
      }
    });

    withChartSafety("salesHealthChart", () => {
      const salesHealthCtx = document.getElementById("salesHealthChart");
      if (salesHealthCtx) {
        const paidOrReturnSales = toNumber(saleCountValue);
        const refunded = toNumber(refundCountValue);
        const voided = toNumber(voidCountValue);
        const completed = Math.max(0, paidOrReturnSales - refunded);
        new Chart(salesHealthCtx, {
          type: "doughnut",
          data: {
            labels: ["Completed", "Refunded", "Voided"],
            datasets: [{
              data: [completed, refunded, voided],
              backgroundColor: ["#0f172a", "#334155", "#dc2626"]
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: "bottom" },
              tooltip: {
                callbacks: { label: (ctx) => `${ctx.label}: ${toNumber(ctx.parsed)}` }
              }
            }
          }
        });
      }
    });

    withChartSafety("leakageBreakdownChart", () => {
      const leakageBreakdownCtx = document.getElementById("leakageBreakdownChart");
      if (leakageBreakdownCtx) {
        new Chart(leakageBreakdownCtx, {
          type: "bar",
          data: {
            labels: ["Discounts", "Refunds", "Voids"],
            datasets: [{
              label: "Amount",
              data: [toNumber(discountTotalValue), toNumber(refundTotalValue), toNumber(voidTotalValue)],
              backgroundColor: ["#f59e0b", "#334155", "#dc2626"]
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: { callbacks: { label: (ctx) => formatMoney(toNumber(ctx.parsed.y)) } }
            },
            scales: {
              x: { grid: { display: false } },
              y: {
                grid: { color: "rgba(148,163,184,0.35)" },
                ticks: { callback: (value) => formatMoney(toNumber(value)) }
              }
            }
          }
        });
      }
    });

    const comparisonPalette = ["#0f172a", "#334155", "#64748b", "#94a3b8", "#cbd5e1", "#e2e8f0"];

    withChartSafety("verticalBarChart", () => {
      const verticalBarCtx = document.getElementById("verticalBarChart");
      if (verticalBarCtx) {
        const topProducts = topSlice(topProductLabels, topProductValues, 6);
        new Chart(verticalBarCtx, {
          type: "bar",
          data: {
            labels: topProducts.labels,
            datasets: [{
              label: "Revenue",
              data: topProducts.values,
              backgroundColor: "#0f172a"
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: { callbacks: { label: (ctx) => formatMoney(toNumber(ctx.parsed.y)) } }
            },
            scales: {
              x: { grid: { display: false } },
              y: {
                grid: { color: "rgba(148,163,184,0.35)" },
                ticks: { callback: (value) => formatMoney(toNumber(value)) }
              }
            }
          }
        });
      }
    });

    withChartSafety("horizontalBarChart", () => {
      const horizontalBarCtx = document.getElementById("horizontalBarChart");
      if (horizontalBarCtx) {
        const topCategories = topSlice(topCategoryLabels, topCategoryValues, 6);
        new Chart(horizontalBarCtx, {
          type: "bar",
          data: {
            labels: topCategories.labels,
            datasets: [{
              label: "Revenue",
              data: topCategories.values,
              backgroundColor: "#334155"
            }]
          },
          options: {
            indexAxis: "y",
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: { callbacks: { label: (ctx) => formatMoney(toNumber(ctx.parsed.x)) } }
            },
            scales: {
              y: { grid: { display: false } },
              x: {
                grid: { color: "rgba(148,163,184,0.35)" },
                ticks: { callback: (value) => formatMoney(toNumber(value)) }
              }
            }
          }
        });
      }
    });

    withChartSafety("groupedBarChart", () => {
      const groupedBarCtx = document.getElementById("groupedBarChart");
      if (groupedBarCtx) {
        new Chart(groupedBarCtx, {
          type: "bar",
          data: {
            labels: paymentLabels,
            datasets: [
              { label: "Cash", data: paymentCash, backgroundColor: "#0f172a" },
              { label: "Card", data: paymentCard, backgroundColor: "#334155" },
              { label: "QR", data: paymentQr, backgroundColor: "#94a3b8" }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: { stacked: false, grid: { display: false } },
              y: {
                stacked: false,
                grid: { color: "rgba(148,163,184,0.35)" },
                ticks: { callback: (value) => formatMoney(toNumber(value)) }
              }
            }
          }
        });
      }
    });

    withChartSafety("stackedBarChart", () => {
      const stackedBarCtx = document.getElementById("stackedBarChart");
      if (stackedBarCtx) {
        new Chart(stackedBarCtx, {
          type: "bar",
          data: {
            labels: paymentLabels,
            datasets: [
              { label: "Cash", data: paymentCash, backgroundColor: "#0f172a" },
              { label: "Card", data: paymentCard, backgroundColor: "#334155" },
              { label: "QR", data: paymentQr, backgroundColor: "#94a3b8" }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: { stacked: true, grid: { display: false } },
              y: {
                stacked: true,
                grid: { color: "rgba(148,163,184,0.35)" },
                ticks: { callback: (value) => formatMoney(toNumber(value)) }
              }
            }
          }
        });
      }
    });

    withChartSafety("stacked100BarChart", () => {
      const stacked100BarCtx = document.getElementById("stacked100BarChart");
      if (stacked100BarCtx) {
        const cashPct = [];
        const cardPct = [];
        const qrPct = [];
        for (let i = 0; i < paymentLabels.length; i++) {
          const cash = toNumber(paymentCash[i]);
          const card = toNumber(paymentCard[i]);
          const qr = toNumber(paymentQr[i]);
          const total = cash + card + qr;
          if (total <= 0) {
            cashPct.push(0);
            cardPct.push(0);
            qrPct.push(0);
            continue;
          }
          cashPct.push((cash * 100) / total);
          cardPct.push((card * 100) / total);
          qrPct.push((qr * 100) / total);
        }
        new Chart(stacked100BarCtx, {
          type: "bar",
          data: {
            labels: paymentLabels,
            datasets: [
              { label: "Cash", data: cashPct, backgroundColor: "#0f172a" },
              { label: "Card", data: cardPct, backgroundColor: "#334155" },
              { label: "QR", data: qrPct, backgroundColor: "#94a3b8" }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: { stacked: true, grid: { display: false } },
              y: {
                stacked: true,
                min: 0,
                max: 100,
                grid: { color: "rgba(148,163,184,0.35)" },
                ticks: { callback: (value) => `${toNumber(value).toFixed(0)}%` }
              }
            },
            plugins: {
              tooltip: {
                callbacks: {
                  label: (ctx) => `${ctx.dataset.label}: ${toNumber(ctx.parsed.y).toFixed(1)}%`
                }
              }
            }
          }
        });
      }
    });

    withChartSafety("lollipopChart", () => {
      const lollipopCtx = document.getElementById("lollipopChart");
      if (lollipopCtx) {
        const topCustomers = topSlice(topCustomerLabels, topCustomerValues, 6);
        new Chart(lollipopCtx, {
          data: {
            labels: topCustomers.labels,
            datasets: [
              {
                type: "bar",
                label: "Spend Stem",
                data: topCustomers.values,
                backgroundColor: "rgba(15, 23, 42, 0.35)",
                borderRadius: 999,
                barThickness: 4
              },
              {
                type: "line",
                label: "Spend",
                data: topCustomers.values,
                showLine: false,
                pointRadius: 5,
                pointHoverRadius: 6,
                pointBackgroundColor: "#0f172a",
                borderColor: "#0f172a"
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: (ctx) => formatMoney(toNumber(ctx.parsed.y))
                }
              }
            },
            scales: {
              x: { grid: { display: false } },
              y: {
                beginAtZero: true,
                grid: { color: "rgba(148,163,184,0.35)" },
                ticks: { callback: (value) => formatMoney(toNumber(value)) }
              }
            }
          }
        });
      }
    });

    withChartSafety("dotPlotChart", () => {
      const dotPlotCtx = document.getElementById("dotPlotChart");
      if (dotPlotCtx) {
        new Chart(dotPlotCtx, {
          type: "line",
          data: {
            labels: hourLabels,
            datasets: [{
              label: "Revenue",
              data: hourRevenue,
              showLine: false,
              pointRadius: 4,
              pointHoverRadius: 5,
              pointBackgroundColor: "#0f172a",
              pointBorderColor: "#0f172a"
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: (ctx) => formatMoney(toNumber(ctx.parsed.y))
                }
              }
            },
            scales: {
              x: { grid: { display: false } },
              y: {
                grid: { color: "rgba(148,163,184,0.35)" },
                ticks: { callback: (value) => formatMoney(toNumber(value)) }
              }
            }
          }
        });
      }
    });

    withChartSafety("radarComparisonChart", () => {
      const radarComparisonCtx = document.getElementById("radarComparisonChart");
      if (radarComparisonCtx) {
        const refundRatePercentValue = toNumber(saleCountValue) > 0
          ? (toNumber(refundCountValue) * 100.0) / toNumber(saleCountValue)
          : 0;
        const netRetentionPercent = toNumber(grossRevenueTotal) > 0
          ? (toNumber(netRevenueTotalValue) * 100.0) / toNumber(grossRevenueTotal)
          : 0;
        const leakagePercent = toNumber(grossRevenueTotal) > 0
          ? ((toNumber(discountTotalValue) + toNumber(refundTotalValue) + toNumber(voidTotalValue)) * 100.0) / toNumber(grossRevenueTotal)
          : 0;

        const radarCurrentValues = [
          clamp(netRetentionPercent, 0, 100),
          clamp(grossMarginPercentValue, 0, 100),
          clamp(sellThroughPercentValue, 0, 100),
          clamp(splitPaymentRatePercentValue, 0, 100),
          clamp(discountRatePercentValue, 0, 100),
          clamp(refundRatePercentValue, 0, 100),
          clamp(leakagePercent, 0, 100)
        ];

        new Chart(radarComparisonCtx, {
          type: "radar",
          data: {
            labels: ["Net Retention", "Gross Margin", "Sell-through", "Split Payments", "Discount Rate", "Refund Rate", "Leakage"],
            datasets: [
              {
                label: "Current %",
                data: radarCurrentValues,
                backgroundColor: "rgba(15, 23, 42, 0.18)",
                borderColor: "#0f172a",
                pointBackgroundColor: "#0f172a"
              },
              {
                label: "Reference %",
                data: [85, 40, 55, 30, 15, 5, 10],
                backgroundColor: "rgba(148, 163, 184, 0.22)",
                borderColor: "#64748b",
                pointBackgroundColor: "#64748b"
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              r: {
                min: 0,
                max: 100,
                ticks: { callback: (value) => `${toNumber(value).toFixed(0)}%` }
              }
            }
          }
        });
      }
    });

    withChartSafety("polarComparisonChart", () => {
      const polarComparisonCtx = document.getElementById("polarComparisonChart");
      if (polarComparisonCtx) {
        const revenueBuckets = topSlice(revenueShareLabels, revenueShareValues, 6);
        new Chart(polarComparisonCtx, {
          type: "polarArea",
          data: {
            labels: revenueBuckets.labels,
            datasets: [{
              data: revenueBuckets.values,
              backgroundColor: comparisonPalette.map((color, idx) => {
                if (idx === 0) return "rgba(15, 23, 42, 0.92)";
                if (idx === 1) return "rgba(51, 65, 85, 0.86)";
                if (idx === 2) return "rgba(100, 116, 139, 0.8)";
                if (idx === 3) return "rgba(148, 163, 184, 0.75)";
                if (idx === 4) return "rgba(203, 213, 225, 0.9)";
                return "rgba(226, 232, 240, 0.95)";
              })
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: "bottom" },
              tooltip: {
                callbacks: {
                  label: (ctx) => {
                    const parsed = ctx.parsed;
                    const value = typeof parsed === "object" ? parsed.r : parsed;
                    return `${ctx.label}: ${formatMoney(toNumber(value))}`;
                  }
                }
              }
            }
          }
        });
      }
    });

    const trendPalette = ["#0f172a", "#334155", "#64748b", "#94a3b8"];
    const dailyFinancialRows = buildFinancialRows(dailyLabels, dailySales);

    withChartSafety("trendLineChart", () => {
      const trendLineCtx = document.getElementById("trendLineChart");
      if (trendLineCtx) {
        new Chart(trendLineCtx, {
          type: "line",
          data: {
            labels: dailyLabels,
            datasets: [{
              label: "Sales",
              data: dailySales,
              borderColor: trendPalette[0],
              backgroundColor: "rgba(15, 23, 42, 0.12)",
              pointRadius: 3,
              tension: 0.35
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              x: { grid: { display: false } },
              y: { grid: { color: "rgba(148,163,184,0.35)" } }
            }
          }
        });
      }
    });

    withChartSafety("trendMultiLineChart", () => {
      const trendMultiLineCtx = document.getElementById("trendMultiLineChart");
      if (trendMultiLineCtx) {
        new Chart(trendMultiLineCtx, {
          type: "line",
          data: {
            labels: grossProfitLabels,
            datasets: [
              {
                label: "Revenue",
                data: grossRevenueValues,
                borderColor: trendPalette[0],
                pointRadius: 2,
                tension: 0.3
              },
              {
                label: "Cost",
                data: grossCostValues,
                borderColor: trendPalette[2],
                pointRadius: 2,
                tension: 0.3
              },
              {
                label: "Profit",
                data: grossProfitValues,
                borderColor: "#16a34a",
                pointRadius: 2,
                tension: 0.3
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: { grid: { display: false } },
              y: {
                grid: { color: "rgba(148,163,184,0.35)" },
                ticks: { callback: (value) => formatMoney(toNumber(value)) }
              }
            }
          }
        });
      }
    });

    withChartSafety("trendStepLineChart", () => {
      const trendStepLineCtx = document.getElementById("trendStepLineChart");
      if (trendStepLineCtx) {
        new Chart(trendStepLineCtx, {
          type: "line",
          data: {
            labels: dailyLabels,
            datasets: [{
              label: "Sales (Step)",
              data: dailySales,
              borderColor: trendPalette[1],
              backgroundColor: "rgba(51, 65, 85, 0.1)",
              stepped: true,
              pointRadius: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              x: { grid: { display: false } },
              y: {
                grid: { color: "rgba(148,163,184,0.35)" },
                ticks: { callback: (value) => formatMoney(toNumber(value)) }
              }
            }
          }
        });
      }
    });

    withChartSafety("trendAreaChart", () => {
      const trendAreaCtx = document.getElementById("trendAreaChart");
      if (trendAreaCtx) {
        new Chart(trendAreaCtx, {
          type: "line",
          data: {
            labels: dailyLabels,
            datasets: [{
              label: "Revenue Area",
              data: dailySales,
              borderColor: trendPalette[0],
              backgroundColor: "rgba(15, 23, 42, 0.22)",
              fill: true,
              tension: 0.35,
              pointRadius: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              x: { grid: { display: false } },
              y: {
                grid: { color: "rgba(148,163,184,0.35)" },
                ticks: { callback: (value) => formatMoney(toNumber(value)) }
              }
            }
          }
        });
      }
    });

    withChartSafety("trendStackedAreaChart", () => {
      const trendStackedAreaCtx = document.getElementById("trendStackedAreaChart");
      if (trendStackedAreaCtx) {
        new Chart(trendStackedAreaCtx, {
          type: "line",
          data: {
            labels: paymentLabels,
            datasets: [
              {
                label: "Cash",
                data: paymentCash,
                borderColor: trendPalette[0],
                backgroundColor: "rgba(15, 23, 42, 0.45)",
                fill: true,
                stack: "payments",
                tension: 0.3,
                pointRadius: 0
              },
              {
                label: "Card",
                data: paymentCard,
                borderColor: trendPalette[1],
                backgroundColor: "rgba(51, 65, 85, 0.42)",
                fill: true,
                stack: "payments",
                tension: 0.3,
                pointRadius: 0
              },
              {
                label: "QR",
                data: paymentQr,
                borderColor: trendPalette[2],
                backgroundColor: "rgba(100, 116, 139, 0.4)",
                fill: true,
                stack: "payments",
                tension: 0.3,
                pointRadius: 0
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: { grid: { display: false } },
              y: {
                stacked: true,
                grid: { color: "rgba(148,163,184,0.35)" },
                ticks: { callback: (value) => formatMoney(toNumber(value)) }
              }
            }
          }
        });
      }
    });

    withChartSafety("trendStreamgraphChart", () => {
      const trendStreamgraphCtx = document.getElementById("trendStreamgraphChart");
      if (trendStreamgraphCtx) {
        const centeredSeries = buildCenteredStreamSeries([paymentCash, paymentCard, paymentQr]);
        new Chart(trendStreamgraphCtx, {
          type: "line",
          data: {
            labels: paymentLabels,
            datasets: [
              {
                label: "Cash",
                data: centeredSeries[0] || [],
                borderColor: trendPalette[0],
                backgroundColor: "rgba(15, 23, 42, 0.4)",
                fill: true,
                tension: 0.35,
                pointRadius: 0
              },
              {
                label: "Card",
                data: centeredSeries[1] || [],
                borderColor: trendPalette[1],
                backgroundColor: "rgba(51, 65, 85, 0.35)",
                fill: "-1",
                tension: 0.35,
                pointRadius: 0
              },
              {
                label: "QR",
                data: centeredSeries[2] || [],
                borderColor: trendPalette[2],
                backgroundColor: "rgba(100, 116, 139, 0.3)",
                fill: "-1",
                tension: 0.35,
                pointRadius: 0
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: { grid: { display: false } },
              y: { grid: { color: "rgba(148,163,184,0.25)" } }
            }
          }
        });
      }
    });

    withChartSafety("trendTimelineChart", () => {
      const trendTimelineCtx = document.getElementById("trendTimelineChart");
      if (trendTimelineCtx) {
        const maxDaily = Math.max(1, ...dailySales.map((v) => toNumber(v)));
        const timelinePoints = dailySales.map((value, idx) => ({
          x: idx,
          y: 1,
          r: Math.max(4, Math.min(18, (toNumber(value) / maxDaily) * 18)),
          amount: toNumber(value)
        }));
        new Chart(trendTimelineCtx, {
          type: "bubble",
          data: {
            datasets: [{
              label: "Timeline",
              data: timelinePoints,
              backgroundColor: "rgba(15, 23, 42, 0.65)",
              borderColor: "#0f172a"
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: (ctx) => {
                    const point = ctx.raw || {};
                    const label = dailyLabels[point.x] || point.x;
                    return `${label}: ${formatMoney(toNumber(point.amount))}`;
                  }
                }
              }
            },
            scales: {
              x: {
                type: "linear",
                min: -0.5,
                max: Math.max(0, dailyLabels.length - 0.5),
                ticks: {
                  callback: (value) => {
                    const idx = Math.round(toNumber(value));
                    return dailyLabels[idx] || "";
                  }
                },
                grid: { display: false }
              },
              y: {
                min: 0,
                max: 2,
                display: false,
                grid: { display: false }
              }
            }
          }
        });
      }
    });

    withChartSafety("trendCandlestickChart", () => {
      const trendCandlestickCtx = document.getElementById("trendCandlestickChart");
      if (trendCandlestickCtx) {
        if (hasChartController("candlestick")) {
          new Chart(trendCandlestickCtx, {
            type: "candlestick",
            data: {
              datasets: [{
                label: "Daily OHLC",
                data: dailyFinancialRows
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                x: { type: "category", labels: dailyLabels, grid: { display: false } },
                y: { grid: { color: "rgba(148,163,184,0.35)" } }
              }
            }
          });
        } else {
          new Chart(trendCandlestickCtx, {
            type: "bar",
            data: {
              labels: dailyLabels,
              datasets: [{
                label: "Close",
                data: dailyFinancialRows.map((row) => row.c),
                backgroundColor: "#0f172a"
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: {
                x: { grid: { display: false } },
                y: { grid: { color: "rgba(148,163,184,0.35)" } }
              }
            }
          });
        }
      }
    });

    withChartSafety("trendOhlcChart", () => {
      const trendOhlcCtx = document.getElementById("trendOhlcChart");
      if (trendOhlcCtx) {
        if (hasChartController("ohlc")) {
          new Chart(trendOhlcCtx, {
            type: "ohlc",
            data: {
              datasets: [{
                label: "Daily OHLC",
                data: dailyFinancialRows
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                x: { type: "category", labels: dailyLabels, grid: { display: false } },
                y: { grid: { color: "rgba(148,163,184,0.35)" } }
              }
            }
          });
        } else {
          new Chart(trendOhlcCtx, {
            data: {
              labels: dailyLabels,
              datasets: [
                {
                  type: "line",
                  label: "High",
                  data: dailyFinancialRows.map((row) => row.h),
                  borderColor: "#0f172a",
                  pointRadius: 0,
                  tension: 0.2
                },
                {
                  type: "line",
                  label: "Low",
                  data: dailyFinancialRows.map((row) => row.l),
                  borderColor: "#94a3b8",
                  pointRadius: 0,
                  tension: 0.2
                },
                {
                  type: "line",
                  label: "Close",
                  data: dailyFinancialRows.map((row) => row.c),
                  borderColor: "#16a34a",
                  pointRadius: 0,
                  tension: 0.2
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                x: { grid: { display: false } },
                y: { grid: { color: "rgba(148,163,184,0.35)" } }
              }
            }
          });
        }
      }
    });

    function initAdvancedChartGallery() {
      const galleryRoot = document.getElementById("advancedChartGallery");
      if (!galleryRoot) return;
      if (typeof Plotly === "undefined") {
        galleryRoot.innerHTML = '<div class="rounded-xl border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-700">Plotly failed to load, so advanced charts are unavailable.</div>';
        return;
      }

      const plotlyConfig = { displayModeBar: false, responsive: true };
      const plotPalette = ["#0f172a", "#334155", "#64748b", "#94a3b8", "#cbd5e1", "#e2e8f0"];

      function plotLayout(extra) {
        return Object.assign({
          height: 176,
          autosize: true,
          margin: { l: 34, r: 12, t: 10, b: 28 },
          paper_bgcolor: "rgba(0,0,0,0)",
          plot_bgcolor: "rgba(0,0,0,0)",
          font: { color: "#334155", size: 10 },
          showlegend: false
        }, extra || {});
      }

      function safeLabels(labels, fallback) {
        if (Array.isArray(labels) && labels.length > 0) return labels;
        return fallback;
      }

      function safeSeries(values, length, fallback) {
        const source = Array.isArray(values) ? values.map((v) => toNumber(v)) : [];
        const out = [];
        for (let i = 0; i < length; i++) {
          if (i < source.length && Number.isFinite(source[i])) out.push(source[i]);
          else out.push(toNumber(fallback[i % fallback.length]));
        }
        return out;
      }

      function correlation(a, b) {
        if (!Array.isArray(a) || !Array.isArray(b) || a.length === 0 || b.length === 0) return 0;
        const len = Math.min(a.length, b.length);
        const x = a.slice(0, len).map((v) => toNumber(v));
        const y = b.slice(0, len).map((v) => toNumber(v));
        const meanX = x.reduce((acc, v) => acc + v, 0) / len;
        const meanY = y.reduce((acc, v) => acc + v, 0) / len;
        let num = 0;
        let denX = 0;
        let denY = 0;
        for (let i = 0; i < len; i++) {
          const dx = x[i] - meanX;
          const dy = y[i] - meanY;
          num += dx * dy;
          denX += dx * dx;
          denY += dy * dy;
        }
        if (denX === 0 || denY === 0) return 0;
        return num / Math.sqrt(denX * denY);
      }

      function slugify(value) {
        return String(value || "")
          .toLowerCase()
          .replace(/[^a-z0-9]+/g, "-")
          .replace(/^-+|-+$/g, "");
      }

      function placeholderPlot(target, note) {
        Plotly.newPlot(target, [{
          type: "scatter",
          mode: "text",
          x: [0.5],
          y: [0.5],
          text: [note || "Preview"],
          textfont: { size: 11, color: "#64748b" }
        }], plotLayout({
          xaxis: { visible: false, range: [0, 1] },
          yaxis: { visible: false, range: [0, 1] }
        }), plotlyConfig);
      }

      const fallbackTrendLabels = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
      const fallbackTrendValues = [120, 155, 132, 184, 168, 201, 176];
      const trendLabels = safeLabels(dailyLabels, fallbackTrendLabels);
      const trendValues = safeSeries(dailySales, trendLabels.length, fallbackTrendValues);

      const paymentTrendLabels = safeLabels(paymentLabels, trendLabels);
      const paymentCashSeries = safeSeries(paymentCash, paymentTrendLabels.length, trendValues.map((v) => v * 0.45));
      const paymentCardSeries = safeSeries(paymentCard, paymentTrendLabels.length, trendValues.map((v) => v * 0.35));
      const paymentQrSeries = safeSeries(paymentQr, paymentTrendLabels.length, trendValues.map((v) => v * 0.2));

      const revenueSeedLabels = (Array.isArray(revenueShareLabels) && revenueShareLabels.length > 0)
        ? revenueShareLabels
        : safeLabels(topCategoryLabels, ["Food", "Beverage", "Electronics", "Office", "Other"]);
      const revenueSeedValues = (Array.isArray(revenueShareValues) && revenueShareValues.length > 0)
        ? revenueShareValues
        : safeSeries(topCategoryValues, revenueSeedLabels.length, [420, 310, 280, 190, 110]);
      const revenueTop = topSlice(revenueSeedLabels, revenueSeedValues, 6);
      if (revenueTop.labels.length === 0) {
        revenueTop.labels = ["Food", "Beverage", "Electronics", "Office", "Other"];
        revenueTop.values = [420, 310, 280, 190, 110];
      }
      const revenueTotal = Math.max(1, sumValues(revenueTop.values));

      const hierarchyLabels = ["All"].concat(revenueTop.labels);
      const hierarchyParents = [""].concat(revenueTop.labels.map(() => "All"));
      const hierarchyValues = [round2(revenueTotal)].concat(revenueTop.values.map((v) => round2(v)));

      const distributionSamples = [];
      for (let i = 0; i < trendValues.length; i++) {
        const base = trendValues[i];
        distributionSamples.push(base - 6, base - 2, base, base + 3, base + 7);
      }

      const geoCountries = ["USA", "CAN", "MEX", "BRA", "GBR", "DEU", "FRA", "IND", "JPN", "AUS"];
      const geoLat = [37.09, 56.13, 23.63, -14.24, 55.38, 51.17, 46.23, 20.59, 36.2, -25.27];
      const geoLon = [-95.71, -106.35, -102.55, -51.93, -3.43, 10.45, 2.21, 78.96, 138.25, 133.77];
      const geoValues = geoCountries.map((_, idx) => round2(trendValues[idx % trendValues.length] * (0.65 + (idx % 4) * 0.12)));

      const financialRows = buildFinancialRows(trendLabels, trendValues);
      const openSeries = financialRows.map((row) => row.o);
      const highSeries = financialRows.map((row) => row.h);
      const lowSeries = financialRows.map((row) => row.l);
      const closeSeries = financialRows.map((row) => row.c);

      const topCustomerSeedLabels = safeLabels(topCustomerLabels, ["C-100", "C-101", "C-102", "C-103", "C-104"]);
      const topCustomerSeedValues = safeSeries(topCustomerValues, topCustomerSeedLabels.length, [140, 128, 115, 103, 86]);

      const corrLabels = ["Sales", "Cash", "Card", "QR"];
      const corrSeries = [trendValues, paymentCashSeries, paymentCardSeries, paymentQrSeries];
      const corrMatrix = corrSeries.map((row) => corrSeries.map((col) => round2(correlation(row, col))));

      const renderer = {
        pie(target) {
          Plotly.newPlot(target, [{
            type: "pie",
            labels: revenueTop.labels,
            values: revenueTop.values,
            marker: { colors: plotPalette }
          }], plotLayout(), plotlyConfig);
        },
        donut(target) {
          Plotly.newPlot(target, [{
            type: "pie",
            labels: revenueTop.labels,
            values: revenueTop.values,
            hole: 0.55,
            marker: { colors: plotPalette }
          }], plotLayout(), plotlyConfig);
        },
        semiDonut(target) {
          Plotly.newPlot(target, [{
            type: "pie",
            labels: revenueTop.labels,
            values: revenueTop.values,
            hole: 0.55,
            marker: { colors: plotPalette },
            rotation: 180,
            direction: "clockwise"
          }], plotLayout({ height: 170 }), plotlyConfig);
        },
        stackedBar(target) {
          Plotly.newPlot(target, [
            { type: "bar", x: paymentTrendLabels, y: paymentCashSeries, name: "Cash", marker: { color: plotPalette[0] } },
            { type: "bar", x: paymentTrendLabels, y: paymentCardSeries, name: "Card", marker: { color: plotPalette[1] } },
            { type: "bar", x: paymentTrendLabels, y: paymentQrSeries, name: "QR", marker: { color: plotPalette[3] } }
          ], plotLayout({ barmode: "stack", showlegend: true }), plotlyConfig);
        },
        stackedArea(target) {
          Plotly.newPlot(target, [
            { type: "scatter", mode: "lines", x: paymentTrendLabels, y: paymentCashSeries, stackgroup: "one", name: "Cash", line: { color: plotPalette[0] } },
            { type: "scatter", mode: "lines", x: paymentTrendLabels, y: paymentCardSeries, stackgroup: "one", name: "Card", line: { color: plotPalette[1] } },
            { type: "scatter", mode: "lines", x: paymentTrendLabels, y: paymentQrSeries, stackgroup: "one", name: "QR", line: { color: plotPalette[3] } }
          ], plotLayout({ showlegend: true }), plotlyConfig);
        },
        treemap(target) {
          Plotly.newPlot(target, [{
            type: "treemap",
            labels: hierarchyLabels,
            parents: hierarchyParents,
            values: hierarchyValues,
            marker: { colors: hierarchyValues, colorscale: "Blues" }
          }], plotLayout(), plotlyConfig);
        },
        sunburst(target) {
          Plotly.newPlot(target, [{
            type: "sunburst",
            labels: hierarchyLabels,
            parents: hierarchyParents,
            values: hierarchyValues,
            branchvalues: "total"
          }], plotLayout(), plotlyConfig);
        },
        waterfall(target) {
          const net = round2(toNumber(netRevenueTotalValue));
          Plotly.newPlot(target, [{
            type: "waterfall",
            x: ["Gross", "Discount", "Refund", "Void", "Net"],
            y: [
              round2(toNumber(grossRevenueTotal)),
              -round2(toNumber(discountTotalValue)),
              -round2(toNumber(refundTotalValue)),
              -round2(toNumber(voidTotalValue)),
              net
            ],
            measure: ["absolute", "relative", "relative", "relative", "total"],
            connector: { line: { color: "#94a3b8" } }
          }], plotLayout(), plotlyConfig);
        },
        waffle(target) {
          const counts = revenueTop.values.map((v) => Math.max(1, Math.round((v / revenueTotal) * 100)));
          const cells = [];
          for (let i = 0; i < counts.length; i++) {
            for (let c = 0; c < counts[i]; c++) cells.push(i + 1);
          }
          while (cells.length < 100) cells.push(0);
          const grid = [];
          for (let r = 0; r < 10; r++) {
            grid.push(cells.slice(r * 10, (r + 1) * 10));
          }
          Plotly.newPlot(target, [{
            type: "heatmap",
            z: grid,
            showscale: false,
            colorscale: [
              [0, "#f8fafc"],
              [0.2, plotPalette[0]],
              [0.4, plotPalette[1]],
              [0.6, plotPalette[2]],
              [0.8, plotPalette[3]],
              [1, plotPalette[4]]
            ]
          }], plotLayout({
            xaxis: { visible: false },
            yaxis: { visible: false }
          }), plotlyConfig);
        },
        funnel(target) {
          const sorted = topSlice(revenueTop.labels, revenueTop.values, revenueTop.labels.length);
          Plotly.newPlot(target, [{
            type: "funnel",
            y: sorted.labels,
            x: sorted.values,
            marker: { color: plotPalette }
          }], plotLayout(), plotlyConfig);
        },
        histogram(target) {
          Plotly.newPlot(target, [{
            type: "histogram",
            x: distributionSamples,
            marker: { color: plotPalette[1] },
            nbinsx: 12
          }], plotLayout(), plotlyConfig);
        },
        frequencyPolygon(target) {
          Plotly.newPlot(target, [{
            type: "histogram",
            x: distributionSamples,
            histnorm: "count",
            marker: { color: "rgba(148,163,184,0.2)" },
            nbinsx: 10
          }, {
            type: "scatter",
            x: trendLabels,
            y: trendValues,
            mode: "lines+markers",
            line: { color: plotPalette[0] }
          }], plotLayout(), plotlyConfig);
        },
        density(target) {
          Plotly.newPlot(target, [{
            type: "histogram",
            x: distributionSamples,
            histnorm: "probability density",
            marker: { color: "rgba(15,23,42,0.25)" },
            nbinsx: 12
          }, {
            type: "violin",
            y: distributionSamples,
            box: { visible: false },
            meanline: { visible: true },
            points: false,
            line: { color: plotPalette[0] },
            fillcolor: "rgba(15,23,42,0.15)"
          }], plotLayout(), plotlyConfig);
        },
        box(target) {
          Plotly.newPlot(target, [{
            type: "box",
            y: distributionSamples,
            boxpoints: "outliers",
            marker: { color: plotPalette[0] },
            line: { color: plotPalette[0] }
          }], plotLayout(), plotlyConfig);
        },
        violin(target) {
          Plotly.newPlot(target, [{
            type: "violin",
            y: distributionSamples,
            points: "all",
            jitter: 0.3,
            line: { color: plotPalette[0] },
            fillcolor: "rgba(15,23,42,0.2)"
          }], plotLayout(), plotlyConfig);
        },
        ridgeline(target) {
          Plotly.newPlot(target, [
            { type: "violin", x: distributionSamples.slice(0, 10), name: "A", side: "positive", line: { color: plotPalette[0] } },
            { type: "violin", x: distributionSamples.slice(5, 15), name: "B", side: "positive", line: { color: plotPalette[1] } },
            { type: "violin", x: distributionSamples.slice(10, 20), name: "C", side: "positive", line: { color: plotPalette[2] } }
          ], plotLayout({ violinmode: "overlay", showlegend: true }), plotlyConfig);
        },
        strip(target) {
          Plotly.newPlot(target, [{
            type: "box",
            y: distributionSamples,
            boxpoints: "all",
            jitter: 0.45,
            pointpos: 0,
            marker: { color: plotPalette[0], size: 5 },
            line: { color: "rgba(0,0,0,0)" },
            fillcolor: "rgba(15,23,42,0.05)"
          }], plotLayout(), plotlyConfig);
        },
        stemLeaf(target) {
          const stems = distributionSamples.slice(0, 12).map((value) => {
            const v = Math.round(value);
            return `${Math.floor(v / 10)} | ${Math.abs(v % 10)}`;
          });
          Plotly.newPlot(target, [{
            type: "scatter",
            mode: "text",
            x: stems.map((_, idx) => idx),
            y: stems.map(() => 0),
            text: stems,
            textposition: "middle center",
            textfont: { size: 11, color: "#334155" }
          }], plotLayout({
            xaxis: { visible: false },
            yaxis: { visible: false, range: [-1, 1] }
          }), plotlyConfig);
        },
        scatter(target) {
          Plotly.newPlot(target, [{
            type: "scatter",
            mode: "markers",
            x: trendValues,
            y: paymentCashSeries.slice(0, trendValues.length),
            marker: { color: plotPalette[0], size: 8 }
          }], plotLayout(), plotlyConfig);
        },
        bubble(target) {
          Plotly.newPlot(target, [{
            type: "scatter",
            mode: "markers",
            x: topCustomerSeedLabels,
            y: topCustomerSeedValues,
            marker: {
              color: plotPalette[1],
              sizemode: "area",
              sizeref: Math.max(...topCustomerSeedValues) / 40,
              size: topCustomerSeedValues
            }
          }], plotLayout(), plotlyConfig);
        },
        hexbin(target) {
          Plotly.newPlot(target, [{
            type: "histogram2d",
            x: distributionSamples,
            y: distributionSamples.map((v, idx) => v * 0.5 + idx),
            colorscale: "Blues"
          }], plotLayout(), plotlyConfig);
        },
        heatmap(target) {
          Plotly.newPlot(target, [{
            type: "heatmap",
            z: heatmapValues && heatmapValues.length ? heatmapValues : [ [1, 3, 2], [2, 5, 4], [1, 2, 3] ],
            x: heatmapHours && heatmapHours.length ? heatmapHours : [0, 1, 2],
            y: heatmapDays && heatmapDays.length ? heatmapDays : ["Mon", "Tue", "Wed"],
            colorscale: "Blues"
          }], plotLayout(), plotlyConfig);
        },
        scatterMatrix(target) {
          Plotly.newPlot(target, [{
            type: "splom",
            dimensions: [
              { label: "Sales", values: trendValues },
              { label: "Cash", values: paymentCashSeries.slice(0, trendValues.length) },
              { label: "Card", values: paymentCardSeries.slice(0, trendValues.length) },
              { label: "QR", values: paymentQrSeries.slice(0, trendValues.length) }
            ],
            marker: { color: plotPalette[0], size: 4, opacity: 0.7 }
          }], plotLayout(), plotlyConfig);
        },
        correlogram(target) {
          Plotly.newPlot(target, [{
            type: "heatmap",
            z: corrMatrix,
            x: corrLabels,
            y: corrLabels,
            zmin: -1,
            zmax: 1,
            colorscale: "RdBu"
          }], plotLayout(), plotlyConfig);
        },
        choropleth(target) {
          Plotly.newPlot(target, [{
            type: "choropleth",
            locations: geoCountries,
            z: geoValues,
            locationmode: "ISO-3",
            colorscale: "Blues"
          }], plotLayout({ geo: { showframe: false, showcoastlines: false } }), plotlyConfig);
        },
        symbolMap(target) {
          Plotly.newPlot(target, [{
            type: "scattergeo",
            mode: "markers",
            lat: geoLat,
            lon: geoLon,
            text: geoCountries,
            marker: {
              size: geoValues.map((v) => Math.max(6, Math.min(18, v / 20))),
              color: plotPalette[0],
              opacity: 0.7
            }
          }], plotLayout({ geo: { showframe: false, showcoastlines: false } }), plotlyConfig);
        },
        dotDensity(target) {
          const dotsLat = [];
          const dotsLon = [];
          for (let i = 0; i < geoLat.length; i++) {
            const count = Math.max(3, Math.round(geoValues[i] / 30));
            for (let d = 0; d < count; d++) {
              dotsLat.push(geoLat[i] + ((d % 5) - 2) * 0.6);
              dotsLon.push(geoLon[i] + ((d % 5) - 2) * 0.6);
            }
          }
          Plotly.newPlot(target, [{
            type: "scattergeo",
            mode: "markers",
            lat: dotsLat,
            lon: dotsLon,
            marker: { size: 3, color: plotPalette[0], opacity: 0.6 }
          }], plotLayout({ geo: { showframe: false, showcoastlines: false } }), plotlyConfig);
        },
        flowMap(target) {
          const srcLat = geoLat[0];
          const srcLon = geoLon[0];
          const lineTraces = geoLat.slice(1).map((lat, idx) => ({
            type: "scattergeo",
            mode: "lines",
            lat: [srcLat, lat],
            lon: [srcLon, geoLon[idx + 1]],
            line: { width: 1 + (idx % 3), color: plotPalette[1] },
            opacity: 0.6,
            hoverinfo: "skip"
          }));
          const markerTrace = {
            type: "scattergeo",
            mode: "markers",
            lat: geoLat,
            lon: geoLon,
            marker: { size: 5, color: plotPalette[0] },
            hovertext: geoCountries
          };
          Plotly.newPlot(target, lineTraces.concat([markerTrace]), plotLayout({
            geo: { showframe: false, showcoastlines: false }
          }), plotlyConfig);
        },
        geoHeatmap(target) {
          Plotly.newPlot(target, [{
            type: "scattergeo",
            mode: "markers",
            lat: geoLat,
            lon: geoLon,
            marker: {
              size: geoValues.map((v) => Math.max(8, Math.min(26, v / 12))),
              color: geoValues,
              colorscale: "Blues",
              opacity: 0.55,
              showscale: false
            }
          }], plotLayout({ geo: { showframe: false, showcoastlines: false } }), plotlyConfig);
        },
        icicle(target) {
          try {
            Plotly.newPlot(target, [{
              type: "icicle",
              labels: hierarchyLabels,
              parents: hierarchyParents,
              values: hierarchyValues
            }], plotLayout(), plotlyConfig);
          } catch (error) {
            renderer.treemap(target);
          }
        },
        parallel(target) {
          Plotly.newPlot(target, [{
            type: "parcoords",
            line: { color: trendValues, colorscale: "Blues" },
            dimensions: [
              { label: "Sales", values: trendValues },
              { label: "Cash", values: paymentCashSeries.slice(0, trendValues.length) },
              { label: "Card", values: paymentCardSeries.slice(0, trendValues.length) },
              { label: "QR", values: paymentQrSeries.slice(0, trendValues.length) }
            ]
          }], plotLayout(), plotlyConfig);
        },
        radar(target) {
          const refundRate = toNumber(saleCountValue) > 0 ? (toNumber(refundCountValue) * 100) / toNumber(saleCountValue) : 0;
          Plotly.newPlot(target, [{
            type: "scatterpolar",
            r: [
              clamp((toNumber(netRevenueTotalValue) / Math.max(1, toNumber(grossRevenueTotal))) * 100, 0, 100),
              clamp(grossMarginPercentValue, 0, 100),
              clamp(discountRatePercentValue, 0, 100),
              clamp(refundRate, 0, 100),
              clamp(splitPaymentRatePercentValue, 0, 100)
            ],
            theta: ["Retention", "Margin", "Discount", "Refund", "Split"],
            fill: "toself",
            line: { color: plotPalette[0] }
          }], plotLayout({ polar: { radialaxis: { visible: true, range: [0, 100] } } }), plotlyConfig);
        },
        mosaic(target) {
          renderer.treemap(target);
        },
        sankey(target) {
          Plotly.newPlot(target, [{
            type: "sankey",
            node: {
              label: ["Gross", "Discount", "Refund", "Net", "Cash", "Card", "QR"],
              color: ["#0f172a", "#334155", "#64748b", "#16a34a", "#0f172a", "#334155", "#94a3b8"]
            },
            link: {
              source: [0, 0, 0, 3, 3, 3],
              target: [1, 2, 3, 4, 5, 6],
              value: [
                Math.max(1, toNumber(discountTotalValue)),
                Math.max(1, toNumber(refundTotalValue)),
                Math.max(1, toNumber(netRevenueTotalValue)),
                Math.max(1, sumValues(paymentCashSeries)),
                Math.max(1, sumValues(paymentCardSeries)),
                Math.max(1, sumValues(paymentQrSeries))
              ]
            }
          }], plotLayout(), plotlyConfig);
        },
        bullet(target) {
          Plotly.newPlot(target, [{
            type: "indicator",
            mode: "number+gauge+delta",
            value: round2(toNumber(grossMarginPercentValue)),
            delta: { reference: 35 },
            gauge: {
              shape: "bullet",
              axis: { range: [0, 100] },
              steps: [{ range: [0, 35], color: "#e2e8f0" }, { range: [35, 60], color: "#cbd5e1" }],
              bar: { color: "#0f172a" }
            }
          }], plotLayout({ margin: { l: 40, r: 20, t: 14, b: 22 } }), plotlyConfig);
        },
        gauge(target) {
          Plotly.newPlot(target, [{
            type: "indicator",
            mode: "gauge+number",
            value: round2(toNumber(sellThroughPercentValue)),
            gauge: {
              axis: { range: [0, 100] },
              bar: { color: "#0f172a" },
              steps: [{ range: [0, 50], color: "#e2e8f0" }, { range: [50, 75], color: "#cbd5e1" }, { range: [75, 100], color: "#94a3b8" }]
            }
          }], plotLayout(), plotlyConfig);
        },
        progress(target) {
          const progress = clamp((toNumber(netRevenueTotalValue) / Math.max(1, toNumber(grossRevenueTotal))) * 100, 0, 100);
          Plotly.newPlot(target, [{
            type: "bar",
            x: [progress],
            y: ["Progress"],
            orientation: "h",
            marker: { color: "#0f172a" }
          }], plotLayout({
            xaxis: { range: [0, 100], ticksuffix: "%" },
            yaxis: { showgrid: false }
          }), plotlyConfig);
        },
        kpi(target) {
          Plotly.newPlot(target, [{
            type: "indicator",
            mode: "number+delta",
            value: round2(toNumber(netRevenueTotalValue)),
            number: { prefix: "$" },
            delta: { reference: round2(toNumber(grossRevenueTotal) * 0.9), relative: true }
          }], plotLayout(), plotlyConfig);
        },
        sparkline(target) {
          Plotly.newPlot(target, [{
            type: "scatter",
            mode: "lines",
            x: trendLabels,
            y: trendValues,
            line: { color: plotPalette[0], width: 2 }
          }], plotLayout({
            margin: { l: 8, r: 8, t: 8, b: 8 },
            xaxis: { visible: false },
            yaxis: { visible: false }
          }), plotlyConfig);
        },
        candlestick(target) {
          Plotly.newPlot(target, [{
            type: "candlestick",
            x: trendLabels,
            open: openSeries,
            high: highSeries,
            low: lowSeries,
            close: closeSeries
          }], plotLayout(), plotlyConfig);
        },
        ohlc(target) {
          Plotly.newPlot(target, [{
            type: "ohlc",
            x: trendLabels,
            open: openSeries,
            high: highSeries,
            low: lowSeries,
            close: closeSeries
          }], plotLayout(), plotlyConfig);
        },
        control(target) {
          const mean = trendValues.reduce((acc, v) => acc + v, 0) / Math.max(1, trendValues.length);
          const variance = trendValues.reduce((acc, v) => acc + Math.pow(v - mean, 2), 0) / Math.max(1, trendValues.length);
          const sigma = Math.sqrt(variance);
          const ucl = mean + (3 * sigma);
          const lcl = Math.max(0, mean - (3 * sigma));
          Plotly.newPlot(target, [
            { type: "scatter", mode: "lines+markers", x: trendLabels, y: trendValues, name: "Actual", line: { color: plotPalette[0] } },
            { type: "scatter", mode: "lines", x: trendLabels, y: trendLabels.map(() => ucl), name: "UCL", line: { color: "#dc2626", dash: "dash" } },
            { type: "scatter", mode: "lines", x: trendLabels, y: trendLabels.map(() => mean), name: "Mean", line: { color: "#64748b", dash: "dot" } },
            { type: "scatter", mode: "lines", x: trendLabels, y: trendLabels.map(() => lcl), name: "LCL", line: { color: "#dc2626", dash: "dash" } }
          ], plotLayout({ showlegend: true }), plotlyConfig);
        },
        pareto(target) {
          const sorted = topSlice(revenueTop.labels, revenueTop.values, revenueTop.labels.length);
          let cumulative = 0;
          const cumulativePct = sorted.values.map((v) => {
            cumulative += v;
            return round2((cumulative / Math.max(1, sumValues(sorted.values))) * 100);
          });
          Plotly.newPlot(target, [
            { type: "bar", x: sorted.labels, y: sorted.values, marker: { color: plotPalette[0] }, name: "Value" },
            { type: "scatter", x: sorted.labels, y: cumulativePct, yaxis: "y2", mode: "lines+markers", line: { color: "#16a34a" }, name: "Cumulative %" }
          ], plotLayout({
            showlegend: true,
            yaxis2: { overlaying: "y", side: "right", range: [0, 110], ticksuffix: "%" }
          }), plotlyConfig);
        },
        gantt(target) {
          Plotly.newPlot(target, [{
            type: "bar",
            orientation: "h",
            y: ["Open Shift", "Sales Window", "Reconcile", "Close Shift"],
            x: [0.5, 6.0, 1.0, 0.5],
            base: [8.0, 8.5, 14.5, 15.5],
            marker: { color: [plotPalette[1], plotPalette[0], plotPalette[2], plotPalette[3]] }
          }], plotLayout({
            xaxis: { title: "Hour of Day", range: [7.5, 16.5] }
          }), plotlyConfig);
        },
        network(target) {
          const nodes = ["POS", "Sales", "Inventory", "Finance", "Customers", "Reports"];
          const x = [0, 1, 2, 1, 0.5, 1.8];
          const y = [1, 1.5, 1, 0.5, 0, 0.2];
          const edges = [ [0, 1], [1, 2], [1, 3], [1, 4], [3, 5], [2, 5] ];
          const lineX = [];
          const lineY = [];
          edges.forEach((pair) => {
            lineX.push(x[pair[0]], x[pair[1]], null);
            lineY.push(y[pair[0]], y[pair[1]], null);
          });
          Plotly.newPlot(target, [
            { type: "scatter", mode: "lines", x: lineX, y: lineY, line: { color: "#94a3b8", width: 1 }, hoverinfo: "skip" },
            { type: "scatter", mode: "markers+text", x: x, y: y, text: nodes, textposition: "top center", marker: { size: 10, color: "#0f172a" } }
          ], plotLayout({
            xaxis: { visible: false },
            yaxis: { visible: false }
          }), plotlyConfig);
        },
        wordCloud(target) {
          const words = revenueTop.labels.slice(0, 6);
          const weights = revenueTop.values.slice(0, words.length);
          Plotly.newPlot(target, [{
            type: "bar",
            x: weights,
            y: words,
            orientation: "h",
            marker: { color: plotPalette[1] }
          }], plotLayout(), plotlyConfig);
        },
        calendarHeatmap(target) {
          const weeks = ["W1", "W2", "W3", "W4", "W5", "W6"];
          const days = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
          const z = days.map((_, dayIdx) => weeks.map((_, weekIdx) => {
            const idx = (weekIdx * 7) + dayIdx;
            return round2(trendValues[idx % trendValues.length]);
          }));
          Plotly.newPlot(target, [{
            type: "heatmap",
            z: z,
            x: weeks,
            y: days,
            colorscale: "Blues"
          }], plotLayout(), plotlyConfig);
        },
        pyramid(target) {
          Plotly.newPlot(target, [{
            type: "funnelarea",
            labels: ["Leads", "Visits", "Carts", "Checkouts", "Paid"],
            values: [100, 78, 52, 34, 27],
            marker: { colors: plotPalette }
          }], plotLayout(), plotlyConfig);
        },
        populationPyramid(target) {
          Plotly.newPlot(target, [
            { type: "bar", y: ["18-24", "25-34", "35-44", "45-54", "55+"], x: [-18, -26, -22, -14, -8], orientation: "h", name: "Male", marker: { color: plotPalette[1] } },
            { type: "bar", y: ["18-24", "25-34", "35-44", "45-54", "55+"], x: [17, 24, 20, 13, 9], orientation: "h", name: "Female", marker: { color: plotPalette[3] } }
          ], plotLayout({ barmode: "relative", showlegend: true }), plotlyConfig);
        },
        ternary(target) {
          Plotly.newPlot(target, [{
            type: "scatterternary",
            mode: "markers",
            a: [45, 30, 20, 35, 40],
            b: [35, 45, 30, 25, 20],
            c: [20, 25, 50, 40, 40],
            marker: { size: 8, color: plotPalette[0] }
          }], plotLayout(), plotlyConfig);
        },
        spiral(target) {
          const theta = [];
          const radius = [];
          for (let i = 0; i < 40; i++) {
            theta.push(i * 18);
            radius.push(2 + (i * 0.12) + (Math.sin(i / 2) * 0.5));
          }
          Plotly.newPlot(target, [{
            type: "scatterpolar",
            mode: "lines",
            theta: theta,
            r: radius,
            line: { color: plotPalette[0] }
          }], plotLayout({ polar: { radialaxis: { visible: false } } }), plotlyConfig);
        },
        marimekko(target) {
          const widths = revenueTop.values.map((v) => (v / revenueTotal) * 10);
          let running = 0;
          const centers = widths.map((w) => {
            running += w / 2;
            const center = running;
            running += w / 2;
            return center;
          });
          Plotly.newPlot(target, [
            { type: "bar", x: centers, y: revenueTop.values, width: widths, name: "Revenue", marker: { color: plotPalette[0] } },
            { type: "bar", x: centers, y: revenueTop.values.map((v) => round2(v * 0.35)), width: widths, name: "Margin", marker: { color: plotPalette[3] } }
          ], plotLayout({
            barmode: "stack",
            showlegend: true,
            xaxis: { tickmode: "array", tickvals: centers, ticktext: revenueTop.labels }
          }), plotlyConfig);
        }
      };

      const chartGroups = [
        {
          title: "Part-to-Whole Charts",
          charts: [
            { name: "Pie Chart", key: "pie" },
            { name: "Donut Chart", key: "donut" },
            { name: "Semi-circle Donut", key: "semiDonut" },
            { name: "Stacked Bar Chart", key: "stackedBar" },
            { name: "Stacked Area Chart", key: "stackedArea" },
            { name: "Treemap", key: "treemap" },
            { name: "Sunburst Chart", key: "sunburst" },
            { name: "Waterfall Chart", key: "waterfall" },
            { name: "Waffle Chart", key: "waffle" },
            { name: "Funnel Chart", key: "funnel" }
          ]
        },
        {
          title: "Distribution Charts",
          charts: [
            { name: "Histogram", key: "histogram" },
            { name: "Frequency Polygon", key: "frequencyPolygon" },
            { name: "Density Plot", key: "density" },
            { name: "Box Plot", key: "box" },
            { name: "Box-and-Whisker Plot", key: "box" },
            { name: "Violin Plot", key: "violin" },
            { name: "Ridgeline Plot", key: "ridgeline" },
            { name: "Strip Plot", key: "strip" },
            { name: "Swarm Plot", key: "strip" },
            { name: "Stem-and-Leaf Plot", key: "stemLeaf" }
          ]
        },
        {
          title: "Relationship / Correlation Charts",
          charts: [
            { name: "Scatter Plot", key: "scatter" },
            { name: "Bubble Chart", key: "bubble" },
            { name: "Hexbin Plot", key: "hexbin" },
            { name: "Heatmap", key: "heatmap" },
            { name: "Pair Plot (Scatter Matrix)", key: "scatterMatrix" },
            { name: "Correlogram", key: "correlogram" }
          ]
        },
        {
          title: "Geographic Charts",
          charts: [
            { name: "Choropleth Map", key: "choropleth" },
            { name: "Symbol Map", key: "symbolMap" },
            { name: "Dot Density Map", key: "dotDensity" },
            { name: "Cartogram", key: "choropleth" },
            { name: "Flow Map", key: "flowMap" },
            { name: "Geographic Heatmap", key: "geoHeatmap" }
          ]
        },
        {
          title: "Hierarchical Charts",
          charts: [
            { name: "Treemap", key: "treemap" },
            { name: "Sunburst Chart", key: "sunburst" },
            { name: "Dendrogram", key: "icicle" },
            { name: "Icicle Chart", key: "icicle" },
            { name: "Tree Diagram", key: "sunburst" }
          ]
        },
        {
          title: "Multivariate Charts",
          charts: [
            { name: "Parallel Coordinates Plot", key: "parallel" },
            { name: "Radar Chart", key: "radar" },
            { name: "Bubble Chart", key: "bubble" },
            { name: "Mosaic Plot", key: "mosaic" }
          ]
        },
        {
          title: "Flow / Process Charts",
          charts: [
            { name: "Funnel Chart", key: "funnel" },
            { name: "Sankey Diagram", key: "sankey" },
            { name: "Chord Diagram", key: "sankey" },
            { name: "Alluvial Diagram", key: "sankey" },
            { name: "Process Flow Diagram", key: "sankey" }
          ]
        },
        {
          title: "Performance & KPI Charts",
          charts: [
            { name: "Bullet Chart", key: "bullet" },
            { name: "Gauge Chart", key: "gauge" },
            { name: "Progress Bar Chart", key: "progress" },
            { name: "KPI Scorecard", key: "kpi" },
            { name: "Sparklines", key: "sparkline" }
          ]
        },
        {
          title: "Financial & Statistical Charts",
          charts: [
            { name: "Candlestick Chart", key: "candlestick" },
            { name: "OHLC Chart", key: "ohlc" },
            { name: "Control Chart", key: "control" },
            { name: "Pareto Chart", key: "pareto" },
            { name: "Gantt Chart", key: "gantt" }
          ]
        },
        {
          title: "Advanced / Specialized Charts",
          charts: [
            { name: "Network Graph", key: "network" },
            { name: "Force-Directed Graph", key: "network" },
            { name: "Word Cloud", key: "wordCloud" },
            { name: "Calendar Heatmap", key: "calendarHeatmap" },
            { name: "Pyramid Chart", key: "pyramid" },
            { name: "Population Pyramid", key: "populationPyramid" },
            { name: "Ternary Plot", key: "ternary" },
            { name: "Spiral Plot", key: "spiral" },
            { name: "Waterfall Chart", key: "waterfall" },
            { name: "Marimekko (Mekko) Chart", key: "marimekko" }
          ]
        }
      ];

      function renderChart(targetId, definition) {
        const target = document.getElementById(targetId);
        if (!target) return;
        const fn = renderer[definition.key];
        if (typeof fn !== "function") {
          placeholderPlot(target, "Not configured");
          return;
        }
        try {
          fn(target);
          requestAnimationFrame(() => {
            const width = target.clientWidth || 320;
            const height = target.clientHeight || 176;
            Plotly.relayout(target, { width, height });
          });
        } catch (error) {
          console.error("Advanced chart render failed:", definition.name, error);
          placeholderPlot(target, "Rendering fallback");
        }
      }

      chartGroups.forEach((group, groupIdx) => {
        const details = document.createElement("details");
        details.className = "rounded-xl border border-slate-200 bg-white";
        if (groupIdx === 0) details.open = true;

        const summary = document.createElement("summary");
        summary.className = "cursor-pointer select-none px-4 py-3 text-sm font-semibold text-slate-800";
        summary.textContent = `${group.title} (${group.charts.length})`;
        details.appendChild(summary);

        const body = document.createElement("div");
        body.className = "px-4 pb-4";
        const grid = document.createElement("div");
        grid.className = "grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4";
        body.appendChild(grid);
        details.appendChild(body);
        details.dataset.rendered = "false";

        function renderGroupOnce() {
          if (details.dataset.rendered === "true") return;
          details.dataset.rendered = "true";
          group.charts.forEach((chart, chartIdx) => {
            const card = document.createElement("div");
            card.className = "rounded-xl border border-slate-200 bg-slate-50 px-3 py-3 overflow-hidden";

            const title = document.createElement("div");
            title.className = "text-xs font-semibold text-slate-700";
            title.textContent = chart.name;
            card.appendChild(title);

            const plotId = `adv-${slugify(group.title)}-${chartIdx}-${slugify(chart.name)}`;
            const plot = document.createElement("div");
            plot.id = plotId;
            plot.className = "mt-2 h-44 w-full";
            card.appendChild(plot);

            grid.appendChild(card);
            renderChart(plotId, chart);
          });
        }

        details.addEventListener("toggle", () => {
          if (details.open) renderGroupOnce();
        });

        galleryRoot.appendChild(details);
        if (details.open) renderGroupOnce();
      });
    }

    initAdvancedChartGallery();
  </script>
</body>
</html>
