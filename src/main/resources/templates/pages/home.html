<!doctype html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security" data-lang-switcher-auto>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>POS System</title>

  <link rel="stylesheet" th:href="@{/css/app.css}" href="/css/app.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>

  <!-- UI-only helpers -->
  <style>
    .chart-wrap { height: 220px; }
    @media (min-width: 1024px){ .chart-wrap { height: 240px; } }
    /* Mobile menu transition */
    #mobileNav { transition: opacity 0.2s ease-in-out; }
    #mobileNav:not(.hidden) { opacity: 1; }
  </style>
</head>

<body class="bg-slate-100 text-slate-900 selection:bg-slate-900 selection:text-white">
  <div class="min-h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-white/80 backdrop-blur border-b border-slate-200 sticky top-0 z-40">
      <div class="w-full px-6 lg:px-10 py-5">
        <div class="grid grid-cols-[auto_1fr_auto] items-center gap-4">
          <!-- Logo area -->
          <div class="flex items-center gap-3">
            <div class="h-10 w-10 rounded-xl bg-slate-900 text-white grid place-items-center shadow-sm">
              <svg viewBox="0 0 24 24" class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 6h12v4H6V6z"/>
                <path d="M6 10h12v8a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2v-8z"/>
                <path d="M9 14h6"/>
              </svg>
            </div>
            <div>
              <div class="text-xl sm:text-2xl font-bold leading-tight">Dashboard</div>
              <div class="text-sm text-slate-500">Quick access to sales, products, and the register</div>
            </div>
          </div>

          <!-- Desktop navigation (replaced by fragment) -->
          <nav th:replace="~{fragments/navigation :: mainNav}" class="hidden lg:block"></nav>

          <!-- Right side: language switcher, auth buttons, mobile menu trigger -->
          <div class="flex flex-wrap items-center justify-end gap-2">
            <!-- Language Switcher (enterprise version) -->
            <form data-lang-switcher-form="true" method="get" class="m-0">
              <select data-lang-switcher-select="true"
                      class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-400"
                      aria-label="Select language">
                <option value="en" selected>ðŸ‡¬ðŸ‡§ English</option>
                <option value="es">ðŸ‡ªðŸ‡¸ EspaÃ±ol</option>
                <option value="fr">ðŸ‡«ðŸ‡· FranÃ§ais</option>
                <option value="de">ðŸ‡©ðŸ‡ª Deutsch</option>
              </select>
            </form>

            <!-- Login/Logout -->
            <a sec:authorize="isAnonymous()" href="/login"
               class="rounded-xl border border-slate-200 px-4 py-2 bg-white hover:bg-slate-50 transition">
              Login
            </a>
            <form sec:authorize="isAuthenticated()" action="/logout" method="post" class="m-0">
              <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
              <button class="rounded-xl border border-slate-200 px-4 py-2 bg-white hover:bg-slate-50 transition">
                Logout
              </button>
            </form>

            <!-- Mobile menu button (hamburger) -->
            <button id="mobileMenuBtn" class="lg:hidden rounded-xl border border-slate-200 p-2 bg-white hover:bg-slate-50 transition" aria-label="Toggle menu">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
              </svg>
            </button>
          </div>
        </div>

        <!-- Mobile navigation (hidden by default) -->
        <div id="mobileNav" class="lg:hidden mt-4 hidden border-t border-slate-200 pt-4">
          <nav th:replace="~{fragments/navigation :: mainNav}" class="flex flex-col space-y-2"></nav>
        </div>
      </div>
    </header>

    <!-- MAIN -->
    <main class="flex-1 w-full px-4 sm:px-6 lg:px-10 py-8 lg:py-10">
      <div class="mb-6 flex justify-end">
        <a href="/pos"
           class="rounded-xl bg-slate-900 px-4 py-2 font-semibold text-white hover:bg-slate-800 transition">
          Open POS
        </a>
      </div>

      <!-- Dashboard intro -->
      <section class="rounded-3xl bg-white border border-slate-200 p-6 sm:p-8 shadow-sm">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6">
          <div>
            <div class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-slate-50 px-3 py-1 text-xs text-slate-600">
              <span class="h-2 w-2 rounded-full bg-emerald-500"></span>
              Dashboard
            </div>

            <h1 class="mt-3 text-2xl sm:text-3xl font-semibold tracking-tight">Sales overview</h1>
            <p class="mt-2 text-sm text-slate-600">
              Choose a section to get started.
            </p>

            <div class="mt-5 flex flex-wrap gap-2">
              <a href="/products"
                 class="rounded-2xl bg-slate-900 text-white px-5 py-2.5 text-sm font-semibold hover:bg-slate-800 transition">
                Products
              </a>
              <a href="/sales"
                 class="rounded-2xl bg-white border border-slate-200 px-5 py-2.5 text-sm font-semibold hover:bg-slate-50 transition">
                Sales
              </a>
            </div>
          </div>

          <div class="rounded-3xl border border-slate-200 bg-gradient-to-b from-slate-50 to-white px-6 py-5 shadow-sm">
            <div class="text-xs uppercase tracking-wide text-slate-500">Overview</div>
            <div class="mt-1 text-lg font-semibold text-slate-900">Sales Insights</div>
            <div class="mt-1 text-sm text-slate-600">Daily, monthly, and payment trends.</div>
          </div>
        </div>
      </section>

      <!-- Charts (unchanged) -->
      <section class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Line -->
        <div class="rounded-3xl bg-white border border-slate-200 p-6 shadow-sm">
          <div class="flex items-start justify-between gap-4">
            <div>
              <div class="text-base font-semibold">Sales Trend</div>
              <div class="text-sm text-slate-500">Daily vs monthly sales</div>
            </div>
            <div class="flex items-center gap-1 rounded-2xl bg-slate-100 p-1 text-xs">
              <button id="salesModeDaily" class="rounded-xl px-3 py-1.5 bg-white shadow-sm border border-slate-200">Daily</button>
              <button id="salesModeMonthly" class="rounded-xl px-3 py-1.5 text-slate-600 hover:text-slate-900">Monthly</button>
            </div>
          </div>
          <div class="mt-4 rounded-2xl border border-slate-200 bg-slate-50 p-4">
            <div class="chart-wrap">
              <canvas id="salesLineChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Stacked bar -->
        <div class="rounded-3xl bg-white border border-slate-200 p-6 shadow-sm">
          <div>
            <div class="text-base font-semibold">Payment Methods</div>
            <div class="text-sm text-slate-500">Cash / Card / QR (last 7 days)</div>
          </div>
          <div class="mt-4 rounded-2xl border border-slate-200 bg-slate-50 p-4">
            <div class="chart-wrap">
              <canvas id="paymentStackChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Top -->
        <div class="rounded-3xl bg-white border border-slate-200 p-6 shadow-sm">
          <div class="flex items-start justify-between gap-4">
            <div>
              <div class="text-base font-semibold">Top Performers</div>
              <div class="text-sm text-slate-500">Products or categories by revenue</div>
            </div>
            <div class="flex items-center gap-1 rounded-2xl bg-slate-100 p-1 text-xs">
              <button id="topModeProducts" class="rounded-xl px-3 py-1.5 bg-white shadow-sm border border-slate-200">Products</button>
              <button id="topModeCategories" class="rounded-xl px-3 py-1.5 text-slate-600 hover:text-slate-900">Categories</button>
            </div>
          </div>
          <div class="mt-4 rounded-2xl border border-slate-200 bg-slate-50 p-4">
            <div class="chart-wrap">
              <canvas id="topBarChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Donut -->
        <div class="rounded-3xl bg-white border border-slate-200 p-6 shadow-sm">
          <div>
            <div class="text-base font-semibold">Revenue Share</div>
            <div class="text-sm text-slate-500">Category mix</div>
          </div>
          <div class="mt-4 rounded-2xl border border-slate-200 bg-slate-50 p-4">
            <div class="chart-wrap">
              <canvas id="revenueDonutChart"></canvas>
            </div>
          </div>
        </div>
      </section>

      <!-- Navigation cards (unchanged) -->
      <section class="mt-10 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
        <a href="/pos"
           class="group rounded-3xl bg-white p-7 border border-slate-200 shadow-sm hover:shadow-lg hover:-translate-y-0.5 transition">
          <div class="flex items-center justify-between">
            <div class="text-lg font-semibold">Point of Sale</div>
            <span class="text-slate-300 group-hover:text-slate-500 transition">â†’</span>
          </div>
          <p class="mt-3 text-sm text-slate-500">
            Sell items, scan barcodes, and checkout.
          </p>
        </a>

        <a href="/products"
           class="group rounded-3xl bg-white p-7 border border-slate-200 shadow-sm hover:shadow-lg hover:-translate-y-0.5 transition">
          <div class="flex items-center justify-between">
            <div class="text-lg font-semibold">Products</div>
            <span class="text-slate-300 group-hover:text-slate-500 transition">â†’</span>
          </div>
          <p class="mt-3 text-sm text-slate-500">
            Manage inventory, prices, and categories.
          </p>
        </a>

        <a href="/products?lowStock=true"
           class="group rounded-3xl bg-amber-50/60 p-7 border border-amber-200 shadow-sm hover:shadow-lg hover:-translate-y-0.5 transition">
          <div class="flex items-center justify-between">
            <div class="text-lg font-semibold text-amber-900">Low Stock</div>
            <span class="text-amber-300 group-hover:text-amber-500 transition">â†’</span>
          </div>
          <p class="mt-3 text-sm text-amber-800/80">
            Review items below threshold.
          </p>
          <div class="mt-3 inline-flex items-center rounded-full bg-amber-100 px-2.5 py-1 text-xs font-semibold text-amber-800">
            <span th:if="${lowStockCount > 0}">
              <span th:text="${lowStockCount}">0</span> item(s) low
            </span>
            <span th:unless="${lowStockCount > 0}">All stocked</span>
          </div>
        </a>

        <a href="/categories"
           class="group rounded-3xl bg-white p-7 border border-slate-200 shadow-sm hover:shadow-lg hover:-translate-y-0.5 transition">
          <div class="flex items-center justify-between">
            <div class="text-lg font-semibold">Categories</div>
            <span class="text-slate-300 group-hover:text-slate-500 transition">â†’</span>
          </div>
          <p class="mt-3 text-sm text-slate-500">
            Organize products by type.
          </p>
        </a>

        <a href="/sales"
           class="group rounded-3xl bg-white p-7 border border-slate-200 shadow-sm hover:shadow-lg hover:-translate-y-0.5 transition">
          <div class="flex items-center justify-between">
            <div class="text-lg font-semibold">Sales</div>
            <span class="text-slate-300 group-hover:text-slate-500 transition">â†’</span>
          </div>
          <p class="mt-3 text-sm text-slate-500">
            View receipts and sales history.
          </p>
        </a>
      </section>
    </main>

    <!-- FOOTER (unchanged) -->
    <footer class="w-full px-4 sm:px-6 lg:px-10 pb-10">
      <div class="rounded-3xl border border-slate-200 bg-white p-8 sm:p-10 shadow-sm">
        <div class="flex flex-col items-center gap-4 text-center">
          <div class="h-12 w-12 rounded-2xl bg-slate-900 text-white grid place-items-center shadow-sm">
            <svg viewBox="0 0 24 24" class="h-6 w-6" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 18h.01"/>
              <path d="M9 9a3 3 0 1 1 6 0c0 2-3 2-3 5"/>
              <path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20z"/>
            </svg>
          </div>

          <div>
            <div class="text-base font-semibold">Licenses</div>
            <div class="mt-1 text-sm text-slate-600">
              Copyright Â© 2026 Group 2 POS System. All rights reserved.
            </div>
          </div>
        </div>
      </div>
    </footer>
  </div>

  <script th:inline="javascript">
    // UI-only: mobile nav toggle (now the button exists)
    document.getElementById("mobileMenuBtn")?.addEventListener("click", () => {
      document.getElementById("mobileNav")?.classList.toggle("hidden");
    });

    // Chart data from Thymeleaf (unchanged)
    const dailyLabels = /*[[${dailyLabels}]]*/ [];
    const dailySales = /*[[${dailySales}]]*/ [];
    const monthlyLabels = /*[[${monthlyLabels}]]*/ [];
    const monthlySales = /*[[${monthlySales}]]*/ [];
    const topProductLabels = /*[[${topProductLabels}]]*/ [];
    const topProductValues = /*[[${topProductValues}]]*/ [];
    const topCategoryLabels = /*[[${topCategoryLabels}]]*/ [];
    const topCategoryValues = /*[[${topCategoryValues}]]*/ [];
    const paymentLabels = /*[[${paymentLabels}]]*/ [];
    const paymentCash = /*[[${paymentCash}]]*/ [];
    const paymentCard = /*[[${paymentCard}]]*/ [];
    const paymentQr = /*[[${paymentQr}]]*/ [];
    const revenueShareLabels = /*[[${revenueShareLabels}]]*/ [];
    const revenueShareValues = /*[[${revenueShareValues}]]*/ [];

    /**
     * Executes the formatMoney function.
     * @param {*} value Input parameter used by this function.
     * @returns {any} Result produced by this function.
     * @throws {Error} May throw runtime errors from DOM, network, or dependency operations.
     * Edge cases: Null, undefined, and empty inputs are handled by the existing implementation.
     */
    function formatMoney(value) {
      if (typeof value !== "number") return value;
      return "$" + value.toFixed(2);
    }

    const lineCtx = document.getElementById("salesLineChart");
    const lineChart = lineCtx ? new Chart(lineCtx, {
    /**
     * Executes the formatMoney function.
     * @param {*} value Input parameter used by this function.
     * @returns {any} Result produced by this function.
     * @throws {Error} May throw runtime errors from DOM, network, or dependency operations.
     * Edge cases: Null, undefined, and empty inputs are handled by the existing implementation.
     */
    /**
     * Executes the formatMoney function.
     * @param {*} value Input parameter used by this function.
     * @returns {any} Result produced by this function.
     * @throws {Error} May throw runtime errors from DOM, network, or dependency operations.
     * Edge cases: Null, undefined, and empty inputs are handled by the existing implementation.
     */
      type: "line",
      data: {
        labels: dailyLabels,
        datasets: [{
          label: "Sales",
          data: dailySales,
          borderColor: "#0f172a",
          backgroundColor: "rgba(15, 23, 42, 0.10)",
          fill: true,
          tension: 0.35,
          pointRadius: 3,
          pointBackgroundColor: "#0f172a"
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            mode: "index",
            intersect: false,
            callbacks: { label: (ctx) => formatMoney(ctx.parsed.y) }
          }
        },
        scales: {
          x: { grid: { display: false } },
          y: { grid: { color: "rgba(148,163,184,0.35)" } }
        }
      }
    }) : null;

    /**
     * Executes the setSalesMode function.
     * @param {*} mode Input parameter used by this function.
     * @returns {any} Result produced by this function.
     * @throws {Error} May throw runtime errors from DOM, network, or dependency operations.
     * Edge cases: Null, undefined, and empty inputs are handled by the existing implementation.
     */
    function setSalesMode(mode) {
      if (!lineChart) return;
      if (mode === "monthly") {
        lineChart.data.labels = monthlyLabels;
        lineChart.data.datasets[0].data = monthlySales;
        document.getElementById("salesModeMonthly").classList.add("bg-white","shadow-sm","border","border-slate-200");
        document.getElementById("salesModeMonthly").classList.remove("text-slate-600");
    /**
     * Executes the setSalesMode function.
     * @param {*} mode Input parameter used by this function.
     * @returns {any} Result produced by this function.
     * @throws {Error} May throw runtime errors from DOM, network, or dependency operations.
     * Edge cases: Null, undefined, and empty inputs are handled by the existing implementation.
     */
    /**
     * Executes the setSalesMode function.
     * @param {*} mode Input parameter used by this function.
     * @returns {any} Result produced by this function.
     * @throws {Error} May throw runtime errors from DOM, network, or dependency operations.
     * Edge cases: Null, undefined, and empty inputs are handled by the existing implementation.
     */
        document.getElementById("salesModeDaily").classList.remove("bg-white","shadow-sm","border","border-slate-200");
        document.getElementById("salesModeDaily").classList.add("text-slate-600");
      } else {
        lineChart.data.labels = dailyLabels;
        lineChart.data.datasets[0].data = dailySales;
        document.getElementById("salesModeDaily").classList.add("bg-white","shadow-sm","border","border-slate-200");
        document.getElementById("salesModeDaily").classList.remove("text-slate-600");
        document.getElementById("salesModeMonthly").classList.remove("bg-white","shadow-sm","border","border-slate-200");
        document.getElementById("salesModeMonthly").classList.add("text-slate-600");
      }
      lineChart.update();
    }

    document.getElementById("salesModeDaily")?.addEventListener("click", () => setSalesMode("daily"));
    document.getElementById("salesModeMonthly")?.addEventListener("click", () => setSalesMode("monthly"));

    const paymentCtx = document.getElementById("paymentStackChart");
    if (paymentCtx) {
      new Chart(paymentCtx, {
        type: "bar",
        data: {
          labels: paymentLabels,
          datasets: [
            { label: "Cash", data: paymentCash, backgroundColor: "#0f172a" },
            { label: "Card", data: paymentCard, backgroundColor: "#334155" },
            { label: "QR", data: paymentQr, backgroundColor: "#94a3b8" }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            tooltip: { callbacks: { label: (ctx) => `${ctx.dataset.label}: ${formatMoney(ctx.parsed.y)}` } }
          },
          scales: {
            x: { stacked: true, grid: { display: false } },
            y: { stacked: true, grid: { color: "rgba(148,163,184,0.35)" } }
          }
        }
      });
    }

    const topCtx = document.getElementById("topBarChart");
    const topChart = topCtx ? new Chart(topCtx, {
      type: "bar",
      data: {
        labels: topProductLabels,
        datasets: [{
          label: "Revenue",
          data: topProductValues,
          backgroundColor: "#0f172a"
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: { callbacks: { label: (ctx) => formatMoney(ctx.parsed.y) } }
        },
        scales: {
          x: { grid: { display: false } },
          y: { grid: { color: "rgba(148,163,184,0.35)" } }
        }
      }
    }) : null;

    /**
     * Executes the setTopMode function.
     * @param {*} mode Input parameter used by this function.
     * @returns {any} Result produced by this function.
     * @throws {Error} May throw runtime errors from DOM, network, or dependency operations.
     * Edge cases: Null, undefined, and empty inputs are handled by the existing implementation.
     */
    function setTopMode(mode) {
      if (!topChart) return;
      if (mode === "categories") {
        topChart.data.labels = topCategoryLabels;
        topChart.data.datasets[0].data = topCategoryValues;
        document.getElementById("topModeCategories").classList.add("bg-white","shadow-sm","border","border-slate-200");
        document.getElementById("topModeCategories").classList.remove("text-slate-600");
    /**
     * Executes the setTopMode function.
     * @param {*} mode Input parameter used by this function.
     * @returns {any} Result produced by this function.
     * @throws {Error} May throw runtime errors from DOM, network, or dependency operations.
     * Edge cases: Null, undefined, and empty inputs are handled by the existing implementation.
     */
    /**
     * Executes the setTopMode function.
     * @param {*} mode Input parameter used by this function.
     * @returns {any} Result produced by this function.
     * @throws {Error} May throw runtime errors from DOM, network, or dependency operations.
     * Edge cases: Null, undefined, and empty inputs are handled by the existing implementation.
     */
        document.getElementById("topModeProducts").classList.remove("bg-white","shadow-sm","border","border-slate-200");
        document.getElementById("topModeProducts").classList.add("text-slate-600");
      } else {
        topChart.data.labels = topProductLabels;
        topChart.data.datasets[0].data = topProductValues;
        document.getElementById("topModeProducts").classList.add("bg-white","shadow-sm","border","border-slate-200");
        document.getElementById("topModeProducts").classList.remove("text-slate-600");
        document.getElementById("topModeCategories").classList.remove("bg-white","shadow-sm","border","border-slate-200");
        document.getElementById("topModeCategories").classList.add("text-slate-600");
      }
      topChart.update();
    }

    document.getElementById("topModeProducts")?.addEventListener("click", () => setTopMode("products"));
    document.getElementById("topModeCategories")?.addEventListener("click", () => setTopMode("categories"));

    const donutCtx = document.getElementById("revenueDonutChart");
    if (donutCtx) {
      new Chart(donutCtx, {
        type: "doughnut",
        data: {
          labels: revenueShareLabels,
          datasets: [{
            data: revenueShareValues,
            backgroundColor: ["#0f172a", "#334155", "#64748b", "#94a3b8", "#cbd5f5", "#e2e8f0"]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: "bottom" },
            tooltip: { callbacks: { label: (ctx) => `${ctx.label}: ${formatMoney(ctx.parsed)}` } }
          }
        }
      });
    }
  </script>

  <!-- Enterpriseâ€‘grade language switcher (embedded) -->
  <script>
    (function(global) {
      'use strict';

      const DEFAULTS = {
        selectSelector: '[data-lang-switcher-select="true"]',
        formSelector: '[data-lang-switcher-form="true"]',
        preserveInputSelector: 'input[data-lang-preserve="true"]',
        urlParam: 'lang',
        method: 'auto',
        usePushState: false,
        preserveQueryParams: true,
        logLevel: 'error',
        ariaLive: 'polite',
      };

      const LOG_LEVELS = { debug: 0, info: 1, warn: 2, error: 3, none: 4 };
      class Logger {
        constructor(level = 'error') {
          this.level = LOG_LEVELS[level] ?? LOG_LEVELS.error;
        }
        debug(...args) { if (this.level <= LOG_LEVELS.debug) console.debug('[LangSwitcher]', ...args); }
        info(...args)  { if (this.level <= LOG_LEVELS.info)  console.info('[LangSwitcher]', ...args); }
        warn(...args)  { if (this.level <= LOG_LEVELS.warn)  console.warn('[LangSwitcher]', ...args); }
        error(...args) { if (this.level <= LOG_LEVELS.error) console.error('[LangSwitcher]', ...args); }
      }

      class LangSwitcher {
        constructor(options = {}) {
          this.options = { ...DEFAULTS, ...options };
          this.logger = new Logger(this.options.logLevel);
          this.boundSelects = new WeakSet();
          this.changeHandler = this.handleChange.bind(this);
          this.init();
        }

        init() {
          try {
            document.addEventListener('change', this.changeHandler);
            this.scanExisting();
            this.logger.debug('LangSwitcher initialised');
          } catch (err) {
            this.logger.error('Initialisation failed:', err);
          }
        }

        scanExisting() {
          const selects = document.querySelectorAll(this.options.selectSelector);
          selects.forEach(select => {
            if (!this.boundSelects.has(select)) {
              this.prepareForm(select);
              this.boundSelects.add(select);
            }
          });
        }

        prepareForm(select) {
          if (!this.options.preserveQueryParams) return;
          const form = select.closest(this.options.formSelector);
          if (!form) return;

          const oldInputs = form.querySelectorAll(this.options.preserveInputSelector);
          oldInputs.forEach(input => input.remove());

          try {
            const url = new URL(window.location.href);
            for (const [key, value] of url.searchParams.entries()) {
              if (key === this.options.urlParam) continue;
              const hidden = document.createElement('input');
              hidden.type = 'hidden';
              hidden.name = key;
              hidden.value = value;
              hidden.setAttribute('data-lang-preserve', 'true');
              form.appendChild(hidden);
            }
            this.logger.debug('Preserved query params added to form', form);
          } catch (err) {
            this.logger.error('Failed to preserve query params:', err);
          }
        }

        handleChange(event) {
          const select = event.target;
          if (!select.matches(this.options.selectSelector)) return;

          if (!this.boundSelects.has(select)) {
            this.prepareForm(select);
            this.boundSelects.add(select);
          }

          try {
            this.execute(select);
          } catch (err) {
            this.logger.error('Error during language switch:', err);
          }
        }

        execute(select) {
          const form = select.closest(this.options.formSelector);
          const method = this.resolveMethod(select, form);
          const lang = select.value.trim();

          if (!lang) {
            this.logger.warn('No language value selected');
            return;
          }

          this.announce(lang);

          if (method === 'form' && form) {
            form.submit();
            this.logger.debug('Form submitted', form);
          } else if (method === 'redirect') {
            this.redirect(lang);
          } else {
            this.logger.warn('No valid method (form or redirect) available');
          }
        }

        resolveMethod(select, form) {
          const methodAttr = select.dataset.langMethod || this.options.method;
          if (methodAttr === 'form') return 'form';
          if (methodAttr === 'redirect') return 'redirect';
          return form ? 'form' : 'redirect';
        }

        redirect(lang) {
          try {
            const url = new URL(window.location.href);
            url.searchParams.set(this.options.urlParam, lang);

            if (this.options.usePushState) {
              history.pushState(null, '', url.toString());
              window.dispatchEvent(new CustomEvent('langswitcher:changed', { detail: { lang } }));
              this.logger.debug('History state updated', url.toString());
            } else {
              window.location.assign(url.toString());
              this.logger.debug('Redirecting to', url.toString());
            }
          } catch (err) {
            this.logger.error('Redirect failed:', err);
          }
        }

        announce(lang) {
          const liveRegion = document.querySelector('[aria-live="polite"], [aria-live="assertive"]');
          if (liveRegion && this.options.ariaLive !== 'none') {
            liveRegion.textContent = `Language changed to ${lang}`;
          }
        }

        destroy() {
          document.removeEventListener('change', this.changeHandler);
          this.logger.debug('LangSwitcher destroyed');
        }
      }

      global.LangSwitcher = LangSwitcher;

      /**
       * Executes the autoInit function.
       * @returns {any} Result produced by this function.
       * @throws {Error} May throw runtime errors from DOM, network, or dependency operations.
       * Edge cases: Null, undefined, and empty inputs are handled by the existing implementation.
       */
      function autoInit() {
        if (document.documentElement.hasAttribute('data-lang-switcher-auto')) {
          new LangSwitcher();
        }
      }

      /**
       * Executes the autoInit function.
       * @returns {any} Result produced by this function.
       * @throws {Error} May throw runtime errors from DOM, network, or dependency operations.
       * Edge cases: Null, undefined, and empty inputs are handled by the existing implementation.
       */
      /**
       * Executes the autoInit function.
       * @returns {any} Result produced by this function.
       * @throws {Error} May throw runtime errors from DOM, network, or dependency operations.
       * Edge cases: Null, undefined, and empty inputs are handled by the existing implementation.
       */
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', autoInit, { once: true });
      } else {
        autoInit();
      }
    })(typeof window !== 'undefined' ? window : this);
  </script>
</body>
</html>