<!doctype html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sales</title>
  <link rel="stylesheet" th:href="@{/css/app.css}" href="/css/app.css">
  <style>
    .sales-table-compact th,
    .sales-table-compact td {
      padding-top: 0.5rem;
      padding-bottom: 0.5rem;
    }
  </style>
</head>

<body class="bg-slate-100 text-slate-900">
  <div class="min-h-screen">
    <!-- Top bar -->
    <header class="bg-white/80 backdrop-blur border-b border-slate-200 sticky top-0 z-40">
      <div class="w-full px-6 lg:px-10 py-5">
        <div class="grid grid-cols-[auto_1fr_auto] items-center gap-4">
          <div class="flex items-center gap-3">
          <div class="h-10 w-10 rounded-xl bg-slate-900 text-white grid place-items-center shadow-sm">
            <!-- receipt icon -->
            <svg viewBox="0 0 24 24" class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M7 3h10v18l-2-1-2 1-2-1-2 1-2-1-2 1V3z"/>
              <path d="M9 7h6M9 11h6M9 15h4"/>
            </svg>
          </div>
          <div>
            <div class="text-xl sm:text-2xl font-bold leading-tight">Sales</div>
            <div class="text-sm text-slate-500">Recent transactions</div>
          </div>
          </div>

                    <nav th:replace="~{fragments/navigation :: mainNav}"></nav>

          <div class="flex flex-wrap items-center justify-end gap-2">
            <a sec:authorize="isAnonymous()" href="/login"
               class="rounded-xl border border-slate-200 px-4 py-2 bg-white hover:bg-slate-50 transition">
              Login
            </a>
            <form sec:authorize="isAuthenticated()" action="/logout" method="post" class="m-0">
              <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
              <button class="rounded-xl border border-slate-200 px-4 py-2 bg-white hover:bg-slate-50 transition">
                Logout
              </button>
            </form>
          </div>
        </div>
      </div>
    </header>

    <main class="w-full px-6 lg:px-10 py-8">
      <div class="mb-6 flex flex-wrap items-center justify-between gap-3">
        <div class="text-sm text-slate-500">
          Review, export, and manage transaction history.
        </div>
        <div class="flex flex-wrap items-center gap-2">
          <button id="toggleDensity" type="button"
                  class="rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm font-medium hover:bg-slate-50 transition">
            Compact rows
          </button>
          <a href="/"
             class="rounded-xl bg-slate-900 px-4 py-2 font-semibold text-white hover:bg-slate-800 transition">
            Open POS
          </a>
        </div>
      </div>

      <div th:if="${successMessage}"
           class="mb-6 rounded-2xl border border-emerald-200 bg-emerald-50 px-5 py-4 text-sm text-emerald-900">
        <div class="font-semibold">Success</div>
        <div class="mt-1" th:text="${successMessage}">Sale updated.</div>
      </div>
      <div th:if="${errorMessage}"
           class="mb-6 rounded-2xl border border-rose-200 bg-rose-50 px-5 py-4 text-sm text-rose-900">
        <div class="font-semibold">Action needed</div>
        <div class="mt-1" th:text="${errorMessage}">Could not update sale.</div>
      </div>

      <!-- Filters -->
      <form method="get" action="/sales" class="mb-6 bg-white rounded-2xl border border-slate-200 shadow-sm">
        <div class="p-5">
          <div class="flex items-start justify-between gap-4 flex-col md:flex-row">
            <div>
              <div class="text-base font-semibold">Filters</div>
              <div class="text-sm text-slate-500">Search and narrow your sales history</div>
            </div>
            <div class="flex flex-wrap gap-2">
              <button class="rounded-xl bg-slate-900 text-white px-4 py-2 text-sm font-semibold hover:bg-slate-800 transition">
                Filter
              </button>
              <a href="/sales" class="rounded-xl border border-slate-200 px-4 py-2 bg-white text-sm font-medium hover:bg-slate-50 transition">
                Reset
              </a>
              <button id="clearSearch" type="button"
                      class="rounded-xl border border-slate-200 px-4 py-2 bg-white text-sm font-medium hover:bg-slate-50 transition">
                Clear search
              </button>
              <button type="button" onclick="window.print()"
                      class="rounded-xl border border-slate-200 px-4 py-2 bg-white text-sm font-medium hover:bg-slate-50 transition">
                Export PDF
              </button>
              <a th:href="@{/sales/export(q=${q}, method=${method}, status=${status}, cashier=${cashier}, customer=${customer}, minTotal=${minTotal}, maxTotal=${maxTotal}, from=${from}, to=${to}, sort=${sort})}"
                 class="rounded-xl border border-slate-200 px-4 py-2 bg-white text-sm font-medium hover:bg-slate-50 transition">
                Export CSV
              </a>
            </div>
          </div>

          <div class="mt-4 flex flex-wrap items-center gap-2 text-xs">
            <span class="text-slate-500 font-semibold">Quick range:</span>
            <button type="button" data-date-range="today"
                    class="rounded-lg border border-slate-200 bg-white px-3 py-1.5 font-semibold text-slate-700 hover:bg-slate-50 transition">
              Today
            </button>
            <button type="button" data-date-range="7"
                    class="rounded-lg border border-slate-200 bg-white px-3 py-1.5 font-semibold text-slate-700 hover:bg-slate-50 transition">
              Last 7 days
            </button>
            <button type="button" data-date-range="30"
                    class="rounded-lg border border-slate-200 bg-white px-3 py-1.5 font-semibold text-slate-700 hover:bg-slate-50 transition">
              Last 30 days
            </button>
            <button type="button" data-date-range="month"
                    class="rounded-lg border border-slate-200 bg-white px-3 py-1.5 font-semibold text-slate-700 hover:bg-slate-50 transition">
              Month to date
            </button>
          </div>

          <div class="mt-4 grid grid-cols-1 md:grid-cols-6 gap-3">
            <!-- Same logic -->
            <div class="md:col-span-2">
              <label class="block text-xs font-medium text-slate-600 mb-1">Search</label>
              <input id="salesSearchInput" name="q" placeholder="Search receipt ID, product, cashier"
                     class="w-full rounded-xl border border-slate-200 px-3 py-2.5 bg-white focus:outline-none focus:ring-2 focus:ring-slate-300"
                     th:value="${q}">
            </div>

            <div class="md:col-span-2">
              <label class="block text-xs font-medium text-slate-600 mb-1">Customer</label>
              <input name="customer" placeholder="Name, phone, email"
                     class="w-full rounded-xl border border-slate-200 px-3 py-2.5 bg-white focus:outline-none focus:ring-2 focus:ring-slate-300"
                     th:value="${customer}">
            </div>

            <div>
              <label class="block text-xs font-medium text-slate-600 mb-1">Cashier</label>
              <input name="cashier" placeholder="Username"
                     class="w-full rounded-xl border border-slate-200 px-3 py-2.5 bg-white focus:outline-none focus:ring-2 focus:ring-slate-300"
                     th:value="${cashier}">
            </div>

            <div>
              <label class="block text-xs font-medium text-slate-600 mb-1">Status</label>
              <select name="status"
                      class="w-full rounded-xl border border-slate-200 px-3 py-2.5 bg-white focus:outline-none focus:ring-2 focus:ring-slate-300">
                <option value="">All Statuses</option>
                <option th:each="st : ${T(com.example.pos_system.entity.SaleStatus).values()}"
                        th:value="${st}"
                        th:selected="${status == st}"
                        th:text="${st}">PAID</option>
              </select>
            </div>

            <div>
              <label class="block text-xs font-medium text-slate-600 mb-1">From</label>
              <input id="salesFromDate" type="date" name="from"
                     class="w-full rounded-xl border border-slate-200 px-3 py-2.5 bg-white focus:outline-none focus:ring-2 focus:ring-slate-300"
                     th:value="${from}">
            </div>

            <div>
              <label class="block text-xs font-medium text-slate-600 mb-1">To</label>
              <input id="salesToDate" type="date" name="to"
                     class="w-full rounded-xl border border-slate-200 px-3 py-2.5 bg-white focus:outline-none focus:ring-2 focus:ring-slate-300"
                     th:value="${to}">
            </div>

            <div>
              <label class="block text-xs font-medium text-slate-600 mb-1">Method</label>
              <select name="method"
                      class="w-full rounded-xl border border-slate-200 px-3 py-2.5 bg-white focus:outline-none focus:ring-2 focus:ring-slate-300">
                <option value="">All Methods</option>
                <option th:each="m : ${T(com.example.pos_system.entity.PaymentMethod).values()}"
                        th:value="${m}"
                        th:selected="${method == m}"
                        th:text="${m}">CASH</option>
              </select>
            </div>

            <div>
              <label class="block text-xs font-medium text-slate-600 mb-1">Min Total</label>
              <input type="number" step="0.01" name="minTotal"
                     class="w-full rounded-xl border border-slate-200 px-3 py-2.5 bg-white focus:outline-none focus:ring-2 focus:ring-slate-300"
                     th:value="${minTotal}">
            </div>
            <div>
              <label class="block text-xs font-medium text-slate-600 mb-1">Max Total</label>
              <input type="number" step="0.01" name="maxTotal"
                     class="w-full rounded-xl border border-slate-200 px-3 py-2.5 bg-white focus:outline-none focus:ring-2 focus:ring-slate-300"
                     th:value="${maxTotal}">
            </div>

            <div>
              <label class="block text-xs font-medium text-slate-600 mb-1">Sort</label>
              <select name="sort"
                      class="w-full rounded-xl border border-slate-200 px-3 py-2.5 bg-white focus:outline-none focus:ring-2 focus:ring-slate-300">
                <option value="dateDesc" th:selected="${sort == null or sort == 'dateDesc'}">Date (newest)</option>
                <option value="dateAsc" th:selected="${sort == 'dateAsc'}">Date (oldest)</option>
                <option value="totalDesc" th:selected="${sort == 'totalDesc'}">Total (high to low)</option>
                <option value="totalAsc" th:selected="${sort == 'totalAsc'}">Total (low to high)</option>
                <option value="idDesc" th:selected="${sort == 'idDesc'}">ID (high to low)</option>
                <option value="idAsc" th:selected="${sort == 'idAsc'}">ID (low to high)</option>
                <option value="cashierAsc" th:selected="${sort == 'cashierAsc'}">Cashier (A-Z)</option>
                <option value="customerAsc" th:selected="${sort == 'customerAsc'}">Customer (A-Z)</option>
                <option value="statusAsc" th:selected="${sort == 'statusAsc'}">Status (A-Z)</option>
              </select>
            </div>
          </div>
        </div>
      </form>

      <form id="bulkForm" method="post" action="/sales/bulk" class="hidden">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
        <input type="hidden" name="action" id="bulkActionInput">
        <input type="hidden" name="redirect"
               th:value="@{/sales(page=${page}, q=${q}, method=${method}, status=${status}, cashier=${cashier}, customer=${customer}, minTotal=${minTotal}, maxTotal=${maxTotal}, from=${from}, to=${to}, sort=${sort})}">
        <div id="bulkIds"></div>
      </form>

      <div class="mb-6 rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div>
            <div class="text-sm font-semibold text-slate-800">Bulk actions</div>
            <div class="text-xs text-slate-500">
              Selected: <span id="bulkSelected">0</span>
            </div>
          </div>
          <div class="flex flex-wrap items-center gap-2">
            <select id="bulkAction" class="rounded-xl border border-slate-200 px-3 py-2 text-sm bg-white">
              <option value="">Choose action</option>
              <option value="void">Void selected</option>
              <option value="export">Export CSV</option>
              <option value="print">Print receipts</option>
            </select>
            <button type="button" id="bulkApply"
                    class="rounded-xl bg-slate-900 text-white px-4 py-2 text-sm font-semibold hover:bg-slate-800 transition">
              Apply
            </button>
          </div>
        </div>
      </div>

      <!-- Summary -->
      <div class="mb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm">
          <div class="text-xs uppercase tracking-wide text-slate-500">Today</div>
          <div class="mt-2 text-2xl font-semibold text-slate-900" th:text="${@uiFormat.money(summaryToday.total)}">$0.00</div>
          <div class="mt-1 text-xs text-slate-500">
            <span th:text="${summaryToday.count}">0</span> sale(s)
          </div>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm">
          <div class="text-xs uppercase tracking-wide text-slate-500">This Week</div>
          <div class="mt-2 text-2xl font-semibold text-slate-900" th:text="${@uiFormat.money(summaryWeek.total)}">$0.00</div>
          <div class="mt-1 text-xs text-slate-500">
            <span th:text="${summaryWeek.count}">0</span> sale(s)
          </div>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm">
          <div class="text-xs uppercase tracking-wide text-slate-500">This Month</div>
          <div class="mt-2 text-2xl font-semibold text-slate-900" th:text="${@uiFormat.money(summaryMonth.total)}">$0.00</div>
          <div class="mt-1 text-xs text-slate-500">
            <span th:text="${summaryMonth.count}">0</span> sale(s)
          </div>
        </div>
      </div>

      <div class="mb-6 grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-5 gap-4">
        <div class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
          <div class="text-xs uppercase tracking-wide text-slate-500">Filtered Sales</div>
          <div class="mt-2 text-2xl font-semibold text-slate-900" th:text="${filteredSnapshot.count}">0</div>
          <div class="mt-1 text-xs text-slate-500">Results after filters</div>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
          <div class="text-xs uppercase tracking-wide text-slate-500">Gross Total</div>
          <div class="mt-2 text-2xl font-semibold text-slate-900" th:text="${@uiFormat.money(filteredSnapshot.gross)}">$0.00</div>
          <div class="mt-1 text-xs text-slate-500">Before refunds</div>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
          <div class="text-xs uppercase tracking-wide text-slate-500">Net Total</div>
          <div class="mt-2 text-2xl font-semibold text-slate-900" th:text="${@uiFormat.money(filteredSnapshot.net)}">$0.00</div>
          <div class="mt-1 text-xs text-slate-500">Excluding voided sales</div>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
          <div class="text-xs uppercase tracking-wide text-slate-500">Refunded</div>
          <div class="mt-2 text-2xl font-semibold text-slate-900" th:text="${@uiFormat.money(filteredSnapshot.refunded)}">$0.00</div>
          <div class="mt-1 text-xs text-slate-500">
            Voided: <span th:text="${filteredSnapshot.voidCount}">0</span>
          </div>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
          <div class="text-xs uppercase tracking-wide text-slate-500">Avg Ticket</div>
          <div class="mt-2 text-2xl font-semibold text-slate-900" th:text="${@uiFormat.money(filteredSnapshot.avgTicket)}">$0.00</div>
          <div class="mt-1 text-xs text-slate-500">Per non-void sale</div>
        </div>
      </div>

      <!-- Table -->
      <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
        <div class="px-5 py-4 border-b border-slate-200 flex items-center justify-between">
          <div>
            <div class="text-base font-semibold">Sales list</div>
            <div class="text-sm text-slate-500">
              Expand a row to see items
              <span th:text="${'· Showing ' + (sales.size() > 0 ? (page * 20 + 1) : 0) + '-' + (page * 20 + sales.size()) + ' of ' + filteredSnapshot.count}">· Showing 0-0 of 0</span>
            </div>
          </div>
          <div class="text-xs text-slate-500">Sort: <span th:text="${sort ?: 'dateDesc'}">dateDesc</span></div>
        </div>

        <div class="overflow-x-auto" id="salesTableWrap">
          <table id="salesTable" class="w-full text-sm">
            <thead class="bg-slate-50 text-left text-slate-600">
              <tr>
                <th class="px-5 py-3 font-semibold">
                  <input type="checkbox" id="selectAll"
                         class="h-4 w-4 rounded border-slate-300 text-slate-900 focus:ring-slate-300">
                </th>
                <th class="px-5 py-3 font-semibold">ID</th>
                <th class="px-5 py-3 font-semibold">Date</th>
                <th class="px-5 py-3 font-semibold">Customer</th>
                <th class="px-5 py-3 font-semibold">Cashier</th>
                <th class="px-5 py-3 font-semibold">Payment</th>
                <th class="px-5 py-3 font-semibold">Status</th>
                <th class="px-5 py-3 font-semibold">Profit</th>
                <th class="px-5 py-3 font-semibold">Total</th>
                <th class="px-5 py-3 font-semibold">Items</th>
                <th class="px-5 py-3 font-semibold text-right">Action</th>
              </tr>
            </thead>

            <tbody class="divide-y divide-slate-100">
              <tr th:if="${#lists.isEmpty(sales)}">
                <td class="px-5 py-6 text-slate-500" colspan="11">No sales yet.</td>
              </tr>

              <th:block th:each="s : ${sales}" th:with="profit=${profitById[s.id]}, customerSummary=${customerSummaryById[s.id]}">
              <tr class="hover:bg-slate-50/70 transition">
                <td class="px-5 py-4">
                  <input type="checkbox" class="sale-checkbox h-4 w-4 rounded border-slate-300 text-slate-900 focus:ring-slate-300"
                         th:attr="data-sale-id=${s.id}">
                </td>
                <td class="px-5 py-4 font-medium text-slate-900" th:text="${s.id}">1</td>
                <td class="px-5 py-4 text-slate-700" th:text="${@uiFormat.dateTime(s.createdAt)}">2026-02-04</td>
                <td class="px-5 py-4 text-slate-700">
                  <div class="font-semibold text-slate-900" th:text="${s.customer != null ? s.customer.name : 'Walk-in'}">Walk-in</div>
                  <div class="text-xs text-slate-500" th:if="${s.customer != null and s.customer.phone != null}"
                       th:text="${s.customer.phone}">phone</div>
                </td>
                <td class="px-5 py-4 text-slate-700" th:text="${s.cashierUsername ?: '—'}">cashier</td>
                <td class="px-5 py-4 text-slate-700">
                  <div class="flex flex-wrap gap-1">
                    <span th:if="${s.payments == null or #lists.isEmpty(s.payments)}"
                          class="inline-flex items-center gap-2 rounded-full bg-slate-100 px-2.5 py-1 text-xs font-semibold text-slate-700">
                      <span th:text="${s.paymentMethod}">CASH</span>
                      <span class="text-slate-400" th:text="${@uiFormat.money(s.total)}">$0.00</span>
                    </span>
                    <span th:each="p : ${s.payments}"
                          class="inline-flex items-center gap-2 rounded-full bg-slate-100 px-2.5 py-1 text-xs font-semibold text-slate-700">
                      <span th:text="${p.method}">CASH</span>
                      <span class="text-slate-400" th:text="${@uiFormat.money(p.amount)}">$0.00</span>
                    </span>
                  </div>
                </td>

                <!-- Optional badge styling without changing logic -->
                <td class="px-5 py-4">
                  <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold"
                        th:classappend="${s.status != null and s.status.name() == 'VOID'} ? ' bg-rose-100 text-rose-700' : (${s.status != null and s.status.name() != 'PAID'} ? ' bg-amber-100 text-amber-700' : ' bg-emerald-100 text-emerald-700')"
                        th:text="${s.status}">PAID</span>
                </td>

                <td class="px-5 py-4">
                  <div th:if="${profit != null}">
                    <div class="font-semibold text-slate-900" th:text="${@uiFormat.money(profit.profit)}">$0.00</div>
                    <div class="text-xs text-slate-500"
                         th:text="${#numbers.formatDecimal(profit.marginPct, 1, 2)} + '%'">0%</div>
                    <div class="text-xs text-amber-600" th:if="${profit.missingCost}">Cost missing</div>
                  </div>
                  <div th:if="${profit == null}" class="text-slate-400">—</div>
                </td>

                <td class="px-5 py-4">
                  <div class="font-semibold text-slate-900" th:text="${@uiFormat.money(s.total)}">0.00</div>
                  <div class="text-xs text-amber-600" th:if="${s.refundedTotal != null and s.refundedTotal > 0}">
                    Refunded: <span th:text="${@uiFormat.money(s.refundedTotal)}">$0.00</span>
                  </div>
                </td>
                <td class="px-5 py-4">
                  <button type="button"
                          class="inline-flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-3 py-2 text-xs font-semibold text-slate-700 hover:bg-slate-50 transition"
                          th:attr="data-toggle-details=${s.id}" aria-expanded="false">
                    Items
                    <span class="rounded-full bg-slate-100 px-2 py-0.5 text-[10px] font-semibold text-slate-600"
                          th:text="${s.items.size()}">0</span>
                  </button>
                </td>
                <td class="px-5 py-4 text-right">
                  <div class="flex items-center justify-end gap-2">
                    <a th:href="@{'/sales/' + ${s.id} + '/receipt'}"
                       class="inline-flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-medium text-slate-800 hover:bg-slate-50 transition">
                      Receipt
                      <svg viewBox="0 0 24 24" class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 18l6-6-6-6"/>
                      </svg>
                    </a>
                    <a th:href="@{'/sales/' + ${s.id} + '/receipt?print=1'}" target="_blank"
                       class="inline-flex items-center rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-medium text-slate-700 hover:bg-slate-50 transition">
                      Reprint
                    </a>
                    <a th:href="@{'/sales/' + ${s.id} + '/receipt/pdf'}"
                       class="inline-flex items-center rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-medium text-slate-700 hover:bg-slate-50 transition">
                      PDF
                    </a>
                    <a th:if="${s.status != null and s.status.name() != 'VOID' and s.status.name() != 'RETURNED'}"
                       th:href="@{'/sales/' + ${s.id} + '/return'}"
                       class="inline-flex items-center rounded-xl border border-amber-200 bg-amber-50 px-3 py-2 text-sm font-semibold text-amber-800 hover:bg-amber-100 transition">
                      Return
                    </a>
                    <form th:if="${s.status == null or s.status.name() != 'VOID'}"
                          method="post" th:action="@{'/sales/' + ${s.id} + '/void'}" class="m-0">
                      <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                      <input type="hidden" name="redirect"
                             th:value="@{/sales(page=${page}, q=${q}, method=${method}, status=${status}, cashier=${cashier}, customer=${customer}, minTotal=${minTotal}, maxTotal=${maxTotal}, from=${from}, to=${to}, sort=${sort})}">
                      <button type="submit"
                              th:onclick="'return confirm(\'Void sale #' + ${s.id} + '?\')'"
                              class="inline-flex items-center rounded-xl border border-rose-200 bg-rose-50 px-3 py-2 text-sm font-semibold text-rose-700 hover:bg-rose-100 transition">
                        Void
                      </button>
                    </form>
                  </div>
                </td>
              </tr>

              <tr class="hidden bg-slate-50/40" th:attr="data-details-row=${s.id}">
                <td class="px-5 py-4" colspan="11">
                  <div class="rounded-xl border border-slate-200 bg-white p-4">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                      <div class="lg:col-span-2">
                        <div class="flex items-center justify-between text-xs text-slate-500">
                          <span class="font-semibold text-slate-700">Items</span>
                          <span th:text="${s.items.size() + ' item(s)'}">0 item(s)</span>
                        </div>
                        <div class="mt-3 space-y-2">
                          <div th:if="${#lists.isEmpty(s.items)}" class="text-sm text-slate-500">No items recorded.</div>
                          <div th:each="it : ${s.items}" class="flex items-center justify-between gap-4 text-sm">
                            <div class="min-w-0">
                              <div class="font-semibold text-slate-900 truncate" th:text="${it.product.name}">Product</div>
                              <div class="text-xs text-slate-500"
                                   th:text="${it.qty + ' ' + @uiFormat.unitLabel(it.unitType) + ' × ' + @uiFormat.money(it.unitPrice)}">1 × $0.00</div>
                              <div class="mt-0.5 text-[11px] text-slate-400"
                                   th:if="${it.unitType != null and it.unitType.name() != 'PIECE'}"
                                   th:text="${'Unit size: ' + it.unitSize + ' pcs/' + @uiFormat.unitLabel(it.unitType)}">Unit size</div>
                              <div class="mt-0.5 text-xs text-slate-400"
                                   th:if="${it.priceTier != null and it.priceTier.name() == 'WHOLESALE'}">
                                Wholesale price
                              </div>
                              <div class="mt-0.5 text-xs text-amber-600"
                                   th:if="${it.returnedQty != null and it.returnedQty > 0}"
                                   th:text="${'Returned: ' + it.returnedQty}">Returned</div>
                              <div class="mt-0.5 text-xs text-slate-500"
                                   th:if="${it.note != null and !#strings.isEmpty(it.note)}"
                                   th:text="${'Note: ' + it.note}">Note</div>
                            </div>
                            <div class="shrink-0 font-semibold text-slate-900" th:text="${@uiFormat.money(it.lineTotal)}">$0.00</div>
                          </div>
                        </div>

                        <div class="mt-4 rounded-xl border border-slate-200 bg-slate-50 px-4 py-3">
                          <div class="text-xs font-semibold text-slate-700 mb-2">Timeline</div>
                          <ul class="space-y-2 text-xs text-slate-600">
                            <li class="flex items-center justify-between">
                              <span>Sale created</span>
                              <span th:text="${@uiFormat.dateTime(s.createdAt)}">—</span>
                            </li>
                            <li th:if="${s.status != null and s.status.name() == 'VOID'}"
                                class="flex items-center justify-between text-rose-700">
                              <span>Sale voided</span>
                              <span>—</span>
                            </li>
                            <li th:if="${s.status != null and s.status.name() == 'PARTIALLY_RETURNED'}"
                                class="flex items-center justify-between text-amber-700">
                              <span>Partial return processed</span>
                              <span>—</span>
                            </li>
                            <li th:if="${s.status != null and s.status.name() == 'RETURNED'}"
                                class="flex items-center justify-between text-amber-700">
                              <span>Full return processed</span>
                              <span>—</span>
                            </li>
                            <li th:if="${s.refundedTotal != null and s.refundedTotal > 0}"
                                class="flex items-center justify-between text-amber-700">
                              <span>Refunded total</span>
                              <span th:text="${@uiFormat.money(s.refundedTotal)}">$0.00</span>
                            </li>
                          </ul>
                        </div>
                      </div>

                      <div class="space-y-4">
                        <div class="rounded-xl border border-slate-200 bg-white p-4">
                          <div class="text-xs font-semibold text-slate-700">Customer summary</div>
                          <div th:if="${customerSummary != null}" class="mt-2 text-sm text-slate-700">
                            <div class="font-semibold text-slate-900" th:text="${customerSummary.customer.name}">Customer</div>
                            <div class="text-xs text-slate-500" th:if="${customerSummary.customer.phone != null}"
                                 th:text="${customerSummary.customer.phone}">phone</div>
                            <div class="mt-2 grid grid-cols-2 gap-2 text-xs">
                              <div class="rounded-lg bg-slate-50 p-2">
                                <div class="text-slate-500">Visits</div>
                                <div class="font-semibold text-slate-900" th:text="${customerSummary.visits}">0</div>
                              </div>
                              <div class="rounded-lg bg-slate-50 p-2">
                                <div class="text-slate-500">Points</div>
                                <div class="font-semibold text-slate-900" th:text="${customerSummary.customer.points != null ? customerSummary.customer.points : 0}">0</div>
                              </div>
                              <div class="rounded-lg bg-slate-50 p-2 col-span-2">
                                <div class="text-slate-500">Lifetime spend</div>
                                <div class="font-semibold text-slate-900" th:text="${@uiFormat.money(customerSummary.lifetimeSpend)}">$0.00</div>
                              </div>
                              <div class="rounded-lg bg-slate-50 p-2 col-span-2">
                                <div class="text-slate-500">Last purchase</div>
                                <div class="font-semibold text-slate-900"
                                     th:text="${customerSummary.lastPurchase != null ? @uiFormat.dateTime(customerSummary.lastPurchase) : '-'}">-</div>
                              </div>
                            </div>
                          </div>
                          <div th:if="${customerSummary == null}" class="mt-2 text-xs text-slate-500">
                            Walk-in customer.
                          </div>
                        </div>

                        <div class="rounded-xl border border-slate-200 bg-white p-4">
                          <div class="text-xs font-semibold text-slate-700">Payment breakdown</div>
                          <div class="mt-2 flex flex-wrap gap-2">
                            <span th:if="${s.payments == null or #lists.isEmpty(s.payments)}"
                                  class="inline-flex items-center gap-2 rounded-full bg-slate-100 px-2.5 py-1 text-xs font-semibold text-slate-700">
                              <span th:text="${s.paymentMethod}">CASH</span>
                              <span class="text-slate-400" th:text="${@uiFormat.money(s.total)}">$0.00</span>
                            </span>
                            <span th:each="p : ${s.payments}"
                                  class="inline-flex items-center gap-2 rounded-full bg-slate-100 px-2.5 py-1 text-xs font-semibold text-slate-700">
                              <span th:text="${p.method}">CASH</span>
                              <span class="text-slate-400" th:text="${@uiFormat.money(p.amount)}">$0.00</span>
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </td>
              </tr>
              </th:block>
            </tbody>
          </table>
        </div>

        <div class="px-5 py-4 border-t border-slate-200 flex items-center justify-between">
          <a th:if="${hasPrev}"
             th:href="@{/sales(page=${prevPage}, q=${q}, method=${method}, status=${status}, cashier=${cashier}, customer=${customer}, minTotal=${minTotal}, maxTotal=${maxTotal}, from=${from}, to=${to}, sort=${sort})}"
             class="rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm font-medium hover:bg-slate-50 transition">
            Prev
          </a>
          <div class="text-xs text-slate-500">
            Page <span th:text="${page + 1}">1</span> of <span th:text="${totalPages}">1</span>
          </div>
          <a th:if="${hasNext}"
             th:href="@{/sales(page=${nextPage}, q=${q}, method=${method}, status=${status}, cashier=${cashier}, customer=${customer}, minTotal=${minTotal}, maxTotal=${maxTotal}, from=${from}, to=${to}, sort=${sort})}"
             class="rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm font-medium hover:bg-slate-50 transition">
            Next
          </a>
        </div>
      </div>
    </main>
  </div>
  <script>
    const filterForm = document.querySelector('form[action="/sales"]');
    const searchInput = document.getElementById('salesSearchInput');
    const fromDateInput = document.getElementById('salesFromDate');
    const toDateInput = document.getElementById('salesToDate');
    const clearSearchBtn = document.getElementById('clearSearch');
    const densityToggle = document.getElementById('toggleDensity');
    const table = document.getElementById('salesTable');

    function formatDateForInput(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function applyDateRange(rangeType) {
      if (!fromDateInput || !toDateInput || !filterForm) return;
      const today = new Date();
      const end = formatDateForInput(today);
      let startDate = new Date(today);
      if (rangeType === 'today') {
        // Keep start as today.
      } else if (rangeType === 'month') {
        startDate = new Date(today.getFullYear(), today.getMonth(), 1);
      } else {
        const days = Number.parseInt(rangeType, 10);
        if (!Number.isFinite(days) || days <= 0) return;
        startDate.setDate(today.getDate() - (days - 1));
      }
      fromDateInput.value = formatDateForInput(startDate);
      toDateInput.value = end;
      filterForm.submit();
    }

    document.querySelectorAll('[data-date-range]').forEach((button) => {
      button.addEventListener('click', () => applyDateRange(button.getAttribute('data-date-range') || ''));
    });

    if (clearSearchBtn && searchInput) {
      clearSearchBtn.addEventListener('click', () => {
        searchInput.value = '';
        searchInput.focus();
      });
    }

    if (densityToggle && table) {
      densityToggle.addEventListener('click', () => {
        const compact = table.classList.toggle('sales-table-compact');
        densityToggle.textContent = compact ? 'Comfortable rows' : 'Compact rows';
      });
    }

    document.addEventListener('keydown', (event) => {
      const active = document.activeElement;
      const isTypingField = active && (
        active.tagName === 'INPUT' ||
        active.tagName === 'TEXTAREA' ||
        active.tagName === 'SELECT' ||
        active.isContentEditable
      );
      if (event.key === '/' && !isTypingField && searchInput) {
        event.preventDefault();
        searchInput.focus();
      }
    });

    document.querySelectorAll('[data-toggle-details]').forEach((button) => {
      button.addEventListener('click', () => {
        const targetId = button.getAttribute('data-toggle-details');
        const detailsRow = document.querySelector(`[data-details-row="${targetId}"]`);
        if (!detailsRow) return;
        const expanded = button.getAttribute('aria-expanded') === 'true';
        button.setAttribute('aria-expanded', String(!expanded));
        detailsRow.classList.toggle('hidden');
        const icon = button.querySelector('svg');
        if (icon) icon.classList.toggle('rotate-180');
      });
    });

    const selectAll = document.getElementById('selectAll');
    const selectedCount = document.getElementById('bulkSelected');
    const checkboxes = Array.from(document.querySelectorAll('.sale-checkbox'));
    const bulkApply = document.getElementById('bulkApply');
    const bulkAction = document.getElementById('bulkAction');

    function getSelectedIds() {
      return checkboxes.filter(cb => cb.checked).map(cb => cb.getAttribute('data-sale-id'));
    }

    function syncSelectAll() {
      if (!selectAll) return;
      const checkedCount = checkboxes.filter(cb => cb.checked).length;
      const allChecked = checkedCount === checkboxes.length && checkboxes.length > 0;
      selectAll.checked = allChecked;
      selectAll.indeterminate = checkedCount > 0 && !allChecked;
      if (selectedCount) selectedCount.textContent = String(checkedCount);
    }

    if (selectAll) {
      selectAll.addEventListener('change', () => {
        checkboxes.forEach(cb => { cb.checked = selectAll.checked; });
        syncSelectAll();
      });
    }

    checkboxes.forEach(cb => cb.addEventListener('change', syncSelectAll));
    syncSelectAll();

    if (bulkApply) {
      bulkApply.addEventListener('click', () => {
        const action = bulkAction ? bulkAction.value : "";
        const ids = getSelectedIds();
        if (!action) {
          alert('Choose a bulk action first.');
          return;
        }
        if (ids.length === 0) {
          alert('Select at least one sale.');
          return;
        }
        if (action === 'export') {
          const params = new URLSearchParams();
          ids.forEach(id => params.append('ids', id));
          window.location.href = `/sales/export?${params.toString()}`;
          return;
        }
        if (action === 'print') {
          ids.forEach(id => window.open(`/sales/${id}/receipt?print=1`, '_blank'));
          return;
        }
        if (action === 'void') {
          if (!confirm(`Void ${ids.length} selected sale(s)?`)) {
            return;
          }
          const form = document.getElementById('bulkForm');
          const inputAction = document.getElementById('bulkActionInput');
          const idsContainer = document.getElementById('bulkIds');
          if (!form || !inputAction || !idsContainer) return;
          inputAction.value = 'void';
          idsContainer.innerHTML = '';
          ids.forEach(id => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'ids';
            input.value = id;
            idsContainer.appendChild(input);
          });
          form.submit();
        }
      });
    }
  </script>
</body>
</html>
