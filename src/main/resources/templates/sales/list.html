<!doctype html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sales</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-100 text-slate-900">
  <div class="min-h-screen">
    <!-- Top bar -->
    <header class="bg-white/80 backdrop-blur border-b border-slate-200 sticky top-0 z-40">
      <div class="w-full px-6 lg:px-10 py-5">
        <div class="grid grid-cols-3 items-center gap-4">
          <div class="flex items-center gap-3">
          <div class="h-10 w-10 rounded-xl bg-slate-900 text-white grid place-items-center shadow-sm">
            <!-- receipt icon -->
            <svg viewBox="0 0 24 24" class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M7 3h10v18l-2-1-2 1-2-1-2 1-2-1-2 1V3z"/>
              <path d="M9 7h6M9 11h6M9 15h4"/>
            </svg>
          </div>
          <div>
            <div class="text-xl sm:text-2xl font-bold leading-tight">Sales</div>
            <div class="text-sm text-slate-500">Recent transactions</div>
          </div>
          </div>

          <nav class="hidden lg:flex items-center justify-center gap-6 text-sm font-medium">
            <div class="relative group">
              <a href="/"
                 class="inline-flex items-center gap-2 rounded-lg px-2 py-2 text-slate-600 hover:text-slate-900 hover:bg-slate-100/80 transition">
                <svg viewBox="0 0 24 24" class="h-4 w-4 text-slate-400 group-hover:text-slate-600 transition" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M6 6h12v4H6V6z"/>
                  <path d="M6 10h12v8a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2v-8z"/>
                  <path d="M9 14h6"/>
                </svg>
                <span>POS</span>
                <svg viewBox="0 0 24 24" class="h-4 w-4 text-slate-400 group-hover:text-slate-600 transition" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M6 9l6 6 6-6"/>
                </svg>
              </a>
              <div class="absolute left-0 top-full z-50 mt-0 w-52 rounded-xl border border-slate-200 bg-white p-2 shadow-lg
                          opacity-0 pointer-events-none translate-y-1 transition duration-150 ease-out
                          group-hover:opacity-100 group-hover:pointer-events-auto group-hover:translate-y-0
                          group-focus-within:opacity-100 group-focus-within:pointer-events-auto group-focus-within:translate-y-0">
                <a href="/pos"
                   class="block rounded-lg px-3 py-2 text-sm text-slate-600 hover:text-slate-900 hover:bg-slate-50 transition">
                  Open POS
                </a>
                <a href="/"
                   class="block rounded-lg px-3 py-2 text-sm text-slate-600 hover:text-slate-900 hover:bg-slate-50 transition">
                  Dashboard
                </a>
              </div>
            </div>
            <div sec:authorize="hasRole('ADMIN')" class="relative group">
              <a href="/analytics"
                 class="inline-flex items-center gap-2 rounded-lg px-2 py-2 text-slate-600 hover:text-slate-900 hover:bg-slate-100/80 transition">
                <svg viewBox="0 0 24 24" class="h-4 w-4 text-slate-400 group-hover:text-slate-600 transition" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 3v18h18"/>
                  <path d="M7 14l3-3 4 4 5-6"/>
                </svg>
                <span>Analytics</span>
                <svg viewBox="0 0 24 24" class="h-4 w-4 text-slate-400 group-hover:text-slate-600 transition" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M6 9l6 6 6-6"/>
                </svg>
              </a>
              <div class="absolute left-0 top-full z-50 mt-0 w-52 rounded-xl border border-slate-200 bg-white p-2 shadow-lg
                          opacity-0 pointer-events-none translate-y-1 transition duration-150 ease-out
                          group-hover:opacity-100 group-hover:pointer-events-auto group-hover:translate-y-0
                          group-focus-within:opacity-100 group-focus-within:pointer-events-auto group-focus-within:translate-y-0">
                <a href="/analytics"
                   class="block rounded-lg px-3 py-2 text-sm text-slate-600 hover:text-slate-900 hover:bg-slate-50 transition">
                  Overview
                </a>
                <a href="/"
                   class="block rounded-lg px-3 py-2 text-sm text-slate-600 hover:text-slate-900 hover:bg-slate-50 transition">
                  Dashboard
                </a>
              </div>
            </div>
            <div sec:authorize="hasRole('ADMIN')" class="relative group">
              <a href="/products"
                 class="inline-flex items-center gap-2 rounded-lg px-2 py-2 text-slate-600 hover:text-slate-900 hover:bg-slate-100/80 transition">
                <svg viewBox="0 0 24 24" class="h-4 w-4 text-slate-400 group-hover:text-slate-600 transition" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 8l-9 5-9-5 9-5 9 5z"/>
                  <path d="M3 8v8l9 5 9-5V8"/>
                </svg>
                <span>Inventory Management</span>
                <span th:if="${lowStockCount > 0}"
                      class="inline-flex items-center rounded-full bg-amber-100 px-2 py-0.5 text-[10px] font-semibold text-amber-800">
                  <span th:text="${lowStockCount}">0</span>
                </span>
                <svg viewBox="0 0 24 24" class="h-4 w-4 text-slate-400 group-hover:text-slate-600 transition" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M6 9l6 6 6-6"/>
                </svg>
              </a>
              <div class="absolute left-0 top-full z-50 mt-0 w-56 rounded-xl border border-slate-200 bg-white p-2 shadow-lg
                          opacity-0 pointer-events-none translate-y-1 transition duration-150 ease-out
                          group-hover:opacity-100 group-hover:pointer-events-auto group-hover:translate-y-0
                          group-focus-within:opacity-100 group-focus-within:pointer-events-auto group-focus-within:translate-y-0">
                <a href="/products"
                   class="block rounded-lg px-3 py-2 text-sm text-slate-600 hover:text-slate-900 hover:bg-slate-50 transition">
                  All Products
                </a>
                <a href="/products/new"
                   class="block rounded-lg px-3 py-2 text-sm text-slate-600 hover:text-slate-900 hover:bg-slate-50 transition">
                  New Product
                </a>
                <a href="/products?lowStock=true"
                   class="block rounded-lg px-3 py-2 text-sm text-slate-600 hover:text-slate-900 hover:bg-slate-50 transition">
                  Low Stock
                </a>
                <a href="/categories"
                   class="block rounded-lg px-3 py-2 text-sm text-slate-600 hover:text-slate-900 hover:bg-slate-50 transition">
                  Categories
                </a>
                <a href="/categories/new"
                   class="block rounded-lg px-3 py-2 text-sm text-slate-600 hover:text-slate-900 hover:bg-slate-50 transition">
                  New Category
                </a>
              </div>
            </div>
            <div sec:authorize="hasRole('ADMIN')" class="relative group">
              <a href="/sales"
                 class="inline-flex items-center gap-2 rounded-lg px-2 py-2 text-slate-600 hover:text-slate-900 hover:bg-slate-100/80 transition">
                <svg viewBox="0 0 24 24" class="h-4 w-4 text-slate-400 group-hover:text-slate-600 transition" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M7 3h10v18l-2-1-2 1-2-1-2 1-2-1-2 1V3z"/>
                  <path d="M9 7h6M9 11h6M9 15h4"/>
                </svg>
                <span>Sales</span>
                <svg viewBox="0 0 24 24" class="h-4 w-4 text-slate-400 group-hover:text-slate-600 transition" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M6 9l6 6 6-6"/>
                </svg>
              </a>
              <div class="absolute left-0 top-full z-50 mt-0 w-52 rounded-xl border border-slate-200 bg-white p-2 shadow-lg
                          opacity-0 pointer-events-none translate-y-1 transition duration-150 ease-out
                          group-hover:opacity-100 group-hover:pointer-events-auto group-hover:translate-y-0
                          group-focus-within:opacity-100 group-focus-within:pointer-events-auto group-focus-within:translate-y-0">
                <a href="/sales"
                   class="block rounded-lg px-3 py-2 text-sm text-slate-600 hover:text-slate-900 hover:bg-slate-50 transition">
                  All Sales
                </a>
              </div>
            </div>
          </nav>

          <div class="flex flex-wrap items-center justify-end gap-2">
            <a href="/" class="rounded-xl bg-slate-900 text-white px-4 py-2 font-semibold hover:bg-slate-800 transition">
              Open POS
            </a>
            <a sec:authorize="isAnonymous()" href="/login"
               class="rounded-xl border border-slate-200 px-4 py-2 bg-white hover:bg-slate-50 transition">
              Login
            </a>
            <form sec:authorize="isAuthenticated()" action="/logout" method="post" class="m-0">
              <button class="rounded-xl border border-slate-200 px-4 py-2 bg-white hover:bg-slate-50 transition">
                Logout
              </button>
            </form>
          </div>
        </div>
      </div>
    </header>

    <main class="w-full px-6 lg:px-10 py-8">
      <div th:if="${successMessage}"
           class="mb-6 rounded-2xl border border-emerald-200 bg-emerald-50 px-5 py-4 text-sm text-emerald-900">
        <div class="font-semibold">Success</div>
        <div class="mt-1" th:text="${successMessage}">Sale updated.</div>
      </div>
      <div th:if="${errorMessage}"
           class="mb-6 rounded-2xl border border-rose-200 bg-rose-50 px-5 py-4 text-sm text-rose-900">
        <div class="font-semibold">Action needed</div>
        <div class="mt-1" th:text="${errorMessage}">Could not update sale.</div>
      </div>

      <!-- Filters -->
      <form method="get" action="/sales" class="mb-6 bg-white rounded-2xl border border-slate-200 shadow-sm">
        <div class="p-5">
          <div class="flex items-start justify-between gap-4 flex-col md:flex-row">
            <div>
              <div class="text-base font-semibold">Filters</div>
              <div class="text-sm text-slate-500">Search and narrow your sales history</div>
            </div>
            <div class="flex gap-2">
              <button class="rounded-xl bg-slate-900 text-white px-4 py-2 text-sm font-semibold hover:bg-slate-800 transition">
                Filter
              </button>
              <a href="/sales" class="rounded-xl border border-slate-200 px-4 py-2 bg-white text-sm font-medium hover:bg-slate-50 transition">
                Reset
              </a>
              <button type="button" onclick="window.print()"
                      class="rounded-xl border border-slate-200 px-4 py-2 bg-white text-sm font-medium hover:bg-slate-50 transition">
                Export PDF
              </button>
              <a th:href="@{/sales/export(q=${q}, method=${method}, status=${status}, cashier=${cashier}, customer=${customer}, minTotal=${minTotal}, maxTotal=${maxTotal}, from=${from}, to=${to})}"
                 class="rounded-xl border border-slate-200 px-4 py-2 bg-white text-sm font-medium hover:bg-slate-50 transition">
                Export CSV
              </a>
            </div>
          </div>

          <div class="mt-4 grid grid-cols-1 md:grid-cols-6 gap-3">
            <!-- Same logic -->
            <div class="md:col-span-2">
              <label class="block text-xs font-medium text-slate-600 mb-1">Search</label>
              <input name="q" placeholder="Search receipt ID, product, cashier"
                     class="w-full rounded-xl border border-slate-200 px-3 py-2.5 bg-white focus:outline-none focus:ring-2 focus:ring-slate-300"
                     th:value="${q}">
            </div>

            <div class="md:col-span-2">
              <label class="block text-xs font-medium text-slate-600 mb-1">Customer</label>
              <input name="customer" placeholder="Name, phone, email"
                     class="w-full rounded-xl border border-slate-200 px-3 py-2.5 bg-white focus:outline-none focus:ring-2 focus:ring-slate-300"
                     th:value="${customer}">
            </div>

            <div>
              <label class="block text-xs font-medium text-slate-600 mb-1">Cashier</label>
              <input name="cashier" placeholder="Username"
                     class="w-full rounded-xl border border-slate-200 px-3 py-2.5 bg-white focus:outline-none focus:ring-2 focus:ring-slate-300"
                     th:value="${cashier}">
            </div>

            <div>
              <label class="block text-xs font-medium text-slate-600 mb-1">Status</label>
              <select name="status"
                      class="w-full rounded-xl border border-slate-200 px-3 py-2.5 bg-white focus:outline-none focus:ring-2 focus:ring-slate-300">
                <option value="">All Statuses</option>
                <option th:each="st : ${T(com.example.pos_system.entity.SaleStatus).values()}"
                        th:value="${st}"
                        th:selected="${status == st}"
                        th:text="${st}">PAID</option>
              </select>
            </div>

            <div>
              <label class="block text-xs font-medium text-slate-600 mb-1">From</label>
              <input type="date" name="from"
                     class="w-full rounded-xl border border-slate-200 px-3 py-2.5 bg-white focus:outline-none focus:ring-2 focus:ring-slate-300"
                     th:value="${from}">
            </div>

            <div>
              <label class="block text-xs font-medium text-slate-600 mb-1">To</label>
              <input type="date" name="to"
                     class="w-full rounded-xl border border-slate-200 px-3 py-2.5 bg-white focus:outline-none focus:ring-2 focus:ring-slate-300"
                     th:value="${to}">
            </div>

            <div>
              <label class="block text-xs font-medium text-slate-600 mb-1">Method</label>
              <select name="method"
                      class="w-full rounded-xl border border-slate-200 px-3 py-2.5 bg-white focus:outline-none focus:ring-2 focus:ring-slate-300">
                <option value="">All Methods</option>
                <option th:each="m : ${T(com.example.pos_system.entity.PaymentMethod).values()}"
                        th:value="${m}"
                        th:selected="${method == m}"
                        th:text="${m}">CASH</option>
              </select>
            </div>

            <div>
              <label class="block text-xs font-medium text-slate-600 mb-1">Min Total</label>
              <input type="number" step="0.01" name="minTotal"
                     class="w-full rounded-xl border border-slate-200 px-3 py-2.5 bg-white focus:outline-none focus:ring-2 focus:ring-slate-300"
                     th:value="${minTotal}">
            </div>
            <div>
              <label class="block text-xs font-medium text-slate-600 mb-1">Max Total</label>
              <input type="number" step="0.01" name="maxTotal"
                     class="w-full rounded-xl border border-slate-200 px-3 py-2.5 bg-white focus:outline-none focus:ring-2 focus:ring-slate-300"
                     th:value="${maxTotal}">
            </div>
          </div>
        </div>
      </form>

      <form id="bulkForm" method="post" action="/sales/bulk" class="hidden">
        <input type="hidden" name="action" id="bulkActionInput">
        <input type="hidden" name="redirect"
               th:value="@{/sales(page=${page}, q=${q}, method=${method}, status=${status}, cashier=${cashier}, customer=${customer}, minTotal=${minTotal}, maxTotal=${maxTotal}, from=${from}, to=${to})}">
        <div id="bulkIds"></div>
      </form>

      <div class="mb-6 rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div>
            <div class="text-sm font-semibold text-slate-800">Bulk actions</div>
            <div class="text-xs text-slate-500">
              Selected: <span id="bulkSelected">0</span>
            </div>
          </div>
          <div class="flex flex-wrap items-center gap-2">
            <select id="bulkAction" class="rounded-xl border border-slate-200 px-3 py-2 text-sm bg-white">
              <option value="">Choose action</option>
              <option value="void">Void selected</option>
              <option value="export">Export CSV</option>
              <option value="print">Print receipts</option>
            </select>
            <button type="button" id="bulkApply"
                    class="rounded-xl bg-slate-900 text-white px-4 py-2 text-sm font-semibold hover:bg-slate-800 transition">
              Apply
            </button>
          </div>
        </div>
      </div>

      <!-- Summary -->
      <div class="mb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm">
          <div class="text-xs uppercase tracking-wide text-slate-500">Today</div>
          <div class="mt-2 text-2xl font-semibold text-slate-900" th:text="${@uiFormat.money(summaryToday.total)}">$0.00</div>
          <div class="mt-1 text-xs text-slate-500">
            <span th:text="${summaryToday.count}">0</span> sale(s)
          </div>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm">
          <div class="text-xs uppercase tracking-wide text-slate-500">This Week</div>
          <div class="mt-2 text-2xl font-semibold text-slate-900" th:text="${@uiFormat.money(summaryWeek.total)}">$0.00</div>
          <div class="mt-1 text-xs text-slate-500">
            <span th:text="${summaryWeek.count}">0</span> sale(s)
          </div>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm">
          <div class="text-xs uppercase tracking-wide text-slate-500">This Month</div>
          <div class="mt-2 text-2xl font-semibold text-slate-900" th:text="${@uiFormat.money(summaryMonth.total)}">$0.00</div>
          <div class="mt-1 text-xs text-slate-500">
            <span th:text="${summaryMonth.count}">0</span> sale(s)
          </div>
        </div>
      </div>

      <!-- Table -->
      <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
        <div class="px-5 py-4 border-b border-slate-200 flex items-center justify-between">
          <div>
            <div class="text-base font-semibold">Sales list</div>
            <div class="text-sm text-slate-500">Expand a row to see items</div>
          </div>
        </div>

        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead class="bg-slate-50 text-left text-slate-600">
              <tr>
                <th class="px-5 py-3 font-semibold">
                  <input type="checkbox" id="selectAll"
                         class="h-4 w-4 rounded border-slate-300 text-slate-900 focus:ring-slate-300">
                </th>
                <th class="px-5 py-3 font-semibold">ID</th>
                <th class="px-5 py-3 font-semibold">Date</th>
                <th class="px-5 py-3 font-semibold">Customer</th>
                <th class="px-5 py-3 font-semibold">Cashier</th>
                <th class="px-5 py-3 font-semibold">Payment</th>
                <th class="px-5 py-3 font-semibold">Status</th>
                <th class="px-5 py-3 font-semibold">Profit</th>
                <th class="px-5 py-3 font-semibold">Total</th>
                <th class="px-5 py-3 font-semibold">Items</th>
                <th class="px-5 py-3 font-semibold text-right">Action</th>
              </tr>
            </thead>

            <tbody class="divide-y divide-slate-100">
              <tr th:if="${#lists.isEmpty(sales)}">
                <td class="px-5 py-6 text-slate-500" colspan="11">No sales yet.</td>
              </tr>

              <th:block th:each="s : ${sales}" th:with="profit=${profitById[s.id]}, customerSummary=${customerSummaryById[s.id]}">
              <tr class="hover:bg-slate-50/70 transition">
                <td class="px-5 py-4">
                  <input type="checkbox" class="sale-checkbox h-4 w-4 rounded border-slate-300 text-slate-900 focus:ring-slate-300"
                         th:attr="data-sale-id=${s.id}">
                </td>
                <td class="px-5 py-4 font-medium text-slate-900" th:text="${s.id}">1</td>
                <td class="px-5 py-4 text-slate-700" th:text="${@uiFormat.dateTime(s.createdAt)}">2026-02-04</td>
                <td class="px-5 py-4 text-slate-700">
                  <div class="font-semibold text-slate-900" th:text="${s.customer != null ? s.customer.name : 'Walk-in'}">Walk-in</div>
                  <div class="text-xs text-slate-500" th:if="${s.customer != null and s.customer.phone != null}"
                       th:text="${s.customer.phone}">phone</div>
                </td>
                <td class="px-5 py-4 text-slate-700" th:text="${s.cashierUsername ?: '—'}">cashier</td>
                <td class="px-5 py-4 text-slate-700">
                  <div class="flex flex-wrap gap-1">
                    <span th:if="${s.payments == null or #lists.isEmpty(s.payments)}"
                          class="inline-flex items-center gap-2 rounded-full bg-slate-100 px-2.5 py-1 text-xs font-semibold text-slate-700">
                      <span th:text="${s.paymentMethod}">CASH</span>
                      <span class="text-slate-400" th:text="${@uiFormat.money(s.total)}">$0.00</span>
                    </span>
                    <span th:each="p : ${s.payments}"
                          class="inline-flex items-center gap-2 rounded-full bg-slate-100 px-2.5 py-1 text-xs font-semibold text-slate-700">
                      <span th:text="${p.method}">CASH</span>
                      <span class="text-slate-400" th:text="${@uiFormat.money(p.amount)}">$0.00</span>
                    </span>
                  </div>
                </td>

                <!-- Optional badge styling without changing logic -->
                <td class="px-5 py-4">
                  <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold"
                        th:classappend="${s.status != null and s.status.name() == 'VOID'} ? ' bg-rose-100 text-rose-700' : (${s.status != null and s.status.name() != 'PAID'} ? ' bg-amber-100 text-amber-700' : ' bg-emerald-100 text-emerald-700')"
                        th:text="${s.status}">PAID</span>
                </td>

                <td class="px-5 py-4">
                  <div th:if="${profit != null}">
                    <div class="font-semibold text-slate-900" th:text="${@uiFormat.money(profit.profit)}">$0.00</div>
                    <div class="text-xs text-slate-500"
                         th:text="${#numbers.formatDecimal(profit.marginPct, 1, 2)} + '%'">0%</div>
                    <div class="text-xs text-amber-600" th:if="${profit.missingCost}">Cost missing</div>
                  </div>
                  <div th:if="${profit == null}" class="text-slate-400">—</div>
                </td>

                <td class="px-5 py-4">
                  <div class="font-semibold text-slate-900" th:text="${@uiFormat.money(s.total)}">0.00</div>
                  <div class="text-xs text-amber-600" th:if="${s.refundedTotal != null and s.refundedTotal > 0}">
                    Refunded: <span th:text="${@uiFormat.money(s.refundedTotal)}">$0.00</span>
                  </div>
                </td>
                <td class="px-5 py-4">
                  <button type="button"
                          class="inline-flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-3 py-2 text-xs font-semibold text-slate-700 hover:bg-slate-50 transition"
                          th:attr="data-toggle-details=${s.id}" aria-expanded="false">
                    Items
                    <span class="rounded-full bg-slate-100 px-2 py-0.5 text-[10px] font-semibold text-slate-600"
                          th:text="${s.items.size()}">0</span>
                    <svg viewBox="0 0 24 24" class="h-4 w-4 transition-transform" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M6 9l6 6 6-6"/>
                    </svg>
                  </button>
                </td>
                <td class="px-5 py-4 text-right">
                  <div class="flex items-center justify-end gap-2">
                    <a th:href="@{'/sales/' + ${s.id} + '/receipt'}"
                       class="inline-flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-medium text-slate-800 hover:bg-slate-50 transition">
                      Receipt
                      <svg viewBox="0 0 24 24" class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 18l6-6-6-6"/>
                      </svg>
                    </a>
                    <a th:href="@{'/sales/' + ${s.id} + '/receipt?print=1'}" target="_blank"
                       class="inline-flex items-center rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-medium text-slate-700 hover:bg-slate-50 transition">
                      Reprint
                    </a>
                    <a th:href="@{'/sales/' + ${s.id} + '/receipt/pdf'}"
                       class="inline-flex items-center rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-medium text-slate-700 hover:bg-slate-50 transition">
                      PDF
                    </a>
                    <a th:if="${s.status != null and s.status.name() != 'VOID' and s.status.name() != 'RETURNED'}"
                       th:href="@{'/sales/' + ${s.id} + '/return'}"
                       class="inline-flex items-center rounded-xl border border-amber-200 bg-amber-50 px-3 py-2 text-sm font-semibold text-amber-800 hover:bg-amber-100 transition">
                      Return
                    </a>
                    <form th:if="${s.status == null or s.status.name() != 'VOID'}"
                          method="post" th:action="@{'/sales/' + ${s.id} + '/void'}" class="m-0">
                      <input type="hidden" name="redirect"
                             th:value="@{/sales(page=${page}, q=${q}, method=${method}, status=${status}, cashier=${cashier}, customer=${customer}, minTotal=${minTotal}, maxTotal=${maxTotal}, from=${from}, to=${to})}">
                      <button type="submit"
                              th:onclick="'return confirm(\'Void sale #' + ${s.id} + '?\')'"
                              class="inline-flex items-center rounded-xl border border-rose-200 bg-rose-50 px-3 py-2 text-sm font-semibold text-rose-700 hover:bg-rose-100 transition">
                        Void
                      </button>
                    </form>
                  </div>
                </td>
              </tr>

              <tr class="hidden bg-slate-50/40" th:attr="data-details-row=${s.id}">
                <td class="px-5 py-4" colspan="11">
                  <div class="rounded-xl border border-slate-200 bg-white p-4">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                      <div class="lg:col-span-2">
                        <div class="flex items-center justify-between text-xs text-slate-500">
                          <span class="font-semibold text-slate-700">Items</span>
                          <span th:text="${s.items.size() + ' item(s)'}">0 item(s)</span>
                        </div>
                        <div class="mt-3 space-y-2">
                          <div th:if="${#lists.isEmpty(s.items)}" class="text-sm text-slate-500">No items recorded.</div>
                          <div th:each="it : ${s.items}" class="flex items-center justify-between gap-4 text-sm">
                            <div class="min-w-0">
                              <div class="font-semibold text-slate-900 truncate" th:text="${it.product.name}">Product</div>
                              <div class="text-xs text-slate-500"
                                   th:text="${it.qty + ' ' + @uiFormat.unitLabel(it.unitType) + ' × ' + @uiFormat.money(it.unitPrice)}">1 × $0.00</div>
                              <div class="mt-0.5 text-[11px] text-slate-400"
                                   th:if="${it.unitType != null and it.unitType.name() != 'PIECE'}"
                                   th:text="${'Unit size: ' + it.unitSize + ' pcs/' + @uiFormat.unitLabel(it.unitType)}">Unit size</div>
                              <div class="mt-0.5 text-xs text-slate-400"
                                   th:if="${it.priceTier != null and it.priceTier.name() == 'WHOLESALE'}">
                                Wholesale price
                              </div>
                              <div class="mt-0.5 text-xs text-amber-600"
                                   th:if="${it.returnedQty != null and it.returnedQty > 0}"
                                   th:text="${'Returned: ' + it.returnedQty}">Returned</div>
                              <div class="mt-0.5 text-xs text-slate-500"
                                   th:if="${it.note != null and !#strings.isEmpty(it.note)}"
                                   th:text="${'Note: ' + it.note}">Note</div>
                            </div>
                            <div class="shrink-0 font-semibold text-slate-900" th:text="${@uiFormat.money(it.lineTotal)}">$0.00</div>
                          </div>
                        </div>

                        <div class="mt-4 rounded-xl border border-slate-200 bg-slate-50 px-4 py-3">
                          <div class="text-xs font-semibold text-slate-700 mb-2">Timeline</div>
                          <ul class="space-y-2 text-xs text-slate-600">
                            <li class="flex items-center justify-between">
                              <span>Sale created</span>
                              <span th:text="${@uiFormat.dateTime(s.createdAt)}">—</span>
                            </li>
                            <li th:if="${s.status != null and s.status.name() == 'VOID'}"
                                class="flex items-center justify-between text-rose-700">
                              <span>Sale voided</span>
                              <span>—</span>
                            </li>
                            <li th:if="${s.status != null and s.status.name() == 'PARTIALLY_RETURNED'}"
                                class="flex items-center justify-between text-amber-700">
                              <span>Partial return processed</span>
                              <span>—</span>
                            </li>
                            <li th:if="${s.status != null and s.status.name() == 'RETURNED'}"
                                class="flex items-center justify-between text-amber-700">
                              <span>Full return processed</span>
                              <span>—</span>
                            </li>
                            <li th:if="${s.refundedTotal != null and s.refundedTotal > 0}"
                                class="flex items-center justify-between text-amber-700">
                              <span>Refunded total</span>
                              <span th:text="${@uiFormat.money(s.refundedTotal)}">$0.00</span>
                            </li>
                          </ul>
                        </div>
                      </div>

                      <div class="space-y-4">
                        <div class="rounded-xl border border-slate-200 bg-white p-4">
                          <div class="text-xs font-semibold text-slate-700">Customer summary</div>
                          <div th:if="${customerSummary != null}" class="mt-2 text-sm text-slate-700">
                            <div class="font-semibold text-slate-900" th:text="${customerSummary.customer.name}">Customer</div>
                            <div class="text-xs text-slate-500" th:if="${customerSummary.customer.phone != null}"
                                 th:text="${customerSummary.customer.phone}">phone</div>
                            <div class="mt-2 grid grid-cols-2 gap-2 text-xs">
                              <div class="rounded-lg bg-slate-50 p-2">
                                <div class="text-slate-500">Visits</div>
                                <div class="font-semibold text-slate-900" th:text="${customerSummary.visits}">0</div>
                              </div>
                              <div class="rounded-lg bg-slate-50 p-2">
                                <div class="text-slate-500">Points</div>
                                <div class="font-semibold text-slate-900" th:text="${customerSummary.customer.points != null ? customerSummary.customer.points : 0}">0</div>
                              </div>
                              <div class="rounded-lg bg-slate-50 p-2 col-span-2">
                                <div class="text-slate-500">Lifetime spend</div>
                                <div class="font-semibold text-slate-900" th:text="${@uiFormat.money(customerSummary.lifetimeSpend)}">$0.00</div>
                              </div>
                              <div class="rounded-lg bg-slate-50 p-2 col-span-2">
                                <div class="text-slate-500">Last purchase</div>
                                <div class="font-semibold text-slate-900"
                                     th:text="${customerSummary.lastPurchase != null ? @uiFormat.dateTime(customerSummary.lastPurchase) : '-'}">-</div>
                              </div>
                            </div>
                          </div>
                          <div th:if="${customerSummary == null}" class="mt-2 text-xs text-slate-500">
                            Walk-in customer.
                          </div>
                        </div>

                        <div class="rounded-xl border border-slate-200 bg-white p-4">
                          <div class="text-xs font-semibold text-slate-700">Payment breakdown</div>
                          <div class="mt-2 flex flex-wrap gap-2">
                            <span th:if="${s.payments == null or #lists.isEmpty(s.payments)}"
                                  class="inline-flex items-center gap-2 rounded-full bg-slate-100 px-2.5 py-1 text-xs font-semibold text-slate-700">
                              <span th:text="${s.paymentMethod}">CASH</span>
                              <span class="text-slate-400" th:text="${@uiFormat.money(s.total)}">$0.00</span>
                            </span>
                            <span th:each="p : ${s.payments}"
                                  class="inline-flex items-center gap-2 rounded-full bg-slate-100 px-2.5 py-1 text-xs font-semibold text-slate-700">
                              <span th:text="${p.method}">CASH</span>
                              <span class="text-slate-400" th:text="${@uiFormat.money(p.amount)}">$0.00</span>
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </td>
              </tr>
              </th:block>
            </tbody>
          </table>
        </div>

        <div class="px-5 py-4 border-t border-slate-200 flex items-center justify-between">
          <a th:if="${hasPrev}"
             th:href="@{/sales(page=${prevPage}, q=${q}, method=${method}, status=${status}, cashier=${cashier}, customer=${customer}, minTotal=${minTotal}, maxTotal=${maxTotal}, from=${from}, to=${to})}"
             class="rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm font-medium hover:bg-slate-50 transition">
            Prev
          </a>
          <div class="text-xs text-slate-500">
            Page <span th:text="${page + 1}">1</span> of <span th:text="${totalPages}">1</span>
          </div>
          <a th:if="${hasNext}"
             th:href="@{/sales(page=${nextPage}, q=${q}, method=${method}, status=${status}, cashier=${cashier}, customer=${customer}, minTotal=${minTotal}, maxTotal=${maxTotal}, from=${from}, to=${to})}"
             class="rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm font-medium hover:bg-slate-50 transition">
            Next
          </a>
        </div>
      </div>
    </main>
  </div>
  <script>
    document.querySelectorAll('[data-toggle-details]').forEach((button) => {
      button.addEventListener('click', () => {
        const targetId = button.getAttribute('data-toggle-details');
        const detailsRow = document.querySelector(`[data-details-row="${targetId}"]`);
        if (!detailsRow) return;
        const expanded = button.getAttribute('aria-expanded') === 'true';
        button.setAttribute('aria-expanded', String(!expanded));
        detailsRow.classList.toggle('hidden');
        const icon = button.querySelector('svg');
        if (icon) icon.classList.toggle('rotate-180');
      });
    });

    const selectAll = document.getElementById('selectAll');
    const selectedCount = document.getElementById('bulkSelected');
    const checkboxes = Array.from(document.querySelectorAll('.sale-checkbox'));
    const bulkApply = document.getElementById('bulkApply');
    const bulkAction = document.getElementById('bulkAction');

    function getSelectedIds() {
      return checkboxes.filter(cb => cb.checked).map(cb => cb.getAttribute('data-sale-id'));
    }

    function syncSelectAll() {
      if (!selectAll) return;
      const checkedCount = checkboxes.filter(cb => cb.checked).length;
      const allChecked = checkedCount === checkboxes.length && checkboxes.length > 0;
      selectAll.checked = allChecked;
      selectAll.indeterminate = checkedCount > 0 && !allChecked;
      if (selectedCount) selectedCount.textContent = String(checkedCount);
    }

    if (selectAll) {
      selectAll.addEventListener('change', () => {
        checkboxes.forEach(cb => { cb.checked = selectAll.checked; });
        syncSelectAll();
      });
    }

    checkboxes.forEach(cb => cb.addEventListener('change', syncSelectAll));
    syncSelectAll();

    if (bulkApply) {
      bulkApply.addEventListener('click', () => {
        const action = bulkAction ? bulkAction.value : "";
        const ids = getSelectedIds();
        if (!action) {
          alert('Choose a bulk action first.');
          return;
        }
        if (ids.length === 0) {
          alert('Select at least one sale.');
          return;
        }
        if (action === 'export') {
          const params = new URLSearchParams();
          ids.forEach(id => params.append('ids', id));
          window.location.href = `/sales/export?${params.toString()}`;
          return;
        }
        if (action === 'print') {
          ids.forEach(id => window.open(`/sales/${id}/receipt?print=1`, '_blank'));
          return;
        }
        if (action === 'void') {
          const form = document.getElementById('bulkForm');
          const inputAction = document.getElementById('bulkActionInput');
          const idsContainer = document.getElementById('bulkIds');
          if (!form || !inputAction || !idsContainer) return;
          inputAction.value = 'void';
          idsContainer.innerHTML = '';
          ids.forEach(id => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'ids';
            input.value = id;
            idsContainer.appendChild(input);
          });
          form.submit();
        }
      });
    }
  </script>
</body>
</html>
