<!doctype html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Group 2 POS System</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/htmx.org@1.9.12" defer></script>

  <!-- UI helpers only (no logic change) -->
  <style>
    .line-clamp-2{
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }

    #productGrid[data-density="compact"]{
      gap:0.875rem;
    }
    #productGrid .product-image-wrap{
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:0.75rem;
    }
    #productGrid .product-image-wrap img{
      width:100%;
      height:100%;
      object-fit:contain;
      object-position:center;
      display:block;
    }
    #productGrid[data-density="compact"] .product-image-wrap{
      height:10rem;
      padding:0.5rem;
    }
    #productGrid[data-density="compact"] .product-content{
      padding:0.75rem;
    }
    #productGrid[data-density="compact"] .product-title{
      font-size:0.92rem;
      -webkit-line-clamp:1;
    }
    #productGrid[data-density="compact"] .product-meta{
      margin-top:0.4rem;
    }
  </style>
</head>

<body class="bg-slate-100 text-slate-900"
      th:attr="data-base-symbol=${baseCurrency.symbol}, data-base-code=${baseCurrency.code}, data-base-decimals=${baseCurrency.fractionDigits}">
  <!-- soft background accents (UI only) -->
  <div class="absolute inset-0 -z-10">
    <div class="absolute -top-28 -left-28 h-80 w-80 rounded-full bg-slate-300/30 blur-3xl"></div>
    <div class="absolute -bottom-28 -right-28 h-96 w-96 rounded-full bg-slate-200/60 blur-3xl"></div>
  </div>

  <div class="min-h-screen">
    <!-- Sticky top toolbar (UI only) -->
    <header class="sticky top-0 z-40 bg-white/80 backdrop-blur border-b border-slate-200">
      <div class="w-full px-6 lg:px-10 py-5">
        <div class="flex flex-col gap-4">
          <!-- Title row -->
          <div class="grid grid-cols-3 items-center gap-4">
            <div class="flex items-center gap-3">
              <div class="h-10 w-10 rounded-xl bg-slate-900 text-white grid place-items-center shadow-sm">
                <!-- register icon -->
                <svg viewBox="0 0 24 24" class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M6 6h12v4H6V6z"/>
                  <path d="M6 10h12v8a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2v-8z"/>
                  <path d="M9 14h6"/>
                </svg>
              </div>
              <div>
                <div class="text-xl sm:text-2xl font-bold leading-tight">Point of Sale</div>
                <div class="text-sm text-slate-500">Search items, scan barcodes, checkout</div>
              </div>
            </div>

            <nav class="hidden lg:flex items-center justify-center gap-4 text-[13px] font-semibold">
              <div class="relative group">
                <a href="/"
                   class="inline-flex items-center gap-2 rounded-lg px-2 py-2 text-slate-600 hover:text-slate-900 hover:bg-slate-100/80 transition">
                  <svg viewBox="0 0 24 24" class="h-4 w-4 text-slate-400 group-hover:text-slate-600 transition" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M6 6h12v4H6V6z"/>
                    <path d="M6 10h12v8a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2v-8z"/>
                    <path d="M9 14h6"/>
                  </svg>
                  <span>POS</span>
                </a>
                <div class="absolute left-0 top-full z-50 mt-0 w-52 rounded-xl border border-slate-200 bg-white p-2 shadow-lg
                            opacity-0 pointer-events-none translate-y-1 transition duration-150 ease-out group-hover:opacity-100 group-hover:pointer-events-auto group-hover:translate-y-0
                            group-focus-within:opacity-100 group-focus-within:pointer-events-auto group-focus-within:translate-y-0">
                  <a href="/pos"
                     class="block rounded-lg px-3 py-2 text-sm text-slate-600 hover:text-slate-900 hover:bg-slate-50 transition">
                    Open POS
                  </a>
                  <a href="/"
                     class="block rounded-lg px-3 py-2 text-sm text-slate-600 hover:text-slate-900 hover:bg-slate-50 transition">
                    Dashboard
                  </a>
                </div>
              </div>
              <div sec:authorize="hasAnyRole('ADMIN','MANAGER')" class="relative group">
                <a href="/analytics"
                   class="inline-flex items-center gap-2 rounded-lg px-2 py-2 text-slate-600 hover:text-slate-900 hover:bg-slate-100/80 transition">
                  <svg viewBox="0 0 24 24" class="h-4 w-4 text-slate-400 group-hover:text-slate-600 transition" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 3v18h18"/>
                    <path d="M7 14l3-3 4 4 5-6"/>
                  </svg>
                  <span>Analytics</span>
                </a>
                <div class="absolute left-0 top-full z-50 mt-0 w-52 rounded-xl border border-slate-200 bg-white p-2 shadow-lg
                            opacity-0 pointer-events-none translate-y-1 transition duration-150 ease-out group-hover:opacity-100 group-hover:pointer-events-auto group-hover:translate-y-0
                            group-focus-within:opacity-100 group-focus-within:pointer-events-auto group-focus-within:translate-y-0">
                  <a href="/analytics"
                     class="block rounded-lg px-3 py-2 text-sm text-slate-600 hover:text-slate-900 hover:bg-slate-50 transition">
                    Overview
                  </a>
                  <a href="/"
                     class="block rounded-lg px-3 py-2 text-sm text-slate-600 hover:text-slate-900 hover:bg-slate-50 transition">
                    Dashboard
                  </a>
                </div>
              </div>
              <div sec:authorize="hasAnyRole('ADMIN','MANAGER')" class="relative group">
                <a href="/products"
                   class="inline-flex items-center gap-2 rounded-lg px-2 py-2 text-slate-600 hover:text-slate-900 hover:bg-slate-100/80 transition">
                  <svg viewBox="0 0 24 24" class="h-4 w-4 text-slate-400 group-hover:text-slate-600 transition" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 8l-9 5-9-5 9-5 9 5z"/>
                    <path d="M3 8v8l9 5 9-5V8"/>
                  </svg>
                  <span>Inventory</span>
                  <span th:if="${lowStockCount > 0}"
                        class="inline-flex items-center rounded-full bg-amber-100 px-2 py-0.5 text-[10px] font-semibold text-amber-800">
                    <span th:text="${lowStockCount}">0</span>
                  </span>
                </a>
                <div class="absolute left-0 top-full z-50 mt-0 w-56 rounded-xl border border-slate-200 bg-white p-2 shadow-lg
                            opacity-0 pointer-events-none translate-y-1 transition duration-150 ease-out group-hover:opacity-100 group-hover:pointer-events-auto group-hover:translate-y-0
                            group-focus-within:opacity-100 group-focus-within:pointer-events-auto group-focus-within:translate-y-0">
                  <a href="/products"
                     class="block rounded-lg px-3 py-2 text-sm text-slate-600 hover:text-slate-900 hover:bg-slate-50 transition">
                    All Products
                  </a>
                  <a href="/products/new"
                     class="block rounded-lg px-3 py-2 text-sm text-slate-600 hover:text-slate-900 hover:bg-slate-50 transition">
                    New Product
                  </a>
                  <a href="/products?lowStock=true"
                     class="block rounded-lg px-3 py-2 text-sm text-slate-600 hover:text-slate-900 hover:bg-slate-50 transition">
                    Low Stock
                  </a>
                  <a href="/categories"
                     class="block rounded-lg px-3 py-2 text-sm text-slate-600 hover:text-slate-900 hover:bg-slate-50 transition">
                    Categories
                  </a>
                  <a href="/categories/new"
                     class="block rounded-lg px-3 py-2 text-sm text-slate-600 hover:text-slate-900 hover:bg-slate-50 transition">
                    New Category
                  </a>
                </div>
              </div>
            <div sec:authorize="hasAnyRole('ADMIN','MANAGER')" class="relative group">
                <a href="/sales"
                   class="inline-flex items-center gap-2 rounded-lg px-2 py-2 text-slate-600 hover:text-slate-900 hover:bg-slate-100/80 transition">
                  <svg viewBox="0 0 24 24" class="h-4 w-4 text-slate-400 group-hover:text-slate-600 transition" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M7 3h10v18l-2-1-2 1-2-1-2 1-2-1-2 1V3z"/>
                    <path d="M9 7h6M9 11h6M9 15h4"/>
                  </svg>
                  <span>Sales</span>
                </a>
                <div class="absolute left-0 top-full z-50 mt-0 w-52 rounded-xl border border-slate-200 bg-white p-2 shadow-lg
                            opacity-0 pointer-events-none translate-y-1 transition duration-150 ease-out group-hover:opacity-100 group-hover:pointer-events-auto group-hover:translate-y-0
                            group-focus-within:opacity-100 group-focus-within:pointer-events-auto group-focus-within:translate-y-0">
                  <a href="/sales"
                     class="block rounded-lg px-3 py-2 text-sm text-slate-600 hover:text-slate-900 hover:bg-slate-50 transition">
                    All Sales
                  </a>
                </div>
              </div>
            
            
            <div sec:authorize="hasAnyRole('ADMIN','MANAGER')" class="relative group">
              <a href="/reports"
                 class="inline-flex items-center gap-2 rounded-lg px-2 py-2 text-slate-600 hover:text-slate-900 hover:bg-slate-100/80 transition">
                <svg viewBox="0 0 24 24" class="h-4 w-4 text-slate-400 group-hover:text-slate-600 transition" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M4 4h16v16H4z"/>
                  <path d="M8 8h8M8 12h8M8 16h6"/>
                </svg>
                <span>Reports</span>
              </a>
              <div class="absolute left-0 top-full z-50 mt-0 w-56 rounded-xl border border-slate-200 bg-white p-2 shadow-lg
                          opacity-0 pointer-events-none translate-y-1 transition duration-150 ease-out
                          group-hover:opacity-100 group-hover:pointer-events-auto group-hover:translate-y-0
                          group-focus-within:opacity-100 group-focus-within:pointer-events-auto group-focus-within:translate-y-0">
                <a href="/reports"
                   class="block rounded-lg px-3 py-2 text-sm text-slate-600 hover:text-slate-900 hover:bg-slate-50 transition">
                  Sales Reports
                </a>
                <a href="/reports/sales.xlsx"
                   class="block rounded-lg px-3 py-2 text-sm text-slate-600 hover:text-slate-900 hover:bg-slate-50 transition">
                  Export Sales (Excel)
                </a>
              </div>
            </div>
            <div sec:authorize="hasRole('ADMIN')" class="relative group">
              <a href="/users"
                 class="inline-flex items-center gap-2 rounded-lg px-2 py-2 text-slate-600 hover:text-slate-900 hover:bg-slate-100/80 transition">
                <svg viewBox="0 0 24 24" class="h-4 w-4 text-slate-400 group-hover:text-slate-600 transition" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M16 11a4 4 0 1 0-8 0 4 4 0 0 0 8 0z"/>
                  <path d="M3 20a7 7 0 0 1 18 0"/>
                </svg>
                <span>Users</span>
              </a>
              <div class="absolute left-0 top-full z-50 mt-0 w-52 rounded-xl border border-slate-200 bg-white p-2 shadow-lg
                          opacity-0 pointer-events-none translate-y-1 transition duration-150 ease-out
                          group-hover:opacity-100 group-hover:pointer-events-auto group-hover:translate-y-0
                          group-focus-within:opacity-100 group-focus-within:pointer-events-auto group-focus-within:translate-y-0">
                <a href="/users"
                   class="block rounded-lg px-3 py-2 text-sm text-slate-600 hover:text-slate-900 hover:bg-slate-50 transition">
                  All Users
                </a>
                <a href="/users#new-user"
                   class="block rounded-lg px-3 py-2 text-sm text-slate-600 hover:text-slate-900 hover:bg-slate-50 transition">
                  Add User
                </a>
                <a sec:authorize="hasRole('ADMIN')" href="/currencies"
                   class="block rounded-lg px-3 py-2 text-sm text-slate-600 hover:text-slate-900 hover:bg-slate-50 transition">
                  Currency Management
                </a>

              </div>
            </div>
          </nav>

            <div class="flex flex-wrap items-center justify-end gap-2">
              <a sec:authorize="isAnonymous()" href="/login"
                 class="rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm font-medium text-slate-700
                        hover:bg-slate-50 transition">
                Login
              </a>
              <form sec:authorize="isAuthenticated()" action="/logout" method="post" class="m-0">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <button class="rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm font-medium text-slate-700
                               hover:bg-slate-50 transition">
                  Logout
                </button>
              </form>
            </div>
          </div>

          <!-- Controls row -->
          <div class="flex flex-col lg:flex-row lg:items-end gap-3">
            <form method="get" action="/pos"
                  hx-get="/pos"
                  hx-target="#productGridWrap"
                  hx-swap="outerHTML"
                  hx-push-url="true"
                  hx-trigger="submit, change from:#categorySelect"
                  class="flex-1 grid grid-cols-1 lg:grid-cols-12 gap-3 items-end">
              <!-- Search -->
              <div class="lg:col-span-7">
                <label class="block text-xs font-medium text-slate-600 mb-1">Search</label>
                <div class="relative">
                  <span class="pointer-events-none absolute inset-y-0 left-3 flex items-center text-slate-400">
                    <!-- search icon -->
                    <svg viewBox="0 0 24 24" class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="11" cy="11" r="7"/>
                      <path d="M21 21l-4.3-4.3"/>
                    </svg>
                  </span>
                  <input id="searchBox" name="q"
                         th:value="${q}"
                         class="w-full rounded-xl border border-slate-200 pl-10 pr-3 py-2.5 bg-white
                                focus:outline-none focus:ring-2 focus:ring-slate-300"
                         placeholder="Search product (press / to focus)"/>
                </div>
              </div>

              <!-- Category -->
              <div class="lg:col-span-3">
                <label class="block text-xs font-medium text-slate-600 mb-1">Category</label>
                <select id="categorySelect" name="categoryId"
                        class="w-full rounded-xl border border-slate-200 px-3 py-2.5 bg-white
                               focus:outline-none focus:ring-2 focus:ring-slate-300">
                  <option value="">All</option>
                  <option th:each="c : ${categories}"
                          th:value="${c.id}"
                          th:selected="${categoryId == c.id}"
                          th:text="${c.name}"></option>
                </select>
              </div>

              <!-- Filter button -->
              <div class="lg:col-span-2">
                <button class="h-[42px] w-full rounded-xl bg-slate-900 text-white px-5 text-sm font-semibold
                               hover:bg-slate-800 transition active:scale-[0.99]">
                  Filter
                </button>
              </div>
            </form>

            <form action="/pos/quick-add" method="post" data-quick-add
                  hx-post="/pos/quick-add" hx-target="#cartPanel" hx-swap="outerHTML"
                  class="w-full sm:w-52">
              <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
              <input type="hidden" name="q" value=""/>
              <label class="block text-xs font-medium text-slate-600 mb-1">Quick add</label>
              <button class="h-[42px] w-full rounded-xl border border-slate-200 bg-white px-4 text-xs font-semibold text-slate-700
                             hover:bg-slate-50 transition active:scale-[0.99]">
                Add from search
              </button>
            </form>

            <!-- Barcode input form (same action/method) -->
            <form id="barcodeForm" action="/pos/scan" method="post"
                  hx-post="/pos/scan"
                  hx-target="#cartContainer"
                  hx-swap="outerHTML"
                  hx-on="htmx:afterRequest: this.reset()"
                  class="w-full lg:w-auto flex flex-col sm:flex-row sm:items-end gap-2">
              <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
              <div class="w-full sm:w-72">
                <label class="block text-xs font-medium text-slate-600 mb-1">Barcode</label>
                <div class="relative">
                  <span class="pointer-events-none absolute inset-y-0 left-3 flex items-center text-slate-400">
                    <!-- barcode icon -->
                    <svg viewBox="0 0 24 24" class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M4 7v10"/>
                      <path d="M7 7v10"/>
                      <path d="M10 7v10"/>
                      <path d="M13 7v10"/>
                      <path d="M16 7v10"/>
                      <path d="M19 7v10"/>
                    </svg>
                  </span>
                  <input name="barcode" id="barcodeInput"
                         class="w-full rounded-xl border border-slate-200 pl-10 pr-3 py-2.5 bg-white
                                focus:outline-none focus:ring-2 focus:ring-slate-300"
                         placeholder="Scan barcode & Enter"
                         autocomplete="off"/>
                </div>
              </div>

              <button class="h-[42px] rounded-xl bg-slate-900 text-white px-5 text-sm font-semibold
                             hover:bg-slate-800 transition active:scale-[0.99]">
                Scan
              </button>
            </form>
          </div>

          <!-- Shortcut hint -->
          <div class="text-xs text-slate-500 flex flex-wrap items-center gap-2">
            <span>Shortcuts:</span>
            <span class="inline-flex items-center gap-1">
              <span class="font-mono rounded-md border border-slate-200 bg-white px-2 py-0.5">/</span>
              <span>focus search</span>
            </span>
            <span class="text-slate-400">·</span>
            <span class="inline-flex items-center gap-1">
              <span class="font-mono rounded-md border border-slate-200 bg-white px-2 py-0.5">F8</span>
              <span>focus barcode</span>
            </span>
            <span class="text-slate-400">·</span>
            <span class="inline-flex items-center gap-1">
              <span class="font-mono rounded-md border border-slate-200 bg-white px-2 py-0.5">F2</span>
              <span>checkout</span>
            </span>
            <span class="text-slate-400">·</span>
            <span class="inline-flex items-center gap-1">
              <span class="font-mono rounded-md border border-slate-200 bg-white px-2 py-0.5">⌘/Ctrl+K</span>
              <span>clear cart</span>
            </span>
          </div>

          <div class="mt-4 rounded-2xl border border-slate-200 bg-white/80 p-3">
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-3" id="quickTotals">
              <div class="rounded-xl bg-slate-50 px-3 py-2">
                <div class="text-[11px] uppercase tracking-wide text-slate-500">Subtotal</div>
                <div id="qtSubtotal" class="text-sm font-semibold text-slate-900">$0.00</div>
              </div>
              <div class="rounded-xl bg-slate-50 px-3 py-2">
                <div class="text-[11px] uppercase tracking-wide text-slate-500">Discount</div>
                <div id="qtDiscount" class="text-sm font-semibold text-slate-900">$0.00</div>
              </div>
              <div class="rounded-xl bg-slate-50 px-3 py-2">
                <div class="text-[11px] uppercase tracking-wide text-slate-500">Tax</div>
                <div id="qtTax" class="text-sm font-semibold text-slate-900">$0.00</div>
              </div>
              <div class="rounded-xl bg-slate-900 px-3 py-2 text-white">
                <div class="text-[11px] uppercase tracking-wide text-white/70">Total</div>
                <div id="qtTotal" class="text-sm font-semibold">$0.00</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </header>

    <main class="w-full px-6 lg:px-10 py-6">
      <div class="grid grid-cols-12 gap-6">
        <!-- Products -->
        <section class="col-span-12 lg:col-span-8 bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
          <div class="px-5 py-4 border-b border-slate-200 flex items-center justify-between">
            <div>
              <div class="text-base font-semibold">Products</div>
              <div class="text-sm text-slate-500">Click an item to add to cart</div>
            </div>
          </div>

          <div class="p-5">
            <div id="pinnedSection" class="mb-4 hidden">
              <div class="flex items-center justify-between">
                <div class="text-sm font-semibold text-slate-800">Pinned items</div>
                <button type="button"
                        class="text-xs font-semibold text-slate-500 hover:text-slate-800 transition"
                        data-action="clear-pins">
                  Clear
                </button>
              </div>
              <div id="pinnedGrid" class="mt-3 grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-4"></div>
            </div>
            <div id="recentSection" class="mb-4 hidden">
              <div class="flex items-center justify-between">
                <div class="text-sm font-semibold text-slate-800">Recent items</div>
                <button type="button"
                        class="text-xs font-semibold text-slate-500 hover:text-slate-800 transition"
                        data-action="clear-recents">
                  Clear
                </button>
              </div>
              <div id="recentGrid" class="mt-3 grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-4"></div>
            </div>
            <div class="mb-4 rounded-2xl border border-slate-200 bg-slate-50 p-3">
              <div class="flex flex-col gap-3 lg:flex-row lg:items-center lg:justify-between">
                <div class="text-xs text-slate-600">
                  Showing <span id="productVisibleCount" class="font-semibold text-slate-800">0</span>
                  of <span id="productTotalCount" class="font-semibold text-slate-800">0</span> products
                </div>
                <div class="flex flex-wrap items-center gap-2">
                  <select id="productSort"
                          class="rounded-lg border border-slate-200 bg-white px-2.5 py-1.5 text-xs font-medium text-slate-700
                                 focus:outline-none focus:ring-2 focus:ring-slate-300">
                    <option value="server">Default order</option>
                    <option value="name-asc">Name A-Z</option>
                    <option value="price-asc">Price low-high</option>
                    <option value="price-desc">Price high-low</option>
                    <option value="stock-desc">Stock high-low</option>
                  </select>
                  <div class="inline-flex items-center rounded-lg border border-slate-200 bg-white p-1">
                    <button type="button" data-density="comfortable"
                            class="density-toggle rounded-md px-2 py-1 text-[11px] font-semibold text-slate-600 transition hover:bg-slate-100">
                      Cozy
                    </button>
                    <button type="button" data-density="compact"
                            class="density-toggle rounded-md px-2 py-1 text-[11px] font-semibold text-slate-600 transition hover:bg-slate-100">
                      Compact
                    </button>
                  </div>
                </div>
              </div>
              <div class="mt-3 flex flex-wrap items-center gap-2">
                <button type="button" data-stock-filter="all"
                        class="stock-filter rounded-lg border border-slate-200 bg-white px-2.5 py-1.5 text-xs font-semibold text-slate-600 hover:bg-slate-100 transition">
                  All
                </button>
                <button type="button" data-stock-filter="in-stock"
                        class="stock-filter rounded-lg border border-slate-200 bg-white px-2.5 py-1.5 text-xs font-semibold text-slate-600 hover:bg-slate-100 transition">
                  In stock
                </button>
                <button type="button" data-stock-filter="low-stock"
                        class="stock-filter rounded-lg border border-slate-200 bg-white px-2.5 py-1.5 text-xs font-semibold text-slate-600 hover:bg-slate-100 transition">
                  Low stock
                </button>
                <button type="button" data-stock-filter="out-of-stock"
                        class="stock-filter rounded-lg border border-slate-200 bg-white px-2.5 py-1.5 text-xs font-semibold text-slate-600 hover:bg-slate-100 transition">
                  Out of stock
                </button>
              </div>
            </div>
            <div th:replace="~{pos/fragments :: productGridWrap}"></div>
            <div id="productFilterEmpty"
                 class="mt-4 hidden rounded-2xl border border-dashed border-slate-300 bg-slate-50 px-4 py-6 text-sm text-slate-600">
              No products match the selected filter on this page.
            </div>
          </div>
        </section>

        <!-- Cart -->
        <aside class="col-span-12 lg:col-span-4 bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
          <div class="px-5 py-4 border-b border-slate-200 flex items-center justify-between">
            <div>
              <div class="text-base font-semibold">Cart</div>
              <div class="text-sm text-slate-500">Review items and checkout</div>
            </div>
            <button type="button"
                    data-action="clear-cart"
                    class="rounded-xl border border-slate-200 bg-white px-3 py-1.5 text-xs font-semibold text-slate-600 hover:bg-slate-50 transition">
              Clear cart
            </button>
          </div>

          <div class="p-5">
            <div th:replace="~{pos/fragments :: cartContainer}"></div>
          </div>
        </aside>
      </div>
    </main>
  </div>

  <script>
    const isTypingTarget = (target) => {
      if (!target) return false;
      if (target.isContentEditable) return true;
      const tag = target.tagName ? target.tagName.toLowerCase() : "";
      return ["input", "textarea", "select"].includes(tag);
    };

    const shouldIgnoreShortcuts = (event) => {
      return isTypingTarget(event.target) || isTypingTarget(document.activeElement);
    };

    const openCheckout = () => {
      const section = document.getElementById("checkoutSection");
      if (!section) return;
      section.scrollIntoView({ behavior: "smooth", block: "start" });
      const focusTarget = document.getElementById("checkoutCashButton") || section.querySelector("button");
      if (focusTarget) focusTarget.focus();
    };

    // Keyboard shortcuts
    window.addEventListener("keydown", (e) => {
      if (shouldIgnoreShortcuts(e)) return;
      if (e.key === "/") {
        e.preventDefault();
        document.getElementById("searchBox").focus();
        return;
      }
      if (e.key === "F8") {
        e.preventDefault();
        document.getElementById("barcodeInput").focus();
        return;
      }
      if (e.key === "F2") {
        e.preventDefault();
        openCheckout();
        return;
      }
      if ((e.ctrlKey || e.metaKey) && (e.key === "k" || e.key === "K")) {
        e.preventDefault();
        confirmClearCart();
        return;
      }
      if (e.key === "Delete" || e.key === "Backspace") {
        e.preventDefault();
        removeSelectedCartItem();
        return;
      }
      if (e.key === "+" || e.code === "NumpadAdd" || (e.key === "=" && e.shiftKey)) {
        e.preventDefault();
        adjustSelectedQty(1);
        return;
      }
      if (e.key === "-" || e.code === "NumpadSubtract") {
        e.preventDefault();
        adjustSelectedQty(-1);
        return;
      }
    });

    const getBaseCurrency = () => {
      const panel = getCartPanel();
      const symbol = (panel && panel.dataset.baseSymbol) || document.body.dataset.baseSymbol || "$";
      const code = (panel && panel.dataset.baseCode) || document.body.dataset.baseCode || "USD";
      const decimalsRaw = (panel && panel.dataset.baseDecimals) || document.body.dataset.baseDecimals || "2";
      const decimals = Number.parseInt(decimalsRaw, 10);
      return { symbol, code, decimals: Number.isFinite(decimals) ? decimals : 2 };
    };

    const formatCurrency = (value, currency) => {
      const num = Number.parseFloat(value);
      if (!Number.isFinite(num)) return "-";
      const decimals = Number.isFinite(currency?.decimals) ? currency.decimals : 2;
      const fixed = num.toFixed(decimals);
      if (currency?.symbol) return `${currency.symbol}${fixed}`;
      if (currency?.code) return `${fixed} ${currency.code}`;
      return fixed;
    };

    const formatMoney = (value) => formatCurrency(value, getBaseCurrency());

    const getCartPanel = () => document.getElementById("cartPanel");

    const productSortKey = "pos.products.sort";
    const productDensityKey = "pos.products.density";
    const productStockFilterKey = "pos.products.stock-filter";

    const readStorage = (key, fallback) => {
      try {
        const value = localStorage.getItem(key);
        return value === null ? fallback : value;
      } catch {
        return fallback;
      }
    };

    const writeStorage = (key, value) => {
      try {
        localStorage.setItem(key, value);
      } catch {
        // ignore storage errors
      }
    };

    const terminalIdKey = "pos.terminal.id";

    const generateTerminalId = () => {
      const random = Math.random().toString(36).slice(2, 8).toUpperCase();
      return `TERM-${random}`;
    };

    const getTerminalId = () => {
      let current = readStorage(terminalIdKey, "").trim();
      if (!current) {
        current = generateTerminalId();
        writeStorage(terminalIdKey, current);
      }
      return current;
    };

    const syncTerminalIdFields = (root) => {
      const scope = root || document;
      const terminalId = getTerminalId();
      document.body.dataset.terminalId = terminalId;
      scope.querySelectorAll(".terminal-id-field").forEach((input) => {
        if (input instanceof HTMLInputElement && input.value !== terminalId) {
          input.value = terminalId;
        }
      });
      return terminalId;
    };

    let terminalHeaderBound = false;
    const bindHtmxTerminalHeader = () => {
      if (terminalHeaderBound || !window.htmx) return;
      terminalHeaderBound = true;
      document.body.addEventListener("htmx:configRequest", (event) => {
        if (!event || !event.detail || !event.detail.headers) return;
        event.detail.headers["X-Terminal-Id"] = getTerminalId();
      });
    };

    const getProductGrid = () => document.getElementById("productGrid");

    const getProductCards = () => {
      const grid = getProductGrid();
      if (!grid) return [];
      return Array.from(grid.querySelectorAll("[data-product-card='true']"));
    };

    const setProductCounts = (visible, total) => {
      const visibleEl = document.getElementById("productVisibleCount");
      const totalEl = document.getElementById("productTotalCount");
      if (visibleEl) visibleEl.textContent = String(visible);
      if (totalEl) totalEl.textContent = String(total);
      const emptyEl = document.getElementById("productFilterEmpty");
      if (emptyEl) {
        const shouldShow = total > 0 && visible === 0;
        emptyEl.classList.toggle("hidden", !shouldShow);
      }
    };

    const parseCardNumber = (value) => {
      const num = Number.parseFloat(value || "0");
      return Number.isFinite(num) ? num : 0;
    };

    const compareCards = (a, b, mode) => {
      const orderA = Number.parseInt(a.dataset.order || "0", 10);
      const orderB = Number.parseInt(b.dataset.order || "0", 10);
      const nameA = (a.dataset.name || "").toLowerCase();
      const nameB = (b.dataset.name || "").toLowerCase();
      const priceA = parseCardNumber(a.dataset.price);
      const priceB = parseCardNumber(b.dataset.price);
      const stockA = parseCardNumber(a.dataset.stock);
      const stockB = parseCardNumber(b.dataset.stock);
      if (mode === "server") return orderA - orderB;
      if (mode === "name-asc") return nameA.localeCompare(nameB);
      if (mode === "price-asc") return priceA - priceB;
      if (mode === "price-desc") return priceB - priceA;
      if (mode === "stock-desc") return stockB - stockA;
      return orderA - orderB;
    };

    const syncDensityButtons = (mode) => {
      document.querySelectorAll(".density-toggle").forEach((btn) => {
        const active = btn.getAttribute("data-density") === mode;
        btn.classList.toggle("bg-slate-900", active);
        btn.classList.toggle("text-white", active);
        btn.classList.toggle("hover:bg-slate-800", active);
        btn.classList.toggle("text-slate-600", !active);
      });
    };

    const syncStockFilterButtons = (mode) => {
      document.querySelectorAll(".stock-filter").forEach((btn) => {
        const active = btn.getAttribute("data-stock-filter") === mode;
        btn.classList.toggle("bg-slate-900", active);
        btn.classList.toggle("border-slate-900", active);
        btn.classList.toggle("text-white", active);
        btn.classList.toggle("text-slate-600", !active);
      });
    };

    const shouldShowCard = (card, stockFilter) => {
      const stock = parseCardNumber(card.dataset.stock);
      const low = card.dataset.lowStock === "true";
      const out = card.dataset.outOfStock === "true" || stock <= 0;
      if (stockFilter === "in-stock") return stock > 0;
      if (stockFilter === "low-stock") return stock > 0 && low;
      if (stockFilter === "out-of-stock") return out;
      return true;
    };

    const applyProductListingState = () => {
      const grid = getProductGrid();
      if (!grid) {
        setProductCounts(0, 0);
        return;
      }
      const cards = getProductCards();
      const sort = readStorage(productSortKey, "server");
      const stockFilter = readStorage(productStockFilterKey, "all");
      const density = readStorage(productDensityKey, "comfortable");

      const sortSelect = document.getElementById("productSort");
      if (sortSelect && sortSelect.value !== sort) {
        sortSelect.value = sort;
      }

      const sorted = [...cards].sort((a, b) => compareCards(a, b, sort));
      sorted.forEach((card) => grid.appendChild(card));

      let visible = 0;
      cards.forEach((card) => {
        const show = shouldShowCard(card, stockFilter);
        card.classList.toggle("hidden", !show);
        if (show) visible += 1;
      });

      grid.setAttribute("data-density", density);
      syncDensityButtons(density);
      syncStockFilterButtons(stockFilter);
      setProductCounts(visible, cards.length);
    };

    const updateQuickTotals = () => {
      const panel = getCartPanel();
      const subtotalEl = document.getElementById("qtSubtotal");
      const discountEl = document.getElementById("qtDiscount");
      const taxEl = document.getElementById("qtTax");
      const totalEl = document.getElementById("qtTotal");
      if (!subtotalEl || !discountEl || !taxEl || !totalEl) return;
      if (!panel) {
        subtotalEl.textContent = "-";
        discountEl.textContent = "-";
        taxEl.textContent = "-";
        totalEl.textContent = "-";
        return;
      }
      const subtotal = Number.parseFloat(panel.dataset.subtotal || "0");
      const discount = Number.parseFloat(panel.dataset.discount || "0");
      const tax = Number.parseFloat(panel.dataset.tax || "0");
      const total = Number.parseFloat(panel.dataset.total || "0");
      subtotalEl.textContent = formatMoney(subtotal);
      discountEl.textContent = formatMoney(discount);
      taxEl.textContent = formatMoney(tax);
      totalEl.textContent = formatMoney(total);
    };

    let selectedCartId = null;

    const setSelectedCartItem = (id) => {
      selectedCartId = id || null;
      document.querySelectorAll("[data-cart-item]").forEach((el) => {
        const active = selectedCartId && el.dataset.productId === selectedCartId;
        el.setAttribute("aria-selected", active ? "true" : "false");
        el.classList.toggle("ring-2", active);
        el.classList.toggle("ring-slate-900/20", active);
        el.classList.toggle("border-slate-300", active);
      });
    };

    const restoreCartSelection = () => {
      if (!selectedCartId) return;
      const exists = document.querySelector(`[data-cart-item][data-product-id="${CSS.escape(selectedCartId)}"]`);
      if (!exists) {
        selectedCartId = null;
        return;
      }
      setSelectedCartItem(selectedCartId);
    };

    const getSelectedCartElement = () => {
      if (!selectedCartId) return null;
      return document.querySelector(`[data-cart-item][data-product-id="${CSS.escape(selectedCartId)}"]`);
    };

    const submitCartAction = (item, action) => {
      if (!item) return false;
      const form = item.querySelector(`form[data-cart-action="${action}"]`);
      if (!form) return false;
      if (typeof form.requestSubmit === "function") {
        form.requestSubmit();
      } else {
        form.submit();
      }
      return true;
    };

    const adjustSelectedQty = (direction) => {
      const item = getSelectedCartElement();
      if (!item) return;
      if (direction > 0) submitCartAction(item, "increase");
      if (direction < 0) submitCartAction(item, "decrease");
    };

    const removeSelectedCartItem = () => {
      const item = getSelectedCartElement();
      if (!item) return;
      submitCartAction(item, "remove");
    };

    const getSelectedCurrency = () => {
      const panel = getCartPanel();
      if (!panel) return null;
      const select = panel.querySelector("#cashCurrency");
      if (!select) return null;
      const option = select.selectedOptions && select.selectedOptions[0];
      const rate = option ? Number.parseFloat(option.getAttribute("data-rate") || "0") : 0;
      const decimals = option ? Number.parseInt(option.getAttribute("data-decimals") || "2", 10) : 2;
      return {
        code: option ? option.value : "",
        symbol: option ? option.getAttribute("data-symbol") : "",
        rate: Number.isFinite(rate) ? rate : 0,
        decimals: Number.isFinite(decimals) ? decimals : 2
      };
    };

    const syncCashHidden = () => {
      const panel = getCartPanel();
      if (!panel) return;
      const currency = getSelectedCurrency();
      const input = panel.querySelector("#cashReceived");
      const codeInput = panel.querySelector("#cashCurrencyCode");
      const rateInput = panel.querySelector("#cashCurrencyRate");
      const foreignInput = panel.querySelector("#cashForeignAmount");
      if (!currency || !codeInput || !rateInput || !foreignInput) return;
      const received = Number.parseFloat(input?.value || "0");
      codeInput.value = currency.code || "";
      rateInput.value = currency.rate ? currency.rate.toString() : "";
      foreignInput.value = Number.isFinite(received) ? received.toString() : "";
    };

    const cashCurrencyKey = "pos.cash.currency";

    const applyStoredCurrency = () => {
      const panel = getCartPanel();
      if (!panel) return;
      const select = panel.querySelector("#cashCurrency");
      if (!select) return;
      const stored = localStorage.getItem(cashCurrencyKey);
      if (stored) {
        select.value = stored;
      }
    };

    const updateCashChange = () => {
      const panel = getCartPanel();
      if (!panel) return;
      const input = panel.querySelector("#cashReceived");
      const changeEl = panel.querySelector("#cashChange");
      const statusEl = panel.querySelector("#cashStatus");
      const totalForeignEl = panel.querySelector("#cashTotalForeign");
      const changeBaseEl = panel.querySelector("#cashChangeBase");
      const rateTextEl = panel.querySelector("#cashRateText");
      if (!input || !changeEl || !statusEl) return;
      const base = getBaseCurrency();
      const currency = getSelectedCurrency() || base;
      const rate = currency.rate && currency.rate > 0 ? currency.rate : 1;
      const totalBase = Number.parseFloat(panel.dataset.total || "0");
      const receivedForeign = Number.parseFloat(input.value || "0");
      if (!Number.isFinite(totalBase) || !Number.isFinite(receivedForeign)) return;
      const totalForeign = rate > 0 ? totalBase / rate : totalBase;
      const diffForeign = receivedForeign - totalForeign;
      const diffBase = diffForeign * rate;
      if (diffForeign >= 0) {
        statusEl.textContent = "Change";
        changeEl.textContent = formatCurrency(diffForeign, currency);
      } else {
        statusEl.textContent = "Remaining";
        changeEl.textContent = formatCurrency(Math.abs(diffForeign), currency);
      }
      if (input && currency && currency.code) {
        input.placeholder = `Cash received (${currency.code})`;
      }
      if (totalForeignEl) totalForeignEl.textContent = formatCurrency(totalForeign, currency);
      if (changeBaseEl) changeBaseEl.textContent = formatCurrency(Math.abs(diffBase), base);
      if (rateTextEl) {
        const rateText = Number.isFinite(rate)
          ? rate.toFixed(Math.max(4, base.decimals || 2))
          : "-";
        rateTextEl.textContent = `Rate: 1 ${currency.code || ''} = ${rateText} ${base.code || ''}`;
      }
      syncCashHidden();
    };

    const pinKey = "pos.pinned.v1";
    const maxPins = 12;
    const recentKey = "pos.recent.v1";
    const maxRecent = 10;

    const loadPins = () => {
      try {
        const raw = localStorage.getItem(pinKey);
        const list = raw ? JSON.parse(raw) : [];
        return Array.isArray(list) ? list : [];
      } catch {
        return [];
      }
    };

    const savePins = (pins) => {
      try {
        localStorage.setItem(pinKey, JSON.stringify(pins));
      } catch {
        // ignore storage failures
      }
    };

    const escapeHtml = (value) => {
      return String(value)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    };

    const getCsrfField = () => {
      const input = document.querySelector("#cartPanel input[name*='csrf']") || document.querySelector("input[name*='csrf']");
      if (!input) return null;
      const name = input.getAttribute("name");
      const value = input.value;
      if (!name || !value) return null;
      return { name, value };
    };

    const injectCsrfIntoForms = (root) => {
      if (!root) return;
      const csrf = getCsrfField();
      if (!csrf) return;
      root.querySelectorAll("form").forEach((form) => {
        const hasToken = Array.from(form.elements || []).some((el) => el.name === csrf.name);
        if (hasToken) return;
        const input = document.createElement("input");
        input.type = "hidden";
        input.name = csrf.name;
        input.value = csrf.value;
        form.prepend(input);
      });
    };

    const renderPins = () => {
      const section = document.getElementById("pinnedSection");
      const grid = document.getElementById("pinnedGrid");
      if (!section || !grid) return;
      const pins = loadPins();
      if (!pins.length) {
        section.classList.add("hidden");
        grid.innerHTML = "";
        return;
      }
      section.classList.remove("hidden");
      grid.innerHTML = pins.map((p) => {
        const name = escapeHtml(p.name || "Item");
        const sku = escapeHtml(p.sku || "");
        const price = formatMoney(p.price || 0);
        const image = p.image
          ? `<img src="${escapeHtml(p.image)}" alt="" class="h-full w-full object-contain object-center block">`
          : `<div class="h-full w-full grid place-items-center text-slate-400">
               <svg viewBox="0 0 24 24" class="h-8 w-8" fill="none" stroke="currentColor" stroke-width="1.5">
                 <path d="M3 7h3l2-2h8l2 2h3v12H3V7z"/>
                 <circle cx="12" cy="13" r="3.5"/>
               </svg>
             </div>`;
        return `
          <div class="group relative overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-sm">
            <div class="h-24 bg-slate-50 border-b border-slate-200 overflow-hidden flex items-center justify-center p-2">
              ${image}
            </div>
            <button type="button" data-unpin-id="${escapeHtml(p.id)}"
                    class="absolute right-2 top-2 rounded-full bg-white/90 border border-slate-200 p-1.5 text-slate-500 hover:text-slate-900 hover:bg-white transition">
              <svg viewBox="0 0 24 24" class="h-3.5 w-3.5" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 6l12 12"/>
                <path d="M18 6l-12 12"/>
              </svg>
            </button>
            <div class="p-3">
              <div class="text-sm font-semibold text-slate-900 line-clamp-2">${name}</div>
              <div class="text-xs text-slate-500">${price}</div>
              <form action="/pos/cart/add/${escapeHtml(p.id)}" method="post"
                    hx-post="/pos/cart/add/${escapeHtml(p.id)}" hx-target="#cartPanel" hx-swap="outerHTML"
                    data-recent-item="true"
                    data-recent-id="${escapeHtml(p.id)}"
                    data-recent-name="${name}"
                    data-recent-sku="${sku}"
                    data-recent-price="${escapeHtml(p.price || 0)}"
                    data-recent-image="${escapeHtml(p.image || '')}"
                    class="mt-2">
                <button class="w-full rounded-xl bg-slate-900 text-white px-3 py-1.5 text-xs font-semibold hover:bg-slate-800 transition">
                  Add
                </button>
              </form>
            </div>
          </div>
        `;
      }).join("");
      injectCsrfIntoForms(grid);
      if (window.htmx) window.htmx.process(grid);
    };

    let clearingCart = false;

    const postCartForm = async (url, params, swap) => {
      const body = new URLSearchParams();
      Object.entries(params || {}).forEach(([key, value]) => {
        if (value !== null && value !== undefined) body.append(key, value.toString());
      });
      const csrf = getCsrfField();
      if (csrf) body.append(csrf.name, csrf.value);
      const response = await fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "HX-Request": "true",
          "X-Terminal-Id": getTerminalId()
        },
        body
      });
      if (!swap) return;
      const html = await response.text();
      const panel = getCartPanel();
      if (panel) {
        panel.outerHTML = html;
      }
      if (window.htmx) window.htmx.process(document.getElementById("cartPanel"));
      afterCartSwap();
    };

    const clearCart = async () => {
      if (clearingCart) return;
      const panel = getCartPanel();
      if (!panel) return;
      clearingCart = true;
      try {
        const ids = Array.from(panel.querySelectorAll("[data-cart-item]"))
          .map((el) => el.dataset.productId)
          .filter(Boolean);
        for (const id of ids) {
          await postCartForm("/pos/cart/update", { productId: id, qty: 0 }, false);
        }
        await postCartForm("/pos/cart/discount", { discountType: "AMOUNT", discountValue: "0", discountReason: "" }, false);
        await postCartForm("/pos/cart/tax", { taxRate: "0" }, false);
        await postCartForm("/pos/cart/customer/clear", {}, true);
        selectedCartId = null;
      } finally {
        clearingCart = false;
      }
    };

    const confirmClearCart = () => {
      const ok = window.confirm("Clear the cart? This will remove all items and reset discounts, tax, and customer.");
      if (ok) clearCart();
    };

    const afterCartSwap = () => {
      syncTerminalIdFields(document);
      applyProductListingState();
      applyStoredCurrency();
      renderPins();
      renderRecents();
      syncPinToggles();
      updateCashChange();
      updateQuickTotals();
      restoreCartSelection();
    };

    const loadRecents = () => {
      try {
        const raw = localStorage.getItem(recentKey);
        const list = raw ? JSON.parse(raw) : [];
        return Array.isArray(list) ? list : [];
      } catch {
        return [];
      }
    };

    const saveRecents = (items) => {
      try {
        localStorage.setItem(recentKey, JSON.stringify(items));
      } catch {
        // ignore storage failures
      }
    };

    const recentItemKey = (item) => {
      const sku = (item.sku || "").trim();
      if (sku) return `sku:${sku.toLowerCase()}`;
      return `id:${String(item.id || "")}`;
    };

    const addRecentItem = (item) => {
      if (!item || !item.id) return;
      const list = loadRecents();
      const key = recentItemKey(item);
      const filtered = list.filter((i) => recentItemKey(i) !== key);
      filtered.unshift(item);
      saveRecents(filtered.slice(0, maxRecent));
      renderRecents();
    };

    const renderRecents = () => {
      const section = document.getElementById("recentSection");
      const grid = document.getElementById("recentGrid");
      if (!section || !grid) return;
      const items = loadRecents();
      if (!items.length) {
        section.classList.add("hidden");
        grid.innerHTML = "";
        return;
      }
      section.classList.remove("hidden");
      grid.innerHTML = items.map((item) => {
        const name = escapeHtml(item.name || "Item");
        const sku = escapeHtml(item.sku || "");
        const price = formatMoney(item.price || 0);
        const image = item.image
          ? `<img src="${escapeHtml(item.image)}" alt="" class="h-full w-full object-contain object-center block">`
          : `<div class="h-full w-full grid place-items-center text-slate-400">
               <svg viewBox="0 0 24 24" class="h-8 w-8" fill="none" stroke="currentColor" stroke-width="1.5">
                 <path d="M3 7h3l2-2h8l2 2h3v12H3V7z"/>
                 <circle cx="12" cy="13" r="3.5"/>
               </svg>
             </div>`;
        return `
          <div class="group relative overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-sm">
            <div class="h-24 bg-slate-50 border-b border-slate-200 overflow-hidden flex items-center justify-center p-2">
              ${image}
            </div>
            <div class="p-3">
              <div class="text-sm font-semibold text-slate-900 line-clamp-2">${name}</div>
              <div class="text-xs text-slate-500">${price}</div>
              <form action="/pos/cart/add/${escapeHtml(item.id)}" method="post"
                    hx-post="/pos/cart/add/${escapeHtml(item.id)}" hx-target="#cartPanel" hx-swap="outerHTML"
                    data-recent-item="true"
                    data-recent-id="${escapeHtml(item.id)}"
                    data-recent-name="${name}"
                    data-recent-sku="${sku}"
                    data-recent-price="${escapeHtml(item.price || 0)}"
                    data-recent-image="${escapeHtml(item.image || '')}"
                    class="mt-2">
                <button class="w-full rounded-xl border border-slate-200 bg-white px-3 py-1.5 text-xs font-semibold text-slate-700 hover:bg-slate-50 transition">
                  Add
                </button>
              </form>
            </div>
          </div>
        `;
      }).join("");
      injectCsrfIntoForms(grid);
      if (window.htmx) window.htmx.process(grid);
    };

    const syncPinToggles = () => {
      const pins = loadPins();
      const pinned = new Set(pins.map((p) => String(p.id)));
      document.querySelectorAll(".pin-toggle").forEach((el) => {
        const id = String(el.dataset.productId || "");
        const active = pinned.has(id);
        el.setAttribute("aria-pressed", active ? "true" : "false");
        el.classList.toggle("bg-slate-900", active);
        el.classList.toggle("border-slate-900", active);
        el.classList.toggle("text-white", active);
        el.classList.toggle("bg-white/90", !active);
        el.classList.toggle("border-slate-200", !active);
        el.classList.toggle("text-slate-700", !active);
      });
    };

    const togglePin = (el) => {
      const data = {
        id: String(el.dataset.productId || ""),
        name: el.dataset.productName || "Item",
        sku: el.dataset.productSku || "",
        price: el.dataset.productPrice || "0",
        image: el.dataset.productImage || ""
      };
      if (!data.id) return;
      const pins = loadPins();
      const idx = pins.findIndex((p) => String(p.id) === data.id);
      if (idx >= 0) {
        pins.splice(idx, 1);
      } else {
        pins.unshift(data);
      }
      const trimmed = pins.slice(0, maxPins);
      savePins(trimmed);
      renderPins();
      syncPinToggles();
    };

    document.addEventListener("click", (e) => {
      const pin = e.target.closest(".pin-toggle");
      if (pin) {
        e.preventDefault();
        e.stopPropagation();
        togglePin(pin);
        return;
      }

      const productCard = e.target.closest("form[data-product-card='true']");
      if (productCard && !e.target.closest("button, input, select, textarea, a")) {
        e.preventDefault();
        if (typeof productCard.requestSubmit === "function") {
          productCard.requestSubmit();
        } else {
          productCard.submit();
        }
        return;
      }

      const unpin = e.target.closest("[data-unpin-id]");
      if (unpin) {
        e.preventDefault();
        const id = String(unpin.getAttribute("data-unpin-id"));
        const pins = loadPins().filter((p) => String(p.id) !== id);
        savePins(pins);
        renderPins();
        syncPinToggles();
        return;
      }

      const clearPins = e.target.closest("[data-action='clear-pins']");
      if (clearPins) {
        e.preventDefault();
        savePins([]);
        renderPins();
        syncPinToggles();
        return;
      }

      const clearRecents = e.target.closest("[data-action='clear-recents']");
      if (clearRecents) {
        e.preventDefault();
        saveRecents([]);
        renderRecents();
        return;
      }

      const clearCartBtn = e.target.closest("[data-action='clear-cart']");
      if (clearCartBtn) {
        e.preventDefault();
        confirmClearCart();
        return;
      }

      const stockFilterBtn = e.target.closest("[data-stock-filter]");
      if (stockFilterBtn) {
        e.preventDefault();
        const filter = stockFilterBtn.getAttribute("data-stock-filter") || "all";
        writeStorage(productStockFilterKey, filter);
        applyProductListingState();
        return;
      }

      const densityBtn = e.target.closest("[data-density]");
      if (densityBtn) {
        e.preventDefault();
        const density = densityBtn.getAttribute("data-density") || "comfortable";
        writeStorage(productDensityKey, density);
        applyProductListingState();
        return;
      }

      const discountBtn = e.target.closest(".discount-quick");
      if (discountBtn) {
        e.preventDefault();
        const panel = getCartPanel();
        if (!panel) return;
        const pct = Number.parseFloat(discountBtn.getAttribute("data-discount-pct") || "0");
        const typeSelect = panel.querySelector("select[name='discountType']");
        const input = panel.querySelector("input[name='discountValue']");
        if (!input) return;
        if (typeSelect) typeSelect.value = "PERCENT";
        input.value = Number.isFinite(pct) ? pct.toFixed(2) : "0.00";
        if (input.form) input.form.requestSubmit();
        return;
      }

      const cashBtn = e.target.closest(".cash-quick");
      if (cashBtn) {
        e.preventDefault();
        const panel = getCartPanel();
        if (!panel) return;
        const input = panel.querySelector("#cashReceived");
        if (!input) return;
        const total = Number.parseFloat(panel.dataset.total || "0");
        if (!Number.isFinite(total)) return;
        const currency = getSelectedCurrency() || getBaseCurrency();
        const rate = currency.rate && currency.rate > 0 ? currency.rate : 1;
        const add = Number.parseFloat(cashBtn.getAttribute("data-cash-add") || "0");
        const exact = cashBtn.getAttribute("data-cash-mode") === "exact";
        const valueBase = exact ? total : total + add;
        const valueForeign = rate > 0 ? valueBase / rate : valueBase;
        input.value = valueForeign.toFixed(currency.decimals || 2);
        updateCashChange();
      }

      const cartItem = e.target.closest("[data-cart-item]");
      if (cartItem && !e.target.closest("button, input, select, textarea, a, form")) {
        setSelectedCartItem(cartItem.dataset.productId || null);
      }
    });

    document.addEventListener("submit", (e) => {
      const form = e.target;
      if (!(form instanceof HTMLFormElement)) return;
      if (form.matches("[data-quick-add]")) {
        const input = form.querySelector("input[name='q']");
        const source = document.getElementById("searchBox");
        if (input && source) input.value = source.value;
      }
      if (form.matches("[data-recent-item]")) {
        const item = {
          id: form.dataset.recentId,
          name: form.dataset.recentName,
          sku: form.dataset.recentSku,
          price: form.dataset.recentPrice,
          image: form.dataset.recentImage
        };
        addRecentItem(item);
      }
    }, true);

    document.addEventListener("input", (e) => {
      if (e.target && e.target.id === "cashReceived") {
        updateCashChange();
      }
    });

    document.addEventListener("change", (e) => {
      if (e.target && e.target.id === "cashCurrency") {
        try {
          localStorage.setItem(cashCurrencyKey, e.target.value || "");
        } catch {
          // ignore storage errors
        }
        const panel = getCartPanel();
        const input = panel ? panel.querySelector("#cashReceived") : null;
        if (input) {
          const code = e.target.value || "";
          input.placeholder = code ? `Cash received (${code})` : "Cash received";
        }
        updateCashChange();
        return;
      }
      if (e.target && e.target.id === "productSort") {
        const sort = e.target.value || "server";
        writeStorage(productSortKey, sort);
        applyProductListingState();
      }
    });

    document.addEventListener("htmx:afterSwap", (e) => {
      if (!e.target) return;
      if (["productGridWrap", "cartPanel", "cartContainer"].includes(e.target.id)) {
        afterCartSwap();
      }
    });

    document.addEventListener("DOMContentLoaded", () => {
      bindHtmxTerminalHeader();
      afterCartSwap();
    });

    // Fallback: if HTMX didn't load (offline/CDN blocked), do minimal AJAX swaps.
    (function () {
      if (window.htmx) return;

      const toQueryString = (formData) => {
        const params = new URLSearchParams();
        for (const [key, value] of formData.entries()) {
          if (value !== null && value !== undefined) params.append(key, value.toString());
        }
        return params.toString();
      };

      const resolveTarget = (el) => {
        const selector = el.getAttribute("hx-target");
        if (!selector) return null;
        return document.querySelector(selector);
      };

      const performSwap = (target, html, swap) => {
        if (!target) return;
        if (swap === "outerHTML") {
          target.outerHTML = html;
        } else {
          target.innerHTML = html;
        }
      };

      const afterRequest = (el) => {
        const hxOn = el.getAttribute("hx-on");
        if (hxOn && hxOn.includes("afterRequest") && typeof el.reset === "function") {
          el.reset();
        }
      };

      const ajaxRequest = async (options) => {
        const { url, method, body, triggerEl, target, swap, pushUrl } = options;
        const headers = { "HX-Request": "true", "X-Terminal-Id": getTerminalId() };
        if (target && target.id) headers["HX-Target"] = target.id;

        const response = await fetch(url, { method, body, headers });
        const html = await response.text();
        performSwap(target, html, swap);
        afterCartSwap();
        if (pushUrl) history.pushState({}, "", url);
        if (triggerEl) afterRequest(triggerEl);
      };

      const submitForm = async (form, triggerEl) => {
        const method = (form.getAttribute("hx-post") ? "POST" : "GET").toUpperCase();
        const urlAttr = form.getAttribute("hx-post") || form.getAttribute("hx-get") || form.action;
        const swap = form.getAttribute("hx-swap") || "innerHTML";
        const pushUrl = form.getAttribute("hx-push-url") === "true";
        const target = resolveTarget(form);
        const formData = new FormData(form);

        if (method === "GET") {
          const qs = toQueryString(formData);
          const url = qs ? `${urlAttr}?${qs}` : urlAttr;
          return ajaxRequest({ url, method, triggerEl: form, target, swap, pushUrl });
        }

        return ajaxRequest({ url: urlAttr, method, body: formData, triggerEl: form, target, swap, pushUrl });
      };

      document.addEventListener("submit", (e) => {
        if (window.htmx) return;
        const form = e.target;
        if (!(form instanceof HTMLFormElement)) return;
        if (!form.hasAttribute("hx-post") && !form.hasAttribute("hx-get")) return;
        e.preventDefault();
        submitForm(form, form).catch(() => form.submit());
      });

      document.addEventListener("change", (e) => {
        if (window.htmx) return;
        const form = e.target && e.target.closest("form");
        if (!form) return;
        const trigger = form.getAttribute("hx-trigger");
        if (!trigger || !trigger.includes("change")) return;
        if (trigger.includes("from:#categorySelect") && !e.target.matches("#categorySelect")) return;
        submitForm(form, form).catch(() => form.submit());
      });

      document.addEventListener("click", (e) => {
        if (window.htmx) return;
        const link = e.target.closest("a[hx-get]");
        if (!link) return;
        e.preventDefault();
        const url = link.getAttribute("hx-get") || link.getAttribute("href");
        const target = resolveTarget(link);
        const swap = link.getAttribute("hx-swap") || "innerHTML";
        const pushUrl = link.getAttribute("hx-push-url") === "true";
        ajaxRequest({ url, method: "GET", target, swap, pushUrl, triggerEl: link })
          .catch(() => { window.location.href = url; });
      });
    })();
  </script>
</body>
</html>
